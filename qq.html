<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>QQ</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Segoe UI', Roboto, Arial,
          sans-serif;
        background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .iphone-frame {
        width: 390px;
        height: 844px;
        border-radius: 54px;
        background: linear-gradient(180deg, #0f1724 0%, #0b1220 60%);
        border: none;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.02), inset 0 -6px 20px rgba(0, 0, 0, 0.6),
          0 8px 30px rgba(2, 6, 23, 0.55);
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .screen {
        width: 370px;
        height: 804px;
        border-radius: 44px;
        background: #f7f7f7;
        position: relative;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      /* çµåŠ¨å²› */
      .dynamic-island {
        position: absolute;
        top: 18px;
        left: 50%;
        transform: translateX(-50%);
        width: 120px;
        height: 36px;
        background: #0b0b0b;
        border-radius: 18px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
        z-index: 10;
      }
      /* çŠ¶æ€æ  */
      .status-bar {
        position: absolute;
        top: 6px;
        left: 0;
        width: 100%;
        height: 48px;
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        padding: 6px 18px;
        color: #000;
        font-size: 15px;
        font-weight: 600;
        pointer-events: none;
        z-index: 5;
      }
      .status-left {
        font-weight: 600;
      }
      .status-right {
        display: flex;
        gap: 8px;
        align-items: center;
        color: #00d4aa;
      }
      /* å¯¼èˆªæ  */
      .navbar {
        margin-top: 54px;
        height: 60px;
        background: #f7f7f7;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        border-bottom: 1px solid #e8e8e8;
      }
      .nav-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .back-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: none;
        color: #1890ff;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .nav-title {
        font-size: 18px;
        font-weight: 600;
        color: #000;
      }
      .nav-right {
        display: flex;
        gap: 16px;
        align-items: center;
      }
      .nav-icon {
        width: 28px;
        height: 28px;
        border: none;
        background: none;
        color: #1890ff;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      /* ä¸»å†…å®¹åŒº */
      .content {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 0;
        color: #999;
        overflow: hidden;
      }
      .empty-message {
        font-size: 16px;
        text-align: center;
        line-height: 1.5;
        max-width: 280px;
        margin: auto;
        padding: 40px 20px;
      }
      /* åº•éƒ¨æŒ‰é’® */
      .bottom-section {
        padding: 20px;
        background: #f7f7f7;
        border-top: 1px solid #e8e8e8;
      }
      .moments-btn {
        width: 100%;
        height: 50px;
        background: #fff;
        border: 1px solid #e8e8e8;
        border-radius: 8px;
        color: #000;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 150ms ease;
      }
      .moments-btn:hover {
        background: #f5f5f5;
      }
      .moments-btn:active {
        transform: scale(0.98);
      }
      /* èŠå¤©åˆ—è¡¨é¡¹ */
      .chat-list {
        flex: 1;
        overflow-y: auto;
        background: #f7f7f7;
      }
      .chat-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        background: #fff;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: all 150ms ease;
        position: relative;
        min-height: 76px;
      }
      .chat-item:hover {
        background: #f8f9fa;
      }
      .chat-item:active {
        background: #e9ecef;
      }

      /* é•¿æŒ‰åˆ é™¤ç›¸å…³æ ·å¼ */
      .chat-item.long-pressing {
        transform: scale(0.98);
        background: #f0f0f0;
      }

      .delete-btn {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 60px;
        height: 30px;
        background: #ff3b30;
        color: white;
        border: none;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
        display: none;
        cursor: pointer;
        z-index: 10;
      }

      .chat-item.show-delete .delete-btn {
        display: block;
      }

      .chat-item.show-delete .chat-meta {
        opacity: 0;
        pointer-events: none;
      }
      .chat-avatar {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        margin-right: 12px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: white;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
      }
      .chat-avatar::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0) 50%);
        border-radius: 8px;
      }
      .chat-info {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
        overflow: hidden;
      }
      .chat-name {
        font-size: 16px;
        font-weight: 600;
        color: #1a1a1a;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 100%;
      }
      .chat-preview {
        font-size: 14px;
        color: #8e8e93;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        line-height: 1.2;
        max-width: 100%;
      }
      .chat-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
        margin-left: 8px;
        flex-shrink: 0;
        min-width: 60px;
        max-width: 80px;
      }
      .chat-time {
        font-size: 12px;
        color: #8e8e93;
        font-weight: 500;
        white-space: nowrap;
      }
      .chat-badge {
        min-width: 18px;
        height: 18px;
        background: #ff3b30;
        color: white;
        border-radius: 9px;
        font-size: 11px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 5px;
        box-shadow: 0 1px 3px rgba(255, 59, 48, 0.3);
      }
      /* åœ¨çº¿çŠ¶æ€æŒ‡ç¤ºå™¨ */
      .online-indicator {
        position: absolute;
        bottom: 1px;
        right: 1px;
        width: 12px;
        height: 12px;
        background: #34c759;
        border: 2px solid #fff;
        border-radius: 50%;
        box-shadow: 0 0 3px rgba(0, 0, 0, 0.2);
      }

      /* è‡ªå®šä¹‰å¼¹çª— */
      .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        border-radius: 44px;
        overflow: hidden;
      }

      .modal {
        background: #fff;
        border-radius: 16px;
        padding: 24px;
        margin: 20px;
        max-width: 280px;
        width: 100%;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        animation: modalShow 0.3s ease-out;
      }

      @keyframes modalShow {
        from {
          opacity: 0;
          transform: scale(0.9) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #1a1a1a;
        text-align: center;
        margin-bottom: 20px;
      }

      .modal-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        color: #333;
        margin-bottom: 20px;
        outline: none;
        transition: border-color 0.2s ease;
      }

      .modal-input:focus {
        border-color: #1890ff;
      }

      .modal-buttons {
        display: flex;
        gap: 12px;
      }

      .modal-btn {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .modal-btn-cancel {
        background: #f5f5f5;
        color: #666;
      }

      .modal-btn-cancel:hover {
        background: #e8e8e8;
      }

      .modal-btn-confirm {
        background: #1890ff;
        color: white;
      }

      .modal-btn-confirm:hover {
        background: #0c7cd5;
      }
    </style>
  </head>
  <body>
    <div class="iphone-frame">
      <div class="screen">
        <div class="dynamic-island"></div>
        <div class="status-bar">
          <div class="status-left" id="currentTime">9:41</div>
          <div class="status-right">
            <span style="color: #00d4aa">100%ğŸ”‹</span>
          </div>
        </div>

        <div class="navbar">
          <div class="nav-left">
            <button class="back-btn" onclick="goToIndex()">â€¹</button>
            <h1 class="nav-title">æ¶ˆæ¯</h1>
          </div>
          <div class="nav-right">
            <button class="nav-icon" onclick="showGroupDialog()">ğŸ‘¥</button>
            <button class="nav-icon" onclick="showAddDialog()">âœš</button>
          </div>
        </div>

        <div class="content">
          <div class="chat-list" id="chatList">
            <!-- èŠå¤©åˆ—è¡¨ä¼šåŠ¨æ€å¡«å……åˆ°è¿™é‡Œ -->
          </div>
          <div class="empty-message" id="emptyMessage" style="display: none">ç‚¹å‡»å³ä¸Šè§’"+"æˆ–ç¾¤ç»„å›¾æ ‡æ·»åŠ èŠå¤©</div>
        </div>

        <div class="bottom-section">
          <button class="moments-btn" onclick="openMoments()">æœ‹å‹åœˆ</button>
        </div>

        <!-- è‡ªå®šä¹‰å¼¹çª— -->
        <div class="modal-overlay" id="modalOverlay">
          <div class="modal">
            <div class="modal-title">åˆ›å»ºæ–°èŠå¤©</div>
            <input type="text" class="modal-input" id="modalInput" placeholder="è¯·è¾“å…¥Taçš„åå­—" maxlength="20" />
            <div class="modal-buttons">
              <button class="modal-btn modal-btn-cancel" onclick="hideModal()">å–æ¶ˆ</button>
              <button class="modal-btn modal-btn-confirm" onclick="confirmAddFriend()">ç¡®å®š</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // æ¨¡æ‹ŸèŠå¤©æ•°æ®
      let chatData = [
        {
          id: 'ai_assistant',
          name: 'AIåŠ©æ‰‹',
          lastMessage: 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ',
          time: 'åˆšåˆš',
          unread: 0,
          avatarColor: '#667eea',
          online: true,
          avatar: 'AI',
        },
        {
          id: 'test1',
          name: 'æµ‹è¯•',
          lastMessage: 'ä½ å¥½ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ï¼',
          time: 'åˆšåˆš',
          unread: 1,
          avatarColor: '#f093fb',
          online: true,
          avatar: 'æµ‹',
        },
      ];

      // åˆå§‹åŒ–é¡µé¢
      function initPage() {
        console.log('=== QQé¡µé¢åˆå§‹åŒ–å¼€å§‹ ===');
        loadChatData(); // å…ˆåŠ è½½èŠå¤©æ•°æ®
        console.log('=== èŠå¤©æ•°æ®åŠ è½½å®Œæˆ ===');
        loadUserSettings(); // ç„¶ååŠ è½½ç”¨æˆ·è®¾ç½®æ¥æ›´æ–°AIåŠ©æ‰‹ä¿¡æ¯
        console.log('=== ç”¨æˆ·è®¾ç½®åŠ è½½å®Œæˆ ===');
        saveChatData(); // ä¿å­˜æ›´æ–°åçš„æ•°æ®
        console.log('=== èŠå¤©æ•°æ®ä¿å­˜å®Œæˆ ===');
        updateChatList();
        console.log('=== èŠå¤©åˆ—è¡¨æ›´æ–°å®Œæˆ ===');
      }

      // åŠ è½½ç”¨æˆ·è®¾ç½®å¹¶æ›´æ–°æ‰€æœ‰èŠå¤©ä¿¡æ¯
      function loadUserSettings() {
        console.log('=== å¼€å§‹åŠ è½½ç”¨æˆ·è®¾ç½® ===');

        // ä¸ºæ¯ä¸ªèŠå¤©åŠ è½½å¯¹åº”çš„è®¾ç½®
        chatData.forEach(chat => {
          // å°è¯•åŠ è½½è¯¥èŠå¤©çš„ä¸“ç”¨è®¾ç½®
          let saved = localStorage.getItem(`chatSettings_${chat.id}`);
          console.log(`ä¸ºèŠå¤©${chat.name}(ID:${chat.id})å°è¯•åŠ è½½è®¾ç½®ï¼Œç»“æœ:`, saved ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');

          // å¦‚æœæ²¡æœ‰ä¸“ç”¨è®¾ç½®ï¼Œä¸”æ˜¯AIåŠ©æ‰‹ï¼Œå°è¯•åŠ è½½é€šç”¨è®¾ç½®
          if (!saved && chat.id === 'ai_assistant') {
            saved = localStorage.getItem('chatSettings');
            console.log('QQé¡µé¢ï¼šæ²¡æœ‰AIåŠ©æ‰‹ä¸“ç”¨è®¾ç½®ï¼Œä½¿ç”¨é€šç”¨è®¾ç½®');
          }

          if (saved) {
            try {
              const settings = JSON.parse(saved);
              console.log(`QQé¡µé¢åŠ è½½${chat.name}çš„è®¾ç½®:`, settings);

              // æ£€æŸ¥èŠå¤©ç±»å‹ï¼Œå¦‚æœæ˜¯AIèŠå¤©æˆ–è€…è®¾ç½®ä¸­æœ‰aiNameï¼Œåˆ™æ›´æ–°
              if (chat.id === 'ai_assistant' || settings.aiName) {
                // æ›´æ–°AIåŠ©æ‰‹ä¿¡æ¯
                const oldName = chat.name;
                const oldAvatar = chat.avatar;

                // ä½¿ç”¨è®¾ç½®ä¸­çš„AIåç§°æ›´æ–°èŠå¤©åç§°
                chat.name = settings.aiName || (chat.id === 'ai_assistant' ? 'AIåŠ©æ‰‹' : chat.name);
                if (settings.aiAvatarFile) {
                  chat.avatar = settings.aiAvatarFile;
                  chat.avatarType = 'image';
                } else {
                  chat.avatar = settings.aiName ? settings.aiName.charAt(0) : chat.avatar || chat.name.charAt(0);
                  chat.avatarType = 'text';
                }

                console.log(`${chat.id}æ›´æ–°ç»“æœ - åç§°: ${oldName} -> ${chat.name}`);
                console.log(`${chat.id}æ›´æ–°ç»“æœ - å¤´åƒ: ${oldAvatar} -> ${chat.avatar}`);
              } else {
                // æ›´æ–°å…¶ä»–å¥½å‹ä¿¡æ¯ï¼ˆå¦‚æœè®¾ç½®ä¸­æœ‰è‡ªå®šä¹‰åç§°ï¼‰
                if (settings.userName) {
                  console.log(`æ›´æ–°å¥½å‹${chat.name}çš„ç”¨æˆ·åç§°ä¸º:`, settings.userName);
                  // æ³¨æ„ï¼šè¿™é‡Œä¸ç›´æ¥ä¿®æ”¹å¥½å‹åç§°ï¼Œå› ä¸ºå¥½å‹åç§°æ˜¯ç”¨æˆ·è¾“å…¥çš„
                  // ä½†å¯ä»¥æ›´æ–°å¤´åƒç­‰å…¶ä»–ä¿¡æ¯
                }
              }
            } catch (e) {
              console.error(`è§£æ${chat.name}çš„è®¾ç½®å¤±è´¥:`, e);
            }
          }
        });

        console.log('å·²åŠ è½½æ‰€æœ‰èŠå¤©çš„ç”¨æˆ·è®¾ç½®');
      }

      // åŠ è½½èŠå¤©æ•°æ®
      function loadChatData() {
        try {
          const saved = localStorage.getItem('qqChatData');
          if (saved) {
            chatData = JSON.parse(saved);
            // é˜²æ­¢æ•°æ®å¼‚å¸¸
            if (!Array.isArray(chatData)) chatData = [];
          } else {
            // å¦‚æœæ²¡æœ‰ä¿å­˜çš„æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®å¹¶ä¿å­˜
            saveChatData();
          }
        } catch (e) {
          console.error('åŠ è½½èŠå¤©æ•°æ®å‡ºé”™:', e);
          chatData = [];
          saveChatData();
        }
      }

      // ä¿å­˜èŠå¤©æ•°æ®
      function saveChatData() {
        try {
          localStorage.setItem('qqChatData', JSON.stringify(chatData));
        } catch (e) {
          console.error('ä¿å­˜èŠå¤©æ•°æ®å‡ºé”™:', e);
        }
      }

      // æ›´æ–°èŠå¤©åˆ—è¡¨
      function updateChatList() {
        const chatList = document.getElementById('chatList');
        const emptyMessage = document.getElementById('emptyMessage');

        if (chatData.length === 0) {
          chatList.style.display = 'none';
          emptyMessage.style.display = 'block';
        } else {
          chatList.style.display = 'block';
          emptyMessage.style.display = 'none';

          // åˆ›å»ºèŠå¤©åˆ—è¡¨HTML
          let html = '';
          chatData.forEach(chat => {
            const onlineIndicator = chat.online ? '<div class="online-indicator"></div>' : '';
            const unreadBadge =
              chat.unread > 0 ? `<div class="chat-badge">${chat.unread > 99 ? '99+' : chat.unread}</div>` : '';

            // å¤„ç†å¤´åƒæ˜¾ç¤º
            let avatarContent;
            if (chat.avatarType === 'image' && chat.avatar) {
              avatarContent = `<img src="${chat.avatar}" alt="${chat.name}å¤´åƒ" style="width: 100%; height: 100%; object-fit: cover; border-radius: inherit;" />`;
            } else {
              avatarContent = chat.avatar || chat.name.charAt(0);
            }

            html += `
              <div class="chat-item" oncontextmenu="showDeleteButton('${chat.id}', event)" onclick="openChat('${chat.id}')" ontouchstart="handleTouchStart('${chat.id}', event)" ontouchend="handleTouchEnd('${chat.id}', event)">
                <div class="chat-avatar" style="background: ${chat.avatarColor};">
                  ${avatarContent}
                  ${onlineIndicator}
                </div>
                <div class="chat-info">
                  <div class="chat-name">${chat.name}</div>
                  <div class="chat-preview">${chat.lastMessage}</div>
                </div>
                <div class="chat-meta">
                  <div class="chat-time">${chat.time}</div>
                  ${unreadBadge}
                </div>
                <button class="delete-btn" onclick="deleteFriend('${chat.id}', event)">åˆ é™¤</button>
              </div>
            `;
          });

          chatList.innerHTML = html;
        }
      }

      // æ˜¾ç¤ºç¾¤ç»„å¯¹è¯æ¡†
      function showGroupDialog() {
        showCustomAlert('ç¾¤ç»„åŠŸèƒ½', 'è¿™é‡Œå¯ä»¥åˆ›å»ºç¾¤èŠæˆ–åŠ å…¥ç¾¤ç»„');
      }

      // è¿”å›åˆ°ä¸»é¡µ
      function goToIndex() {
        window.location.href = './index.html';
      }

      // æ˜¾ç¤ºæ·»åŠ å¯¹è¯æ¡†
      function showAddDialog() {
        showModal();
      }

      // æ˜¾ç¤ºè‡ªå®šä¹‰å¼¹çª—
      function showModal() {
        const modal = document.getElementById('modalOverlay');
        const input = document.getElementById('modalInput');
        modal.style.display = 'flex';
        input.value = '';
        input.focus();
      }

      // éšè—å¼¹çª—
      function hideModal() {
        const modal = document.getElementById('modalOverlay');
        modal.style.display = 'none';
      }

      // ç¡®è®¤æ·»åŠ å¥½å‹
      function confirmAddFriend() {
        const input = document.getElementById('modalInput');
        const name = input.value.trim();

        if (name) {
          addChat(name);
          hideModal();
        } else {
          input.focus();
        }
      }

      // è‡ªå®šä¹‰æç¤ºæ¡†ï¼ˆæ›¿ä»£alertï¼‰
      function showCustomAlert(title, message) {
        // åˆ›å»ºä¸´æ—¶æç¤ºæ¡†
        const alertDiv = document.createElement('div');
        alertDiv.style.cssText = `
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 20px;
          border-radius: 12px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          z-index: 1001;
          max-width: 260px;
          text-align: center;
        `;
        alertDiv.innerHTML = `
          <h3 style="margin-bottom: 10px; font-size: 16px; color: #333;">${title}</h3>
          <p style="margin-bottom: 15px; color: #666; font-size: 14px;">${message}</p>
          <button onclick="this.parentElement.remove()" style="
            background: #1890ff; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 6px; 
            cursor: pointer;
          ">ç¡®å®š</button>
        `;
        document.querySelector('.screen').appendChild(alertDiv);
      }

      // æ·»åŠ æ–°èŠå¤©
      function addChat(name) {
        const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#a8edea', '#ff9a9e'];
        const messages = ['ä½ å¥½ï¼', 'åœ¨å—ï¼Ÿ', 'æœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ', 'æœ‰ç©ºèŠèŠå—ï¼Ÿ', 'åˆšåˆšæ·»åŠ äº†ä½ ', 'Hello!', 'å¾ˆé«˜å…´è®¤è¯†ä½ '];
        const newChat = {
          id: Date.now().toString(),
          name: name,
          lastMessage: messages[Math.floor(Math.random() * messages.length)],
          time: 'åˆšåˆš',
          unread: Math.random() > 0.6 ? Math.floor(Math.random() * 5) + 1 : 0,
          avatarColor: colors[Math.floor(Math.random() * colors.length)],
          online: Math.random() > 0.3,
          avatar: name.charAt(0),
        };
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåèŠå¤©ï¼Œé¿å…é‡å¤
        if (!chatData.some(c => c.name === name)) {
          chatData.unshift(newChat);
          saveChatData(); // ä¿å­˜åˆ°localStorage
          updateChatList();
          showToast('å¥½å‹ ' + name + ' æ·»åŠ æˆåŠŸï¼');
        } else {
          showToast('è¯¥å¥½å‹å·²å­˜åœ¨ï¼');
        }
      }

      // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
      function showToast(message) {
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          font-size: 14px;
          z-index: 10000;
          animation: toastShow 0.3s ease;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.remove();
        }, 2000);
      }

      // é•¿æŒ‰ç›¸å…³å˜é‡
      let touchTimer = null;
      let isLongPress = false;

      // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®ï¼ˆå³é”®æˆ–é•¿æŒ‰ï¼‰
      function showDeleteButton(chatId, event) {
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }

        // éšè—æ‰€æœ‰å…¶ä»–åˆ é™¤æŒ‰é’®
        document.querySelectorAll('.chat-item').forEach(item => {
          item.classList.remove('show-delete');
        });

        // æ˜¾ç¤ºå½“å‰é¡¹çš„åˆ é™¤æŒ‰é’®
        const chatItem = event.target.closest('.chat-item');
        if (chatItem) {
          chatItem.classList.add('show-delete');
        }

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—åˆ é™¤æŒ‰é’®
        setTimeout(() => {
          document.addEventListener('click', hideDeleteButtons, { once: true });
        }, 100);
      }

      // éšè—æ‰€æœ‰åˆ é™¤æŒ‰é’®
      function hideDeleteButtons() {
        document.querySelectorAll('.chat-item').forEach(item => {
          item.classList.remove('show-delete');
        });
      }

      // è§¦æ‘¸å¼€å§‹
      function handleTouchStart(chatId, event) {
        isLongPress = false;
        touchTimer = setTimeout(() => {
          isLongPress = true;
          showDeleteButton(chatId, event);
          // è§¦è§‰åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
          if (navigator.vibrate) {
            navigator.vibrate(50);
          }
        }, 500); // 500msé•¿æŒ‰
      }

      // è§¦æ‘¸ç»“æŸ
      function handleTouchEnd(chatId, event) {
        if (touchTimer) {
          clearTimeout(touchTimer);
        }

        // å¦‚æœæ˜¯é•¿æŒ‰ï¼Œé˜»æ­¢ç‚¹å‡»äº‹ä»¶
        if (isLongPress) {
          event.preventDefault();
          event.stopPropagation();
        }
      }

      // åˆ é™¤å¥½å‹
      function deleteFriend(chatId, event) {
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }

        const chat = chatData.find(c => c.id === chatId);
        if (!chat) return;

        if (confirm(`ç¡®å®šè¦åˆ é™¤å¥½å‹ "${chat.name}" å—ï¼Ÿ\nåˆ é™¤åèŠå¤©è®°å½•ä¹Ÿä¼šè¢«æ¸…é™¤ã€‚`)) {
          // ä»æ•°æ®ä¸­åˆ é™¤
          chatData = chatData.filter(c => c.id !== chatId);

          // åˆ é™¤å¯¹åº”çš„èŠå¤©è®°å½•
          localStorage.removeItem(`chatHistory_${chatId}`);

          // ä¿å­˜æ•°æ®å¹¶æ›´æ–°ç•Œé¢
          saveChatData();
          updateChatList();

          showToast(`å·²åˆ é™¤å¥½å‹ ${chat.name}`);
        }
      }

      // æ ¼å¼åŒ–æ—¶é—´ - ç®€åŒ–ç‰ˆæœ¬
      function formatTime(date) {
        return 'åˆšåˆš';
      }

      // æ‰“å¼€èŠå¤©
      function openChat(chatId) {
        const chat = chatData.find(function (c) {
          return c.id === chatId;
        });
        if (chat) {
          // æ¸…é™¤æœªè¯»æ¶ˆæ¯
          chat.unread = 0;
          // æ›´æ–°æœ€åæ¶ˆæ¯æ—¶é—´
          chat.time = 'åˆšåˆš';
          saveChatData(); // ä¿å­˜æ›´æ”¹
          updateChatList();

          // è·³è½¬åˆ°èŠå¤©ç•Œé¢ï¼Œä¼ é€’èŠå¤©ä¿¡æ¯
          const params = new URLSearchParams({
            chatId: chat.id,
            chatName: encodeURIComponent(chat.name),
            type: chat.id === 'ai_assistant' ? 'ai' : 'friend',
          });

          // ä¼ é€’å¤´åƒä¿¡æ¯
          if (chat.avatarType === 'image') {
            // å¦‚æœæ˜¯å›¾ç‰‡å¤´åƒï¼Œä¼ é€’å¤´åƒæ–‡ä»¶ä¿¡æ¯
            params.set('chatAvatarFile', encodeURIComponent(chat.avatar));
            params.set('chatAvatar', ''); // æ¸…ç©ºå­—æ¯å¤´åƒ
          } else {
            // å¦‚æœæ˜¯æ–‡å­—å¤´åƒï¼Œä¼ é€’å­—æ¯
            params.set('chatAvatar', encodeURIComponent(chat.avatar || chat.name.charAt(0)));
          }

          window.location.href = `./chat.html?${params.toString()}`;
        }
      }

      // æ‰“å¼€æœ‹å‹åœˆ
      function openMoments() {
        showCustomAlert('æœ‹å‹åœˆ', 'è¿™é‡Œä¼šæ˜¾ç¤ºæœ‹å‹åœˆåŠ¨æ€');
      }

      // æ›´æ–°çŠ¶æ€æ æ—¶é—´
      function updateTime() {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const timeString = `${hours}:${minutes}`;

        const timeElement = document.getElementById('currentTime');
        if (timeElement) {
          timeElement.textContent = timeString;
        }
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', function () {
        // ç«‹å³æ›´æ–°æ—¶é—´
        updateTime();

        // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ—¶é—´
        setInterval(updateTime, 60000);

        initPage();

        // æ·»åŠ é”®ç›˜äº‹ä»¶æ”¯æŒ
        document.getElementById('modalInput').addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            confirmAddFriend();
          }
        });

        // ç‚¹å‡»é®ç½©å±‚å…³é—­å¼¹çª—
        document.getElementById('modalOverlay').addEventListener('click', function (e) {
          if (e.target === this) {
            hideModal();
          }
        });
      });

      // ç›‘å¬é¡µé¢ç„¦ç‚¹äº‹ä»¶ï¼Œå½“ä»èŠå¤©é¡µé¢è¿”å›æ—¶é‡æ–°åŠ è½½è®¾ç½®
      window.addEventListener('focus', function () {
        console.log('QQé¡µé¢è·å¾—ç„¦ç‚¹ï¼Œé‡æ–°åŠ è½½è®¾ç½®');
        loadUserSettings();
        saveChatData(); // ä¿å­˜æ›´æ–°åçš„æ•°æ®
        updateChatList();
      });
    </script>
  </body>
</html>
