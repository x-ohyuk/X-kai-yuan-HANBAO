<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>APIè¯Šæ–­å·¥å…·</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .section {
        margin-bottom: 30px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      .section h3 {
        margin: 0 0 15px 0;
        color: #333;
      }
      .result {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }
      .button {
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      .button:hover {
        background: #0056b3;
      }
      .status {
        padding: 5px 10px;
        border-radius: 3px;
        margin-left: 10px;
        font-size: 12px;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
      }
      .status.warning {
        background: #fff3cd;
        color: #856404;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ”§ APIè¯Šæ–­å·¥å…·</h1>
      <p>è¿™ä¸ªå·¥å…·ä¼šå¸®åŠ©ä½ æ£€æŸ¥APIé…ç½®æ˜¯å¦æ­£ç¡®</p>

      <div class="section">
        <h3>1. APIé…ç½®æ£€æŸ¥</h3>
        <button class="button" onclick="checkAPIConfig()">æ£€æŸ¥APIé…ç½®</button>
        <div id="config-result" class="result"></div>
      </div>

      <div class="section">
        <h3>2. APIè¿æ¥æµ‹è¯•</h3>
        <button class="button" onclick="testAPIConnection()">æµ‹è¯•APIè¿æ¥</button>
        <div id="connection-result" class="result"></div>
      </div>

      <div class="section">
        <h3>3. å¿«é€Ÿä¿®å¤</h3>
        <button class="button" onclick="clearAPISettings()">æ¸…é™¤APIè®¾ç½®</button>
        <button class="button" onclick="restoreDefaultSettings()">æ¢å¤é»˜è®¤è®¾ç½®</button>
        <button class="button" onclick="openAPISettings()">æ‰“å¼€APIè®¾ç½®é¡µé¢</button>
      </div>

      <div class="section">
        <h3>4. èŠå¤©è®°å½•æ£€æŸ¥</h3>
        <button class="button" onclick="checkChatHistory()">æ£€æŸ¥èŠå¤©è®°å½•</button>
        <div id="chat-result" class="result"></div>
      </div>
    </div>

    <script>
      function checkAPIConfig() {
        const result = document.getElementById('config-result');

        try {
          const apiSettings = JSON.parse(localStorage.getItem('apiSettings') || '{}');

          let report = '=== APIé…ç½®æ£€æŸ¥ç»“æœ ===\n\n';

          report += `é…ç½®æ˜¯å¦å­˜åœ¨: ${localStorage.getItem('apiSettings') ? 'âœ… æ˜¯' : 'âŒ å¦'}\n`;
          report += `é€‰æ‹©çš„æœåŠ¡: ${apiSettings.selectedService || 'âŒ æœªè®¾ç½®'}\n\n`;

          if (apiSettings.selectedService) {
            const serviceConfig = apiSettings[apiSettings.selectedService];
            if (serviceConfig) {
              report += `=== ${apiSettings.selectedService.toUpperCase()} é…ç½® ===\n`;
              report += `APIå¯†é’¥: ${
                serviceConfig.key ? 'âœ… å·²è®¾ç½® (' + serviceConfig.key.substring(0, 10) + '...)' : 'âŒ æœªè®¾ç½®'
              }\n`;
              report += `APIåœ°å€: ${serviceConfig.url || 'ä½¿ç”¨é»˜è®¤åœ°å€'}\n`;
              report += `æ¨¡å‹: ${serviceConfig.model || 'ä½¿ç”¨é»˜è®¤æ¨¡å‹'}\n`;
              report += `æ¸©åº¦: ${serviceConfig.temperature || 'ä½¿ç”¨é»˜è®¤å€¼'}\n`;
              if (serviceConfig.max_tokens) {
                report += `æœ€å¤§tokens: ${serviceConfig.max_tokens}\n`;
              }
            } else {
              report += `âŒ ${apiSettings.selectedService} æœåŠ¡é…ç½®ç¼ºå¤±\n`;
            }
          }

          // æ£€æŸ¥å…¶ä»–å¯èƒ½çš„é…ç½®
          if (apiSettings.openai) {
            report += '\n=== OpenAI é…ç½®å­˜åœ¨ ===\n';
          }
          if (apiSettings.gemini) {
            report += '\n=== Gemini é…ç½®å­˜åœ¨ ===\n';
          }

          result.textContent = report;
        } catch (error) {
          result.textContent = `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`;
        }
      }

      async function testAPIConnection() {
        const result = document.getElementById('connection-result');
        result.textContent = 'æ­£åœ¨æµ‹è¯•APIè¿æ¥...';

        try {
          const apiSettings = JSON.parse(localStorage.getItem('apiSettings') || '{}');

          if (!apiSettings.selectedService || !apiSettings[apiSettings.selectedService]?.key) {
            result.textContent = 'âŒ APIæœªé…ç½®ï¼Œæ— æ³•æµ‹è¯•è¿æ¥';
            return;
          }

          const config = apiSettings[apiSettings.selectedService];
          let testResult = '=== APIè¿æ¥æµ‹è¯• ===\n\n';

          if (apiSettings.selectedService === 'openai') {
            const baseUrl = (config.url || 'https://api.openai.com').replace(/\/$/, '');
            const endpoint = `${baseUrl}/v1/chat/completions`;

            const response = await fetch(endpoint, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${config.key}`,
              },
              body: JSON.stringify({
                model: config.model || 'gpt-3.5-turbo',
                messages: [{ role: 'user', content: 'æµ‹è¯•' }],
                max_tokens: 5,
              }),
            });

            testResult += `è¯·æ±‚åœ°å€: ${endpoint}\n`;
            testResult += `å“åº”çŠ¶æ€: ${response.status} ${response.statusText}\n`;

            if (response.ok) {
              const data = await response.json();
              testResult += 'âœ… è¿æ¥æˆåŠŸ!\n';
              testResult += `å“åº”: ${JSON.stringify(data, null, 2)}`;
            } else {
              const errorText = await response.text();
              testResult += `âŒ è¿æ¥å¤±è´¥: ${errorText}`;
            }
          } else if (apiSettings.selectedService === 'gemini') {
            const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${
              config.model || 'gemini-pro'
            }:generateContent?key=${config.key}`;

            const response = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{ parts: [{ text: 'æµ‹è¯•' }] }],
              }),
            });

            testResult += `è¯·æ±‚åœ°å€: ${endpoint}\n`;
            testResult += `å“åº”çŠ¶æ€: ${response.status} ${response.statusText}\n`;

            if (response.ok) {
              const data = await response.json();
              testResult += 'âœ… è¿æ¥æˆåŠŸ!\n';
              testResult += `å“åº”: ${JSON.stringify(data, null, 2)}`;
            } else {
              const errorText = await response.text();
              testResult += `âŒ è¿æ¥å¤±è´¥: ${errorText}`;
            }
          }

          result.textContent = testResult;
        } catch (error) {
          result.textContent = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
        }
      }

      function clearAPISettings() {
        localStorage.removeItem('apiSettings');
        alert('APIè®¾ç½®å·²æ¸…é™¤ï¼è¯·é‡æ–°é…ç½®ã€‚');
      }

      function restoreDefaultSettings() {
        const defaultSettings = {
          selectedService: 'openai',
          openai: {
            key: '',
            url: 'https://api.openai.com',
            model: 'gpt-3.5-turbo',
            temperature: '0.7',
          },
        };
        localStorage.setItem('apiSettings', JSON.stringify(defaultSettings));
        alert('å·²æ¢å¤é»˜è®¤è®¾ç½®ï¼è¯·åœ¨APIè®¾ç½®ä¸­å¡«å…¥ä½ çš„APIå¯†é’¥ã€‚');
      }

      function openAPISettings() {
        window.open('api.html', '_blank');
      }

      function checkChatHistory() {
        const result = document.getElementById('chat-result');

        try {
          let report = '=== èŠå¤©è®°å½•æ£€æŸ¥ ===\n\n';

          // æ£€æŸ¥å½“å‰èŠå¤©ä¿¡æ¯
          const currentChatInfo = localStorage.getItem('currentChatInfo');
          report += `å½“å‰èŠå¤©ä¿¡æ¯: ${currentChatInfo ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}\n`;

          if (currentChatInfo) {
            const chatInfo = JSON.parse(currentChatInfo);
            report += `èŠå¤©ID: ${chatInfo.id}\n`;
            report += `èŠå¤©ç±»å‹: ${chatInfo.type}\n`;

            // æ£€æŸ¥èŠå¤©å†å²
            const chatHistory = localStorage.getItem(`chatHistory_${chatInfo.id}`);
            if (chatHistory) {
              const messages = JSON.parse(chatHistory);
              report += `æ¶ˆæ¯æ•°é‡: ${messages.length}\n`;

              if (messages.length > 0) {
                const lastMessage = messages[messages.length - 1];
                report += `æœ€åæ¶ˆæ¯: ${lastMessage.sender} - ${lastMessage.text.substring(0, 50)}...\n`;
              }
            } else {
              report += 'èŠå¤©å†å²: æ— \n';
            }
          }

          // æ£€æŸ¥è®¾ç½®
          const chatSettings = localStorage.getItem('chatSettings');
          report += `\nèŠå¤©è®¾ç½®: ${chatSettings ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}\n`;

          result.textContent = report;
        } catch (error) {
          result.textContent = `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`;
        }
      }
    </script>
  </body>
</html>
