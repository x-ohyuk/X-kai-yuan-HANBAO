<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>表情包管理</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      /* 当在iframe中时调整样式 */
      body.iframe-mode {
        background: #f8f9fa;
        padding: 10px;
        min-height: auto;
      }

      body.iframe-mode .container {
        background: white;
        box-shadow: none;
        border-radius: 12px;
        padding: 15px;
        margin: 0;
        max-width: none;
      }

      body.iframe-mode .header {
        margin-bottom: 20px;
      }

      body.iframe-mode .header h1 {
        font-size: 20px;
        margin-bottom: 8px;
      }

      .container {
        max-width: 500px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        color: #333;
        font-size: 24px;
        margin-bottom: 10px;
      }

      .header p {
        color: #666;
        font-size: 14px;
      }

      .upload-section {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        text-align: center;
      }

      .upload-area {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 30px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .upload-area:hover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.05);
      }

      .upload-area.dragover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.1);
      }

      .upload-icon {
        font-size: 48px;
        color: #ddd;
        margin-bottom: 10px;
      }

      .upload-text {
        color: #666;
        margin-bottom: 15px;
      }

      #fileInput {
        display: none;
      }

      .url-input-section {
        margin-top: 15px;
      }

      .url-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        margin-bottom: 10px;
      }

      .url-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .emojis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
        margin-bottom: 20px;
      }

      .emoji-item {
        position: relative;
        aspect-ratio: 1;
        border-radius: 12px;
        overflow: hidden;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .emoji-item:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .emoji-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .emoji-item .delete-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255, 0, 0, 0.8);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .emoji-item:hover .delete-btn {
        opacity: 1;
      }

      .preview-section {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 12px;
      }

      .preview-image {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        margin: 10px 0;
      }

      .back-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .back-btn:hover {
        transform: scale(1.1);
        background: white;
      }

      .stats {
        text-align: center;
        margin-bottom: 20px;
        color: #666;
        font-size: 14px;
      }

      .loading {
        display: none;
        text-align: center;
        color: #667eea;
        margin: 10px 0;
      }

      .error-message {
        color: #ff4757;
        text-align: center;
        margin: 10px 0;
        font-size: 14px;
        display: none;
      }

      .success-message {
        color: #2ed573;
        text-align: center;
        margin: 10px 0;
        font-size: 14px;
        display: none;
      }
    </style>
  </head>
  <body>
    <button class="back-btn" onclick="goBack()">←</button>

    <div class="container">
      <div class="header">
        <h1>表情包管理 📦</h1>
        <p>上传和管理你的专属表情包</p>
      </div>

      <div class="stats">已保存 <span id="emojiCount">0</span> 个表情包</div>

      <div class="upload-section">
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
          <div class="upload-icon">📷</div>
          <div class="upload-text">点击上传本地图片<br />或拖拽图片到此处</div>
          <input type="file" id="fileInput" accept="image/*" multiple />
        </div>

        <div class="url-input-section">
          <input type="text" id="urlInput" class="url-input" placeholder="或输入图片链接 (图床URL)" maxlength="500" />
          <button class="btn" onclick="addEmojiFromUrl()">添加图片链接</button>
        </div>

        <div class="loading" id="loading">正在上传...</div>
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <div class="preview-section" id="previewSection" style="display: none">
          <h4>预览</h4>
          <img id="previewImage" class="preview-image" />
          <div>
            <button class="btn" onclick="confirmUpload()">确认添加</button>
            <button class="btn" onclick="cancelPreview()" style="background: #ccc">取消</button>
          </div>
        </div>
      </div>

      <div class="emojis-grid" id="emojisGrid">
        <!-- 表情包将在这里显示 -->
      </div>

      <div style="text-align: center; margin-top: 20px">
        <button class="btn" onclick="clearAllEmojis()" style="background: #ff4757">清空所有表情包</button>
      </div>
    </div>

    <script>
      let currentPreviewData = null;
      let emojis = JSON.parse(localStorage.getItem('customEmojis') || '[]');

      // 页面加载时初始化
      document.addEventListener('DOMContentLoaded', function () {
        // 检测是否在iframe中，如果是则应用iframe样式
        if (window.parent && window.parent !== window) {
          document.body.classList.add('iframe-mode');
        }

        loadEmojis();
        initDragAndDrop();
      });

      // 初始化拖拽上传
      function initDragAndDrop() {
        const uploadArea = document.querySelector('.upload-area');

        uploadArea.addEventListener('dragover', function (e) {
          e.preventDefault();
          uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function (e) {
          e.preventDefault();
          uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function (e) {
          e.preventDefault();
          uploadArea.classList.remove('dragover');

          const files = e.dataTransfer.files;
          if (files.length > 0) {
            handleFiles(files);
          }
        });
      }

      // 文件选择事件
      document.getElementById('fileInput').addEventListener('change', function (e) {
        handleFiles(e.target.files);
      });

      // 处理文件上传
      function handleFiles(files) {
        if (files.length === 0) return;

        showLoading(true);

        Array.from(files).forEach(file => {
          if (!file.type.startsWith('image/')) {
            showError('只能上传图片文件！');
            return;
          }

          if (file.size > 5 * 1024 * 1024) {
            // 5MB限制
            showError('图片大小不能超过5MB！');
            return;
          }

          const reader = new FileReader();
          reader.onload = function (e) {
            const imageData = e.target.result;
            previewImage(imageData, file.name);
          };
          reader.readAsDataURL(file);
        });

        showLoading(false);
      }

      // 从URL添加表情包
      function addEmojiFromUrl() {
        const url = document.getElementById('urlInput').value.trim();
        if (!url) {
          showError('请输入图片链接！');
          return;
        }

        // 验证URL格式
        try {
          new URL(url);
        } catch {
          showError('请输入有效的图片链接！');
          return;
        }

        showLoading(true);

        // 测试图片是否可以加载
        const img = new Image();
        img.onload = function () {
          previewImage(url, '网络图片');
          showLoading(false);
        };
        img.onerror = function () {
          showError('无法加载该图片，请检查链接是否正确！');
          showLoading(false);
        };
        img.src = url;
      }

      // 预览图片
      function previewImage(src, name) {
        currentPreviewData = { src, name };
        document.getElementById('previewImage').src = src;
        document.getElementById('previewSection').style.display = 'block';
      }

      // 确认上传
      function confirmUpload() {
        if (!currentPreviewData) return;

        const emoji = {
          id: Date.now() + Math.random(),
          src: currentPreviewData.src,
          name: currentPreviewData.name,
          uploadTime: new Date().toISOString(),
        };

        emojis.push(emoji);
        localStorage.setItem('customEmojis', JSON.stringify(emojis));

        loadEmojis();
        cancelPreview();
        showSuccess('表情包添加成功！');
        notifyEmojiUpdate();
      }

      // 通知父页面表情包更新
      function notifyEmojiUpdate() {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage(
            {
              type: 'emojiUpdated',
            },
            '*',
          );
        }
      }

      // 清空输入
      function clearInputs() {
        document.getElementById('urlInput').value = '';
        document.getElementById('fileInput').value = '';
      }

      // 取消预览
      function cancelPreview() {
        currentPreviewData = null;
        document.getElementById('previewSection').style.display = 'none';
      }

      // 加载表情包列表
      function loadEmojis() {
        const grid = document.getElementById('emojisGrid');
        grid.innerHTML = '';

        document.getElementById('emojiCount').textContent = emojis.length;

        emojis.forEach(emoji => {
          const item = document.createElement('div');
          item.className = 'emoji-item';
          item.innerHTML = `
          <img src="${emoji.src}" alt="${emoji.name}" onerror="this.parentElement.style.display='none'">
          <button class="delete-btn" onclick="deleteEmoji('${emoji.id}')" title="删除">×</button>
        `;

          // 点击选择表情包
          item.addEventListener('click', function (e) {
            if (e.target.classList.contains('delete-btn')) return;
            selectEmoji(emoji);
          });

          grid.appendChild(item);
        });
      }

      // 选择表情包
      function selectEmoji(emoji) {
        // 检查是否在iframe中
        if (window.parent && window.parent !== window) {
          // 发送消息给父页面
          window.parent.postMessage(
            {
              type: 'emojiSelected',
              src: emoji.src,
              emoji: emoji,
            },
            '*',
          );
        } else if (window.opener && window.opener.insertEmoji) {
          // 弹窗模式
          window.opener.insertEmoji(emoji.src);
          window.close();
        } else {
          // 如果不是弹窗模式，回到聊天页面
          const chatUrl = 'chat.html' + window.location.search;
          localStorage.setItem('selectedEmoji', JSON.stringify(emoji));
          window.location.href = chatUrl;
        }
      }

      // 删除表情包
      function deleteEmoji(id) {
        if (confirm('确定要删除这个表情包吗？')) {
          emojis = emojis.filter(emoji => emoji.id != id);
          localStorage.setItem('customEmojis', JSON.stringify(emojis));
          loadEmojis();
          showSuccess('表情包已删除！');
          notifyEmojiUpdate();
        }
      }

      // 清空所有表情包
      function clearAllEmojis() {
        if (confirm('确定要清空所有表情包吗？此操作不可恢复！')) {
          emojis = [];
          localStorage.setItem('customEmojis', JSON.stringify(emojis));
          loadEmojis();
          showSuccess('所有表情包已清空！');
        }
      }

      // 返回聊天页面
      function goBack() {
        if (window.opener) {
          window.close();
        } else {
          const chatUrl = 'chat.html' + window.location.search;
          window.location.href = chatUrl;
        }
      }

      // 显示加载状态
      function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'block' : 'none';
      }

      // 显示错误信息
      function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
          errorDiv.style.display = 'none';
        }, 3000);
      }

      // 显示成功信息
      function showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        setTimeout(() => {
          successDiv.style.display = 'none';
        }, 2000);
      }
    </script>
  </body>
</html>
