<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¡¨æƒ…åŒ…ç®¡ç†</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      /* å½“åœ¨iframeä¸­æ—¶è°ƒæ•´æ ·å¼ */
      body.iframe-mode {
        background: #f8f9fa;
        padding: 10px;
        min-height: auto;
      }

      body.iframe-mode .container {
        background: white;
        box-shadow: none;
        border-radius: 12px;
        padding: 15px;
        margin: 0;
        max-width: none;
      }

      body.iframe-mode .header {
        margin-bottom: 20px;
      }

      body.iframe-mode .header h1 {
        font-size: 20px;
        margin-bottom: 8px;
      }

      .container {
        max-width: 500px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        color: #333;
        font-size: 24px;
        margin-bottom: 10px;
      }

      .header p {
        color: #666;
        font-size: 14px;
      }

      .upload-section {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        text-align: center;
      }

      .upload-area {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 30px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .upload-area:hover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.05);
      }

      .upload-area.dragover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.1);
      }

      .upload-icon {
        font-size: 48px;
        color: #ddd;
        margin-bottom: 10px;
      }

      .upload-text {
        color: #666;
        margin-bottom: 15px;
      }

      #fileInput {
        display: none;
      }

      .url-input-section {
        margin-top: 15px;
      }

      .url-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        margin-bottom: 10px;
      }

      .url-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .emojis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
        margin-bottom: 20px;
      }

      .emoji-item {
        position: relative;
        aspect-ratio: 1;
        border-radius: 12px;
        overflow: hidden;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .emoji-item:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .emoji-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .emoji-item .delete-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255, 0, 0, 0.8);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .emoji-item:hover .delete-btn {
        opacity: 1;
      }

      .preview-section {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 12px;
      }

      .preview-image {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        margin: 10px 0;
      }

      .back-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .back-btn:hover {
        transform: scale(1.1);
        background: white;
      }

      .stats {
        text-align: center;
        margin-bottom: 20px;
        color: #666;
        font-size: 14px;
      }

      .loading {
        display: none;
        text-align: center;
        color: #667eea;
        margin: 10px 0;
      }

      .error-message {
        color: #ff4757;
        text-align: center;
        margin: 10px 0;
        font-size: 14px;
        display: none;
      }

      .success-message {
        color: #2ed573;
        text-align: center;
        margin: 10px 0;
        font-size: 14px;
        display: none;
      }
    </style>
  </head>
  <body>
    <button class="back-btn" onclick="goBack()">â†</button>

    <div class="container">
      <div class="header">
        <h1>è¡¨æƒ…åŒ…ç®¡ç† ğŸ“¦</h1>
        <p>ä¸Šä¼ å’Œç®¡ç†ä½ çš„ä¸“å±è¡¨æƒ…åŒ…</p>
      </div>

      <div class="stats">å·²ä¿å­˜ <span id="emojiCount">0</span> ä¸ªè¡¨æƒ…åŒ…</div>

      <div class="upload-section">
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
          <div class="upload-icon">ğŸ“·</div>
          <div class="upload-text">ç‚¹å‡»ä¸Šä¼ æœ¬åœ°å›¾ç‰‡<br />æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
          <input type="file" id="fileInput" accept="image/*" multiple />
        </div>

        <div class="url-input-section">
          <input type="text" id="urlInput" class="url-input" placeholder="æˆ–è¾“å…¥å›¾ç‰‡é“¾æ¥ (å›¾åºŠURL)" maxlength="500" />
          <button class="btn" onclick="addEmojiFromUrl()">æ·»åŠ å›¾ç‰‡é“¾æ¥</button>
        </div>

        <div class="loading" id="loading">æ­£åœ¨ä¸Šä¼ ...</div>
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <div class="preview-section" id="previewSection" style="display: none">
          <h4>é¢„è§ˆ</h4>
          <img id="previewImage" class="preview-image" />
          <div>
            <button class="btn" onclick="confirmUpload()">ç¡®è®¤æ·»åŠ </button>
            <button class="btn" onclick="cancelPreview()" style="background: #ccc">å–æ¶ˆ</button>
          </div>
        </div>
      </div>

      <div class="emojis-grid" id="emojisGrid">
        <!-- è¡¨æƒ…åŒ…å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
      </div>

      <div style="text-align: center; margin-top: 20px">
        <button class="btn" onclick="clearAllEmojis()" style="background: #ff4757">æ¸…ç©ºæ‰€æœ‰è¡¨æƒ…åŒ…</button>
      </div>
    </div>

    <script>
      let currentPreviewData = null;
      let emojis = JSON.parse(localStorage.getItem('customEmojis') || '[]');

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', function () {
        // æ£€æµ‹æ˜¯å¦åœ¨iframeä¸­ï¼Œå¦‚æœæ˜¯åˆ™åº”ç”¨iframeæ ·å¼
        if (window.parent && window.parent !== window) {
          document.body.classList.add('iframe-mode');
        }

        loadEmojis();
        initDragAndDrop();
      });

      // åˆå§‹åŒ–æ‹–æ‹½ä¸Šä¼ 
      function initDragAndDrop() {
        const uploadArea = document.querySelector('.upload-area');

        uploadArea.addEventListener('dragover', function (e) {
          e.preventDefault();
          uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function (e) {
          e.preventDefault();
          uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function (e) {
          e.preventDefault();
          uploadArea.classList.remove('dragover');

          const files = e.dataTransfer.files;
          if (files.length > 0) {
            handleFiles(files);
          }
        });
      }

      // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
      document.getElementById('fileInput').addEventListener('change', function (e) {
        handleFiles(e.target.files);
      });

      // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
      function handleFiles(files) {
        if (files.length === 0) return;

        showLoading(true);

        Array.from(files).forEach(file => {
          if (!file.type.startsWith('image/')) {
            showError('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ï¼');
            return;
          }

          if (file.size > 5 * 1024 * 1024) {
            // 5MBé™åˆ¶
            showError('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MBï¼');
            return;
          }

          const reader = new FileReader();
          reader.onload = function (e) {
            const imageData = e.target.result;
            previewImage(imageData, file.name);
          };
          reader.readAsDataURL(file);
        });

        showLoading(false);
      }

      // ä»URLæ·»åŠ è¡¨æƒ…åŒ…
      function addEmojiFromUrl() {
        const url = document.getElementById('urlInput').value.trim();
        if (!url) {
          showError('è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥ï¼');
          return;
        }

        // éªŒè¯URLæ ¼å¼
        try {
          new URL(url);
        } catch {
          showError('è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡é“¾æ¥ï¼');
          return;
        }

        showLoading(true);

        // æµ‹è¯•å›¾ç‰‡æ˜¯å¦å¯ä»¥åŠ è½½
        const img = new Image();
        img.onload = function () {
          previewImage(url, 'ç½‘ç»œå›¾ç‰‡');
          showLoading(false);
        };
        img.onerror = function () {
          showError('æ— æ³•åŠ è½½è¯¥å›¾ç‰‡ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æ­£ç¡®ï¼');
          showLoading(false);
        };
        img.src = url;
      }

      // é¢„è§ˆå›¾ç‰‡
      function previewImage(src, name) {
        currentPreviewData = { src, name };
        document.getElementById('previewImage').src = src;
        document.getElementById('previewSection').style.display = 'block';
      }

      // ç¡®è®¤ä¸Šä¼ 
      function confirmUpload() {
        if (!currentPreviewData) return;

        const emoji = {
          id: Date.now() + Math.random(),
          src: currentPreviewData.src,
          name: currentPreviewData.name,
          uploadTime: new Date().toISOString(),
        };

        emojis.push(emoji);
        localStorage.setItem('customEmojis', JSON.stringify(emojis));

        loadEmojis();
        cancelPreview();
        showSuccess('è¡¨æƒ…åŒ…æ·»åŠ æˆåŠŸï¼');
        notifyEmojiUpdate();
      }

      // é€šçŸ¥çˆ¶é¡µé¢è¡¨æƒ…åŒ…æ›´æ–°
      function notifyEmojiUpdate() {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage(
            {
              type: 'emojiUpdated',
            },
            '*',
          );
        }
      }

      // æ¸…ç©ºè¾“å…¥
      function clearInputs() {
        document.getElementById('urlInput').value = '';
        document.getElementById('fileInput').value = '';
      }

      // å–æ¶ˆé¢„è§ˆ
      function cancelPreview() {
        currentPreviewData = null;
        document.getElementById('previewSection').style.display = 'none';
      }

      // åŠ è½½è¡¨æƒ…åŒ…åˆ—è¡¨
      function loadEmojis() {
        const grid = document.getElementById('emojisGrid');
        grid.innerHTML = '';

        document.getElementById('emojiCount').textContent = emojis.length;

        emojis.forEach(emoji => {
          const item = document.createElement('div');
          item.className = 'emoji-item';
          item.innerHTML = `
          <img src="${emoji.src}" alt="${emoji.name}" onerror="this.parentElement.style.display='none'">
          <button class="delete-btn" onclick="deleteEmoji('${emoji.id}')" title="åˆ é™¤">Ã—</button>
        `;

          // ç‚¹å‡»é€‰æ‹©è¡¨æƒ…åŒ…
          item.addEventListener('click', function (e) {
            if (e.target.classList.contains('delete-btn')) return;
            selectEmoji(emoji);
          });

          grid.appendChild(item);
        });
      }

      // é€‰æ‹©è¡¨æƒ…åŒ…
      function selectEmoji(emoji) {
        // æ£€æŸ¥æ˜¯å¦åœ¨iframeä¸­
        if (window.parent && window.parent !== window) {
          // å‘é€æ¶ˆæ¯ç»™çˆ¶é¡µé¢
          window.parent.postMessage(
            {
              type: 'emojiSelected',
              src: emoji.src,
              emoji: emoji,
            },
            '*',
          );
        } else if (window.opener && window.opener.insertEmoji) {
          // å¼¹çª—æ¨¡å¼
          window.opener.insertEmoji(emoji.src);
          window.close();
        } else {
          // å¦‚æœä¸æ˜¯å¼¹çª—æ¨¡å¼ï¼Œå›åˆ°èŠå¤©é¡µé¢
          const chatUrl = 'chat.html' + window.location.search;
          localStorage.setItem('selectedEmoji', JSON.stringify(emoji));
          window.location.href = chatUrl;
        }
      }

      // åˆ é™¤è¡¨æƒ…åŒ…
      function deleteEmoji(id) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¡¨æƒ…åŒ…å—ï¼Ÿ')) {
          emojis = emojis.filter(emoji => emoji.id != id);
          localStorage.setItem('customEmojis', JSON.stringify(emojis));
          loadEmojis();
          showSuccess('è¡¨æƒ…åŒ…å·²åˆ é™¤ï¼');
          notifyEmojiUpdate();
        }
      }

      // æ¸…ç©ºæ‰€æœ‰è¡¨æƒ…åŒ…
      function clearAllEmojis() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è¡¨æƒ…åŒ…å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
          emojis = [];
          localStorage.setItem('customEmojis', JSON.stringify(emojis));
          loadEmojis();
          showSuccess('æ‰€æœ‰è¡¨æƒ…åŒ…å·²æ¸…ç©ºï¼');
        }
      }

      // è¿”å›èŠå¤©é¡µé¢
      function goBack() {
        if (window.opener) {
          window.close();
        } else {
          const chatUrl = 'chat.html' + window.location.search;
          window.location.href = chatUrl;
        }
      }

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'block' : 'none';
      }

      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
          errorDiv.style.display = 'none';
        }, 3000);
      }

      // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
      function showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        setTimeout(() => {
          successDiv.style.display = 'none';
        }, 2000);
      }
    </script>
  </body>
</html>
