<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>AIèŠå¤©</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Segoe UI', Roboto, Arial,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #a1c4fd 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: backgroundShift 10s ease-in-out infinite;
      }

      @keyframes backgroundShift {
        0%,
        100% {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #a1c4fd 100%);
        }
        33% {
          background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 50%, #667eea 100%);
        }
        66% {
          background: linear-gradient(135deg, #764ba2 0%, #667eea 50%, #c2e9fb 100%);
        }
      }
      .iphone-frame {
        width: 390px;
        height: 844px;
        border-radius: 54px;
        background: linear-gradient(180deg, #0f1724 0%, #0b1220 60%);
        border: none;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.02), inset 0 -6px 20px rgba(0, 0, 0, 0.6),
          0 8px 30px rgba(2, 6, 23, 0.55);
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .screen {
        width: 370px;
        height: 804px;
        border-radius: 44px;
        background: #f7f7f7;
        position: relative;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      /* çµåŠ¨å²› */
      .dynamic-island {
        position: absolute;
        top: 18px;
        left: 50%;
        transform: translateX(-50%);
        width: 120px;
        height: 36px;
        background: #0b0b0b;
        border-radius: 18px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
        z-index: 10;
      }
      /* çŠ¶æ€æ  */
      .status-bar {
        position: absolute;
        top: 6px;
        left: 0;
        width: 100%;
        height: 48px;
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        padding: 6px 18px;
        color: #000;
        font-size: 15px;
        font-weight: 600;
        pointer-events: none;
        z-index: 5;
      }
      .status-left {
        font-weight: 600;
      }
      .status-right {
        display: flex;
        gap: 8px;
        align-items: center;
        color: #00d4aa;
      }
      /* å¯¼èˆªæ  */
      .navbar {
        margin-top: 54px;
        height: 60px;
        background: #f7f7f7;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        border-bottom: 1px solid #e8e8e8;
      }
      .nav-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .back-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: none;
        color: #1890ff;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .nav-center {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
        justify-content: center;
      }
      .nav-avatar {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        background: #667eea;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
      }
      .nav-name {
        font-size: 16px;
        font-weight: 600;
        color: #000;
      }
      .nav-status {
        font-size: 12px;
        color: #34c759;
      }
      .nav-right {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .nav-icon {
        width: 28px;
        height: 28px;
        border: none;
        background: none;
        color: #1890ff;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .nav-icon:hover {
        background: rgba(24, 144, 255, 0.1);
        border-radius: 4px;
      }

      .nav-icon.delete-mode-active {
        background: #ff3b30;
        color: white;
        border-radius: 4px;
      }

      /* åˆ é™¤æ¨¡å¼ç›¸å…³æ ·å¼ */
      .delete-mode .message {
        cursor: pointer;
      }

      .delete-mode .message:hover {
        background: rgba(255, 59, 48, 0.05);
      }

      .message-delete-cross {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 20px;
        height: 20px;
        background: #ff3b30;
        color: white;
        border: 2px solid white;
        border-radius: 50%;
        font-size: 12px;
        display: none;
        cursor: pointer;
        z-index: 10;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .message.sent .message-delete-cross {
        right: -8px;
      }

      .message.received .message-delete-cross {
        left: -8px;
        right: auto;
      }

      .delete-mode .message-delete-cross {
        display: flex;
      }
      /* èŠå¤©åŒºåŸŸ */
      .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fff;
        overflow: hidden;
      }
      .messages-area {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      /* æ¶ˆæ¯æ°”æ³¡ */
      .message {
        display: flex;
        align-items: flex-end;
        gap: 8px;
        max-width: 85%;
        animation: messageSlide 0.3s ease-out;
        position: relative;
        touch-action: pan-y; /* å…è®¸å‚ç›´æ»šåŠ¨ï¼Œé™åˆ¶æ°´å¹³æ»šåŠ¨ */
        user-select: none; /* é˜²æ­¢æ–‡æœ¬é€‰æ‹©å¹²æ‰°æ»‘åŠ¨ */
      }
      @keyframes messageSlide {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .message.sent {
        align-self: flex-end;
        flex-direction: row-reverse;
      }
      .message.received {
        align-self: flex-start;
      }

      /* é•¿æŒ‰åˆ é™¤ç›¸å…³ */
      .message.long-pressing {
        transform: scale(0.98);
        opacity: 0.8;
      }

      .message-delete-btn {
        position: absolute;
        top: 50%;
        right: -40px;
        transform: translateY(-50%);
        width: 32px;
        height: 32px;
        background: #ff3b30;
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 12px;
        display: none;
        cursor: pointer;
        z-index: 10;
      }

      .message.sent .message-delete-btn {
        right: -40px;
      }

      .message.received .message-delete-btn {
        left: -40px;
        right: auto;
      }

      .message.show-delete .message-delete-btn {
        display: block;
        animation: deleteButtonShow 0.2s ease-out;
      }

      @keyframes deleteButtonShow {
        from {
          opacity: 0;
          transform: translateY(-50%) scale(0.8);
        }
        to {
          opacity: 1;
          transform: translateY(-50%) scale(1);
        }
      }
      .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        background: #667eea;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        flex-shrink: 0;
      }
      .message-bubble {
        position: relative;
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 16px;
        line-height: 1.4;
        word-wrap: break-word;
        max-width: 100%;
      }
      .message.sent .message-bubble {
        background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%);
        color: white;
        border-bottom-right-radius: 6px;
        box-shadow: 0 2px 8px rgba(24, 144, 255, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .message.received .message-bubble {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        color: #333;
        border-bottom-left-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(0, 0, 0, 0.05);
      }
      .message-time {
        font-size: 11px;
        color: #999;
        margin-top: 4px;
        text-align: center;
      }
      /* è¾“å…¥åŒºåŸŸ */
      .input-area {
        background: #f7f7f7;
        border-top: 1px solid #e8e8e8;
        padding: 12px 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .input-row {
        display: flex;
        align-items: flex-end;
        gap: 8px;
      }

      .input-container {
        flex: 1;
        position: relative;
      }

      /* åŠŸèƒ½æŒ‰é’®åŒºåŸŸ */
      .function-buttons {
        gap: 8px;
        padding: 8px 0;
        justify-content: space-around;
        background: #f0f0f0;
        border-radius: 12px;
        margin-bottom: 4px;
        display: none;
      }

      .function-buttons.show {
        display: flex;
        animation: slideDown 0.3s ease-out;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .feature-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 8px 12px;
        background: none;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 24px;
        position: relative;
      }

      .feature-btn:hover {
        background: rgba(0, 0, 0, 0.05);
        transform: translateY(-2px);
      }

      .feature-btn span {
        font-size: 12px;
        color: #666;
        font-weight: 500;
      }

      /* çº¢åŒ…æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
      .feature-btn[data-action='redpacket'] {
        background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
        color: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        transform: scale(1.05);
      }

      .feature-btn[data-action='redpacket']:hover {
        background: linear-gradient(135deg, #ff5252 0%, #ff8f00 100%);
        transform: scale(1.08) translateY(-2px);
        box-shadow: 0 6px 16px rgba(255, 107, 107, 0.4);
      }

      .feature-btn[data-action='redpacket'] span {
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      }

      .feature-btn[data-action='redpacket']::before {
        content: '';
        position: absolute;
        top: -2px;
        right: -2px;
        width: 8px;
        height: 8px;
        background: #ffeb3b;
        border-radius: 50%;
        box-shadow: 0 0 6px rgba(255, 235, 59, 0.8);
        animation: redpacketGlow 2s ease-in-out infinite;
      }

      @keyframes redpacketGlow {
        0%,
        100% {
          opacity: 0.6;
          transform: scale(1);
        }
        50% {
          opacity: 1;
          transform: scale(1.2);
        }
      }

      /* è¡¨æƒ…åŒ…æŒ‰é’®æ ·å¼ */
      .feature-btn[data-action='emoji'] {
        background: linear-gradient(135deg, #ffb347 0%, #ff8c42 100%);
        color: white;
        border: none;
        box-shadow: 0 2px 8px rgba(255, 140, 66, 0.3);
      }

      .feature-btn[data-action='emoji']:hover {
        background: linear-gradient(135deg, #ff8c42 0%, #ff6b1a 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 140, 66, 0.4);
      }

      .feature-btn[data-action='emoji'] span {
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      }

      /* è¡¨æƒ…åŒ…æ¶ˆæ¯æ ·å¼ */
      .emoji-message {
        padding: 4px !important;
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
      }

      .emoji-message img {
        max-width: 120px;
        max-height: 120px;
        border-radius: 8px;
        display: block;
      }

      /* è¡¨æƒ…åŒ…é€‰æ‹©é¢æ¿ */
      .emoji-panel {
        position: absolute;
        bottom: 70px;
        left: 50%;
        transform: translateX(-50%);
        width: 320px;
        max-height: 250px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        display: none;
        overflow: hidden;
      }

      .emoji-panel-header {
        padding: 12px 16px;
        background: linear-gradient(135deg, #ffb347 0%, #ff8c42 100%);
        color: white;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .emoji-panel-close {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .emoji-panel-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .emoji-panel-content {
        padding: 16px;
        max-height: 200px;
        overflow-y: auto;
      }

      /* å“åº”å¼è°ƒæ•´ */
      @media (max-width: 480px) {
        .emoji-panel {
          bottom: 60px;
          width: 300px;
          max-height: 220px;
        }

        .emoji-panel-content {
          padding: 12px;
          max-height: 150px;
        }

        .emoji-grid {
          grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
          gap: 6px;
        }
      }
      .emoji-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 8px;
        margin-bottom: 16px;
      }

      .emoji-item {
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
      }

      .emoji-item:hover {
        transform: scale(1.05);
        border-color: #ff8c42;
      }

      .emoji-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .emoji-panel-footer {
        padding: 12px 16px;
        border-top: 1px solid #eee;
        text-align: center;
      }

      .manage-emoji-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 16px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .manage-emoji-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }

      .emoji-empty {
        text-align: center;
        color: #999;
        padding: 20px;
      }

      .message-input {
        width: 100%;
        min-height: 36px;
        max-height: 100px;
        padding: 8px 12px;
        border: 1px solid #d9d9d9;
        border-radius: 18px;
        background: #fff;
        font-size: 16px;
        line-height: 1.4;
        resize: none;
        outline: none;
        font-family: inherit;
        transition: all 0.2s ease;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
      }
      .message-input:focus {
        border-color: #1890ff;
        box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        transform: translateY(-1px);
      }
      .send-btn {
        width: 36px;
        height: 36px;
        border: none;
        border-radius: 18px;
        background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%);
        color: white;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        flex-shrink: 0;
        box-shadow: 0 2px 8px rgba(24, 144, 255, 0.3);
      }
      .send-btn:hover {
        background: linear-gradient(135deg, #0c7cd5 0%, #1890ff 100%);
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(24, 144, 255, 0.4);
      }
      .send-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* åŠŸèƒ½æŒ‰é’® */
      .function-btn {
        width: 36px;
        height: 36px;
        border: none;
        border-radius: 18px;
        background: linear-gradient(135deg, #f0f0f0 0%, #e8e8e8 100%);
        color: #666;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        flex-shrink: 0;
        margin-left: 8px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      }

      .function-btn:hover {
        background: linear-gradient(135deg, #e0e0e0 0%, #d8d8d8 100%);
        transform: scale(1.05);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }

      .function-btn.active {
        background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%);
        color: white;
        animation: buttonPulse 1.5s ease-in-out infinite;
        box-shadow: 0 2px 8px rgba(24, 144, 255, 0.3);
      }

      @keyframes buttonPulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.8;
          transform: scale(1.05);
        }
      }

      /* åŠŸèƒ½é€‰æ‹©å¡ç‰‡ */
      .function-card {
        position: absolute;
        bottom: 70px;
        right: 16px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        padding: 8px;
        display: none;
        flex-direction: column;
        gap: 4px;
        z-index: 50;
        min-width: 120px;
        animation: cardShow 0.2s ease-out;
      }

      @keyframes cardShow {
        from {
          opacity: 0;
          transform: translateY(10px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .function-option {
        padding: 12px 16px;
        border: none;
        background: none;
        color: #333;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border-radius: 8px;
        text-align: left;
        transition: background-color 0.2s ease;
        white-space: nowrap;
      }

      .function-option:hover {
        background: #f5f5f5;
      }

      .function-option:active {
        background: #e8e8e8;
      }

      .function-option.primary {
        color: #1890ff;
      }

      .function-option.warning {
        color: #ff9500;
      }
      /* çº¢åŒ…æ¶ˆæ¯æ ·å¼ - çœŸå®QQçº¢åŒ…æ ·å¼ */
      .redpacket-message {
        background: linear-gradient(135deg, #ff6256 0%, #ff4d4d 100%) !important;
        border: none !important;
        border-radius: 12px !important;
        box-shadow: 0 3px 12px rgba(255, 98, 86, 0.4) !important;
        position: relative;
        overflow: hidden;
        width: 200px !important;
        height: 72px !important;
        min-width: 200px !important;
        max-width: 200px !important;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex !important;
        align-items: center !important;
        padding: 0 !important;
      }

      .redpacket-message:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(255, 98, 86, 0.5) !important;
      }

      .redpacket-message:active {
        transform: translateY(0px);
        box-shadow: 0 3px 10px rgba(255, 98, 86, 0.4) !important;
      }

      .redpacket-content {
        position: relative;
        z-index: 2;
        padding: 16px;
        color: white;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 14px;
        width: 100%;
        height: 100%;
      }

      .redpacket-icon {
        font-size: 28px;
        flex-shrink: 0;
        filter: drop-shadow(0 1px 3px rgba(0, 0, 0, 0.3));
      }

      .redpacket-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
        justify-content: center;
        min-width: 0;
      }

      .redpacket-title {
        font-size: 12px;
        font-weight: 400;
        opacity: 0.85;
        margin: 0;
        color: rgba(255, 255, 255, 0.9);
      }

      .redpacket-bless {
        font-size: 15px;
        font-weight: 500;
        margin: 0;
        line-height: 1.3;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      /* éšè—é‡‘é¢ - çœŸå®QQçº¢åŒ…ä¸æ˜¾ç¤ºé‡‘é¢ */
      .redpacket-amount {
        display: none;
      }

      /* ç§»é™¤å¤šä½™çš„è£…é¥°å…ƒç´  */
      .redpacket-corner {
        display: none;
      }

      /* è½¬è´¦æ¶ˆæ¯æ ·å¼ - ç»¿è‰²ä¸»é¢˜ */
      .transfer-message {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%) !important;
        border: none !important;
        border-radius: 12px !important;
        box-shadow: 0 3px 12px rgba(76, 175, 80, 0.4) !important;
        position: relative;
        overflow: hidden;
        width: 200px !important;
        height: 80px !important;
        min-width: 200px !important;
        max-width: 200px !important;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex !important;
        align-items: center !important;
        padding: 0 !important;
      }

      .transfer-message:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(76, 175, 80, 0.5) !important;
      }

      .transfer-message:active {
        transform: translateY(0px);
        box-shadow: 0 3px 10px rgba(76, 175, 80, 0.4) !important;
      }

      .transfer-content {
        position: relative;
        z-index: 2;
        padding: 16px;
        color: white;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 14px;
        width: 100%;
        height: 100%;
      }

      .transfer-icon {
        font-size: 28px;
        flex-shrink: 0;
        filter: drop-shadow(0 1px 3px rgba(0, 0, 0, 0.3));
      }

      .transfer-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
        justify-content: center;
        min-width: 0;
      }

      .transfer-title {
        font-size: 12px;
        font-weight: 400;
        opacity: 0.85;
        margin: 0;
        color: rgba(255, 255, 255, 0.9);
      }

      .transfer-amount {
        font-size: 16px;
        font-weight: 600;
        margin: 0;
        line-height: 1.2;
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      .transfer-message-text {
        font-size: 12px;
        font-weight: 400;
        margin: 0;
        line-height: 1.2;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: rgba(255, 255, 255, 0.8);
        max-width: 120px;
      }

      /* å›¾ç‰‡æ¶ˆæ¯æ ·å¼ */
      .image-bubble {
        padding: 8px !important;
        max-width: 280px !important;
        background: #fff !important;
        border-radius: 12px !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
      }

      .message.sent .image-bubble {
        background: #007aff !important;
      }

      .image-message {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .message-image {
        width: 100%;
        max-width: 260px;
        max-height: 200px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .message-image:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .image-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 12px;
        color: #666;
      }

      .message.sent .image-info {
        color: rgba(255, 255, 255, 0.8);
      }

      .image-filename {
        font-weight: 500;
        word-break: break-all;
        line-height: 1.3;
      }

      .image-filesize {
        opacity: 0.8;
      }

      .image-tag {
        display: inline-block;
        background: rgba(0, 122, 255, 0.1);
        color: #007aff;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        margin-right: 4px;
        margin-top: 2px;
      }

      .message.sent .image-tag {
        background: rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.9);
      }

      /* å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† */
      .image-preview-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
        box-sizing: border-box;
      }

      .image-preview-content {
        max-width: 90%;
        max-height: 90%;
        position: relative;
      }

      .image-preview-img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 8px;
      }

      .image-preview-close {
        position: absolute;
        top: -40px;
        right: 0;
        background: none;
        border: none;
        color: #fff;
        font-size: 24px;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: background 0.2s ease;
      }

      .image-preview-close:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .image-preview-info {
        position: absolute;
        bottom: -40px;
        left: 0;
        color: #fff;
        font-size: 14px;
        opacity: 0.8;
      }

      /* åŠ è½½åŠ¨ç”» */
      .typing-indicator {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 12px 16px;
        color: #999;
        font-size: 14px;
      }
      .typing-dots {
        display: flex;
        gap: 2px;
      }
      .typing-dot {
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background: #999;
        animation: typingDot 1.4s infinite;
      }
      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      /* é€šçŸ¥åŠ¨ç”»æ ·å¼ */
      @keyframes slideDown {
        from {
          transform: translateX(-50%) translateY(-20px);
          opacity: 0;
        }
        to {
          transform: translateX(-50%) translateY(0);
          opacity: 1;
        }
      }
      @keyframes slideUp {
        from {
          transform: translateX(-50%) translateY(0);
          opacity: 1;
        }
        to {
          transform: translateX(-50%) translateY(-20px);
          opacity: 0;
        }
      }
      @keyframes typingDot {
        0%,
        60%,
        100% {
          opacity: 0.3;
        }
        30% {
          opacity: 1;
        }
      }
      /* è®¾ç½®é¢æ¿ */
      .settings-panel {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #fff;
        z-index: 100;
        display: none; /* é»˜è®¤éšè— */
        flex-direction: column;
        border-radius: 44px;
        overflow: hidden;
      }
      .settings-panel.visible {
        display: flex;
      }
      .settings-header {
        height: 60px;
        background: #f7f7f7;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        border-bottom: 1px solid #e8e8e8;
        margin-top: 54px;
      }
      .settings-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
      }
      .setting-group {
        margin-bottom: 24px;
      }
      .setting-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 12px;
      }
      .setting-item {
        margin-bottom: 16px;
      }
      .setting-label {
        display: block;
        font-size: 14px;
        color: #666;
        margin-bottom: 6px;
      }
      .setting-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d9d9d9;
        border-radius: 8px;
        font-size: 16px;
        outline: none;
      }
      .setting-input:focus {
        border-color: #1890ff;
      }
      .setting-textarea {
        width: 100%;
        min-height: 80px;
        padding: 10px 12px;
        border: 1px solid #d9d9d9;
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.4;
        resize: vertical;
        outline: none;
        font-family: inherit;
      }
      .save-btn {
        width: 100%;
        padding: 12px;
        background: #1890ff;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        margin-top: 20px;
      }
      .save-btn:hover {
        background: #0c7cd5;
      }

      /* å¤´åƒé¢„è§ˆå’Œä¸Šä¼  */
      .avatar-preview {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        background: #667eea;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 600;
        overflow: hidden;
        border: 2px solid #e8e8e8;
      }

      .avatar-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .upload-btn {
        padding: 8px 16px;
        background: #f0f0f0;
        border: 1px solid #d9d9d9;
        border-radius: 6px;
        color: #333;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .upload-btn:hover {
        background: #e8e8e8;
        border-color: #1890ff;
      }

      .upload-btn.secondary {
        background: #fff;
        color: #666;
        margin-left: 8px;
      }

      .upload-btn.secondary:hover {
        background: #f5f5f5;
        color: #333;
      }

      /* å¤´åƒä¸Šä¼ å®¹å™¨ */
      .avatar-upload-container {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-top: 8px;
      }

      .avatar-preview {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #667eea;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
        font-weight: 600;
        overflow: hidden;
        border: 2px solid #e8e8e8;
        background-size: cover;
        background-position: center;
      }

      .avatar-upload-area {
        display: flex;
        align-items: center;
      }

      /* èŠå¤©ä¿¡æ¯é¢æ¿ */
      .chat-info-panel {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #fff;
        z-index: 100;
        display: none;
        flex-direction: column;
        border-radius: 44px;
        overflow: hidden;
      }

      .chat-info-header {
        height: 60px;
        background: #f7f7f7;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        border-bottom: 1px solid #e8e8e8;
        margin-top: 54px;
      }

      .chat-info-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
      }

      .chat-info-avatar {
        width: 80px;
        height: 80px;
        border-radius: 12px;
        background: #667eea;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        font-weight: 600;
        margin: 0 auto 16px;
      }

      .chat-info-name {
        text-align: center;
        font-size: 24px;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
      }

      .chat-info-status {
        text-align: center;
        font-size: 14px;
        color: #34c759;
        margin-bottom: 30px;
      }

      .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .info-label {
        font-size: 16px;
        color: #333;
      }

      .info-value {
        font-size: 16px;
        color: #666;
      }

      .action-buttons {
        padding: 20px 0;
        display: flex;
        gap: 12px;
      }

      .action-btn {
        flex: 1;
        padding: 12px;
        border: 1px solid #e8e8e8;
        border-radius: 8px;
        background: #fff;
        color: #333;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        text-align: center;
      }

      .action-btn:hover {
        background: #f5f5f5;
      }

      .action-btn.danger {
        color: #ff3b30;
        border-color: #ff3b30;
      }

      .action-btn.danger:hover {
        background: #fff5f5;
      }
    </style>
  </head>
  <body>
    <div class="iphone-frame">
      <div class="screen">
        <div class="dynamic-island"></div>
        <div class="status-bar">
          <div class="status-left" id="currentTime">9:41</div>
          <div class="status-right">
            <span style="color: #00d4aa">100%ğŸ”‹</span>
          </div>
        </div>

        <!-- ä¸»èŠå¤©ç•Œé¢ -->
        <div class="navbar">
          <div class="nav-left">
            <button class="back-btn" onclick="goBackToQQ()">â€¹</button>
          </div>
          <div class="nav-center">
            <div class="nav-avatar" id="chatAvatar">AI</div>
            <div>
              <div class="nav-name" id="chatName">AIåŠ©æ‰‹</div>
              <div class="nav-status" id="chatStatus">åœ¨çº¿</div>
            </div>
          </div>
          <div class="nav-right">
            <button class="nav-icon" id="deleteToggleBtn" onclick="toggleDeleteMode()" title="åˆ é™¤æ¨¡å¼">ğŸ—‘ï¸</button>
            <button class="nav-icon" onclick="showChatInfo()" title="èŠå¤©ä¿¡æ¯">â„¹ï¸</button>
            <button class="nav-icon" onclick="toggleSettings()" title="è®¾ç½®">âš™ï¸</button>
          </div>
        </div>

        <div class="chat-container">
          <div class="messages-area" id="messagesArea">
            <!-- èŠå¤©æ¶ˆæ¯ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            <div class="message received">
              <div class="message-avatar" id="aiAvatarMsg">AI</div>
              <div>
                <div class="message-bubble">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ</div>
                <div class="message-time">åˆšåˆš</div>
              </div>
            </div>
          </div>

          <div class="input-area">
            <!-- åŠŸèƒ½æŒ‰é’®åŒºåŸŸ -->
            <div class="function-buttons" id="functionButtons">
              <button class="feature-btn" data-action="redpacket">
                ğŸ§§
                <span>çº¢åŒ…</span>
              </button>
              <button class="feature-btn" data-action="transfer">
                ğŸ’°
                <span>è½¬è´¦</span>
              </button>
              <button class="feature-btn" data-action="image">
                ğŸ–¼ï¸
                <span>å›¾ç‰‡</span>
              </button>
              <button class="feature-btn" data-action="emoji">
                ğŸ˜€
                <span>è¡¨æƒ…åŒ…</span>
              </button>
              <button class="feature-btn" id="rollBtn" style="display: none" title="è®©AIé‡æ–°ç”Ÿæˆå›å¤">
                ğŸ²<span>ROLL</span>
              </button>
            </div>

            <div class="input-row">
              <button class="function-btn" id="expandBtn" title="æ›´å¤šåŠŸèƒ½">â•</button>
              <div class="input-container">
                <textarea class="message-input" id="messageInput" placeholder="è¯·è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
              </div>
              <button class="send-btn" id="sendBtn">â¤</button>
              <button class="function-btn" id="functionBtn" title="æ›´å¤šåŠŸèƒ½">âš¡</button>
            </div>

            <!-- åŠŸèƒ½é€‰æ‹©å¡ç‰‡ -->
            <div class="function-card" id="functionCard">
              <button class="function-option warning" onclick="rollLastMessage()">ğŸ² ROLL</button>
              <button class="function-option primary" onclick="waitForReply()">â³ ç­‰å¾…å›å¤</button>
            </div>
          </div>
        </div>

        <!-- è¡¨æƒ…åŒ…é€‰æ‹©é¢æ¿ -->
        <div class="emoji-panel" id="emojiPanel">
          <div class="emoji-panel-header">
            <span>é€‰æ‹©è¡¨æƒ…åŒ…</span>
            <button class="emoji-panel-close" onclick="closeEmojiPanel()">Ã—</button>
          </div>
          <div class="emoji-panel-content">
            <div class="emoji-grid" id="emojiGrid">
              <!-- è¡¨æƒ…åŒ…å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
            <div class="emoji-empty" id="emojiEmpty" style="display: none">
              <p>è¿˜æ²¡æœ‰è¡¨æƒ…åŒ…</p>
              <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ å§ï¼</p>
            </div>
          </div>
          <div class="emoji-panel-footer">
            <button class="manage-emoji-btn" onclick="openEmojiManager()">ç®¡ç†è¡¨æƒ…åŒ…</button>
          </div>
        </div>

        <!-- è®¾ç½®é¢æ¿ -->
        <div class="settings-panel" id="settingsPanel">
          <div class="settings-header">
            <div>
              <button class="back-btn" onclick="toggleSettings()">â€¹</button>
              <span style="margin-left: 8px; font-size: 18px; font-weight: 600">èŠå¤©è®¾ç½®</span>
            </div>
          </div>

          <div class="settings-content">
            <div class="setting-group">
              <div class="setting-title">ç”¨æˆ·èµ„æ–™</div>
              <div class="setting-item">
                <label class="setting-label">ä½ çš„æ˜µç§°</label>
                <input type="text" class="setting-input" id="userName" placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°" />
              </div>
              <div class="setting-item">
                <label class="setting-label">ä½ çš„å¹´é¾„</label>
                <input type="text" class="setting-input" id="userAge" placeholder="è¯·è¾“å…¥ä½ çš„å¹´é¾„" />
              </div>
              <div class="setting-item">
                <label class="setting-label">ä½ çš„çˆ±å¥½</label>
                <input type="text" class="setting-input" id="userHobby" placeholder="è¯·è¾“å…¥ä½ çš„çˆ±å¥½" />
              </div>
              <div class="setting-item">
                <label class="setting-label">ç”¨æˆ·å¤´åƒ</label>
                <div class="avatar-upload-container">
                  <div class="avatar-preview" id="userAvatarPreview">
                    <span id="userAvatarText">ç”¨</span>
                  </div>
                  <div class="avatar-upload-area">
                    <input
                      type="file"
                      id="userAvatarFile"
                      accept="image/*"
                      style="display: none"
                      onchange="handleAvatarUpload('user')"
                    />
                    <button
                      type="button"
                      class="upload-btn"
                      onclick="document.getElementById('userAvatarFile').click()"
                    >
                      ä¸Šä¼ å¤´åƒ
                    </button>
                    <button type="button" class="upload-btn secondary" onclick="resetAvatar('user')">é‡ç½®</button>
                  </div>
                </div>
              </div>
              <div class="setting-item">
                <label class="setting-label">ä½ çš„æ€§æ ¼è®¾å®š</label>
                <textarea
                  class="setting-textarea"
                  id="userPersonality"
                  placeholder="æè¿°ä½ çš„æ€§æ ¼ã€è¯´è¯é£æ ¼ã€è¡Œä¸ºä¹ æƒ¯ç­‰..."
                ></textarea>
              </div>
              <div class="setting-item">
                <label class="setting-label">ä½ çš„èƒŒæ™¯æ•…äº‹</label>
                <textarea
                  class="setting-textarea"
                  id="userBackground"
                  placeholder="æè¿°ä½ çš„èƒŒæ™¯ã€èŒä¸šã€ç»å†ã€ä¸“ä¸šé¢†åŸŸç­‰..."
                ></textarea>
              </div>
            </div>

            <div class="setting-group">
              <div class="setting-title">AIåŠ©æ‰‹è®¾ç½®</div>
              <div class="setting-item">
                <label class="setting-label">AIåç§°</label>
                <input type="text" class="setting-input" id="aiName" placeholder="AIåŠ©æ‰‹åç§°" />
              </div>
              <div class="setting-item">
                <label class="setting-label">AIå¹´é¾„</label>
                <input type="text" class="setting-input" id="aiAge" placeholder="è¯·è¾“å…¥AIçš„å¹´é¾„" />
              </div>
              <div class="setting-item">
                <label class="setting-label">AIçˆ±å¥½</label>
                <input type="text" class="setting-input" id="aiHobby" placeholder="è¯·è¾“å…¥AIçš„çˆ±å¥½å’Œå…´è¶£" />
              </div>
              <div class="setting-item">
                <label class="setting-label">AIå¤´åƒ</label>
                <div class="avatar-upload-container">
                  <div class="avatar-preview" id="aiAvatarPreview">
                    <span id="aiAvatarText">AI</span>
                  </div>
                  <div class="avatar-upload-area">
                    <input
                      type="file"
                      id="aiAvatarFile"
                      accept="image/*"
                      style="display: none"
                      onchange="handleAvatarUpload('ai')"
                    />
                    <button type="button" class="upload-btn" onclick="document.getElementById('aiAvatarFile').click()">
                      ä¸Šä¼ å¤´åƒ
                    </button>
                    <button type="button" class="upload-btn secondary" onclick="resetAvatar('ai')">é‡ç½®</button>
                  </div>
                </div>
              </div>
              <div class="setting-item">
                <label class="setting-label">AIæ€§æ ¼è®¾å®š</label>
                <textarea
                  class="setting-textarea"
                  id="aiPersonality"
                  placeholder="æè¿°AIçš„æ€§æ ¼ã€è¯´è¯é£æ ¼ç­‰..."
                ></textarea>
              </div>
              <div class="setting-item">
                <label class="setting-label">AIèƒŒæ™¯æ•…äº‹</label>
                <textarea
                  class="setting-textarea"
                  id="aiBackground"
                  placeholder="æè¿°AIçš„èƒŒæ™¯ã€æ¥å†ã€ä¸“ä¸šé¢†åŸŸç­‰..."
                ></textarea>
              </div>
            </div>

            <div class="setting-group">
              <div class="setting-title">APIé…ç½®</div>
              <div class="setting-item">
                <label class="setting-label">AIæœåŠ¡é…ç½®çŠ¶æ€</label>
                <div style="display: flex; align-items: center; gap: 12px; margin-top: 8px">
                  <span id="apiStatus" style="color: #ff9500">æœªé…ç½®</span>
                  <button type="button" class="upload-btn" onclick="openAPISettings()">å‰å¾€APIè®¾ç½®</button>
                </div>
              </div>
            </div>

            <div class="setting-group">
              <div class="setting-title">èŠå¤©è®¾ç½®</div>
              <div class="setting-item">
                <label class="setting-label"> <input type="checkbox" id="autoSave" checked /> è‡ªåŠ¨ä¿å­˜èŠå¤©è®°å½• </label>
              </div>
              <div class="setting-item">
                <label class="setting-label">
                  <input type="checkbox" id="soundEnabled" checked /> å¯ç”¨æ¶ˆæ¯æç¤ºéŸ³
                </label>
              </div>
              <div class="setting-item">
                <label class="setting-label">
                  <input type="checkbox" id="worldBookEnabled" checked /> å¯ç”¨ä¸–ç•Œä¹¦å¢å¼º
                </label>
                <small style="color: #666; font-size: 12px; margin-top: 4px; display: block">
                  å¼€å¯åAIå°†æ ¹æ®ä¸–ç•Œä¹¦æ¡ç›®è¿›è¡Œè§’è‰²æ‰®æ¼”å’Œå¯¹è¯
                </small>
              </div>
              <div class="setting-item">
                <div style="display: flex; align-items: center; justify-content: space-between">
                  <span class="setting-label">ä¸–ç•Œä¹¦ç®¡ç†</span>
                  <button type="button" class="upload-btn" onclick="openWorldBook()">æ‰“å¼€ä¸–ç•Œä¹¦</button>
                </div>
                <small style="color: #666; font-size: 12px; margin-top: 4px; display: block">
                  ç®¡ç†è§’è‰²è®¾å®šã€ä¸–ç•Œè§‚ã€èƒŒæ™¯æ•…äº‹ç­‰æ¡ç›®
                </small>
              </div>
            </div>

            <button class="save-btn" onclick="saveSettings()" id="saveSettingsBtn">ä¿å­˜è®¾ç½®</button>
          </div>
        </div>

        <!-- èŠå¤©ä¿¡æ¯é¢æ¿ -->
        <div class="chat-info-panel" id="chatInfoPanel">
          <div class="chat-info-header">
            <div>
              <button class="back-btn" onclick="toggleChatInfo()">â€¹</button>
              <span style="margin-left: 8px; font-size: 18px; font-weight: 600">èŠå¤©ä¿¡æ¯</span>
            </div>
          </div>

          <div class="chat-info-content">
            <div class="chat-info-avatar" id="infoAvatar">AI</div>
            <div class="chat-info-name" id="infoName">AIåŠ©æ‰‹</div>
            <div class="chat-info-status" id="infoStatus">åœ¨çº¿</div>

            <div class="info-item">
              <div class="info-label">èŠå¤©ç±»å‹</div>
              <div class="info-value" id="chatType">AIå¯¹è¯</div>
            </div>
            <div class="info-item">
              <div class="info-label">æ¶ˆæ¯æ€»æ•°</div>
              <div class="info-value" id="messageCount">0æ¡</div>
            </div>
            <div class="info-item">
              <div class="info-label">åˆ›å»ºæ—¶é—´</div>
              <div class="info-value" id="createTime">åˆšåˆš</div>
            </div>

            <div class="action-buttons">
              <button class="action-btn" onclick="clearChatHistory()">æ¸…ç©ºèŠå¤©è®°å½•</button>
              <button class="action-btn" onclick="cleanStorage()">æ¸…ç†å­˜å‚¨</button>
              <button class="action-btn danger" onclick="deleteChatFromQQ()">åˆ é™¤èŠå¤©</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // åŠ è½½ä¸–ç•Œä¹¦API
      function loadWorldBookAPI() {
        try {
          // å¦‚æœä¸–ç•Œä¹¦APIä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿçš„API
          if (typeof window.getWorldBookEntriesForCharacter !== 'function') {
            // ä»localStorageåŠ è½½ä¸–ç•Œä¹¦æ•°æ®
            function loadWorldBookData() {
              const saved = localStorage.getItem('worldBookEntries');
              return saved ? JSON.parse(saved) : [];
            }

            // æ¨¡æ‹Ÿä¸–ç•Œä¹¦API
            window.getWorldBookEntriesForCharacter = function (characterType, keywords = []) {
              const worldBookEntries = loadWorldBookData();

              // è·å–å…¨å±€æ¡ç›®å’Œç‰¹å®šè§’è‰²çš„æ¡ç›®
              let relevantEntries = worldBookEntries.filter(
                entry => !entry.characterBinding || entry.characterBinding === characterType,
              );

              // å¦‚æœæä¾›äº†å…³é”®è¯ï¼Œè¿›ä¸€æ­¥è¿‡æ»¤
              if (keywords.length > 0) {
                relevantEntries = relevantEntries.filter(entry => {
                  const searchText = (entry.title + ' ' + entry.content + ' ' + entry.keywords.join(' ')).toLowerCase();
                  return keywords.some(keyword => searchText.includes(keyword.toLowerCase()));
                });
              }

              // æŒ‰ä¼˜å…ˆçº§æ’åº
              const priorityOrder = { high: 3, medium: 2, low: 1 };
              relevantEntries.sort((a, b) => priorityOrder[b.priority] - priorityOrder[a.priority]);

              return relevantEntries;
            };

            window.getAllWorldBookEntries = function () {
              return loadWorldBookData();
            };
          }
        } catch (error) {
          console.error('åŠ è½½ä¸–ç•Œä¹¦APIå¤±è´¥:', error);
        }
      }

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ä¸–ç•Œä¹¦API
      loadWorldBookAPI();

      // å…¨å±€å˜é‡åˆå§‹åŒ–æ£€æŸ¥å‡½æ•°
      function validateGlobalVariables() {
        // ç¡®ä¿æ¶ˆæ¯æ•°ç»„å·²åˆå§‹åŒ–
        if (!Array.isArray(messages)) {
          console.warn('æ¶ˆæ¯æ•°ç»„æœªæ­£ç¡®åˆå§‹åŒ–ï¼Œé‡æ–°åˆå§‹åŒ–');
          messages = [];
        }

        // ç¡®ä¿è®¾ç½®å¯¹è±¡å·²åˆå§‹åŒ–
        if (!currentSettings || typeof currentSettings !== 'object') {
          console.warn('è®¾ç½®å¯¹è±¡æœªæ­£ç¡®åˆå§‹åŒ–ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®');
          currentSettings = {
            userName: 'ç”¨æˆ·',
            userAvatar: 'ç”¨',
            aiName: 'AIåŠ©æ‰‹',
            aiAvatar: 'AI',
            soundEnabled: true,
            autoSave: true,
            worldBookEnabled: true,
          };
        }

        // ç¡®ä¿èŠå¤©ä¿¡æ¯å¯¹è±¡å·²åˆå§‹åŒ–
        if (!currentChatInfo || typeof currentChatInfo !== 'object') {
          console.warn('èŠå¤©ä¿¡æ¯æœªæ­£ç¡®åˆå§‹åŒ–ï¼Œä½¿ç”¨é»˜è®¤å€¼');
          currentChatInfo = {
            id: Date.now().toString(),
            name: 'AIåŠ©æ‰‹',
            avatar: 'AI',
            type: 'ai',
            status: 'åœ¨çº¿',
            createTime: new Date(),
          };
        }
      }

      // å…¨å±€å˜é‡
      let messages = [];
      let isAITyping = false;
      let pendingUserMessage = null; // å¾…å¤„ç†çš„ç”¨æˆ·æ¶ˆæ¯
      let lastAIResponse = null; // æœ€åä¸€æ¬¡AIå›å¤
      let currentChatInfo = {
        id: null,
        name: 'AIåŠ©æ‰‹',
        avatar: 'AI',
        type: 'ai',
        status: 'åœ¨çº¿',
        createTime: new Date(),
      };
      let currentSettings = {
        userName: 'ç”¨æˆ·',
        userAge: '',
        userHobby: '',
        userPersonality: '',
        userBackground: '',
        userAvatar: 'ç”¨',
        userAvatarFile: null, // ç”¨æˆ·å¤´åƒæ–‡ä»¶
        aiName: 'AIåŠ©æ‰‹',
        aiAge: '',
        aiHobby: '',
        aiPersonality: 'ä½ æ˜¯ä¸€ä¸ªå‹å–„ã€ä¸“ä¸šçš„AIåŠ©æ‰‹ï¼Œå–„äºç†è§£ç”¨æˆ·éœ€æ±‚å¹¶æä¾›æœ‰ç”¨çš„å¸®åŠ©ã€‚',
        aiBackground: 'æˆ‘æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹ï¼Œæ‹¥æœ‰å¹¿æ³›çš„çŸ¥è¯†èƒŒæ™¯ï¼ŒåŒ…æ‹¬ç§‘å­¦ã€æŠ€æœ¯ã€æ–‡å­¦ã€è‰ºæœ¯ç­‰å¤šä¸ªé¢†åŸŸã€‚',
        aiAvatar: 'AI',
        aiAvatarFile: null, // AIå¤´åƒæ–‡ä»¶
        autoSave: true,
        soundEnabled: true,
        worldBookEnabled: true, // é»˜è®¤å¯ç”¨ä¸–ç•Œä¹¦
      };

      // æ›´æ–°çŠ¶æ€æ æ—¶é—´
      function updateTime() {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const timeString = `${hours}:${minutes}`;

        const timeElement = document.getElementById('currentTime');
        if (timeElement) {
          timeElement.textContent = timeString;
        }
      }

      // åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', function () {
        // é¦–å…ˆæ£€æŸ¥å¹¶æ¸…ç†URIé•¿åº¦é—®é¢˜
        checkAndCleanURI();

        // ç«‹å³è¿›è¡Œå…¨å±€å˜é‡æ£€æŸ¥
        validateGlobalVariables();

        // ç«‹å³æ›´æ–°æ—¶é—´
        updateTime();

        // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ—¶é—´
        setInterval(updateTime, 60000);

        // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†ï¼Œå‡å°‘æ§åˆ¶å°é”™è¯¯ä¿¡æ¯å¯¹ç”¨æˆ·çš„å¹²æ‰°
        window.addEventListener('error', function (e) {
          // é™é»˜å¤„ç†ï¼Œä¸æ˜¾ç¤ºé”™è¯¯ç»™ç”¨æˆ·
          e.preventDefault();
        });

        window.addEventListener('unhandledrejection', function (e) {
          // é™é»˜å¤„ç†Promiseæ‹’ç»ï¼Œé˜²æ­¢æœªæ•è·çš„Promiseé”™è¯¯
          e.preventDefault();
        });

        // ç›‘å¬æ¥è‡ªè¡¨æƒ…åŒ…ç®¡ç†é¡µé¢çš„æ¶ˆæ¯
        window.addEventListener('message', function (e) {
          if (e.data && e.data.type === 'emojiSelected') {
            // ä»è¡¨æƒ…åŒ…ç®¡ç†é¡µé¢é€‰æ‹©è¡¨æƒ…åŒ…
            insertEmoji(e.data.src);
            closeEmojiManager();
          } else if (e.data && e.data.type === 'emojiUpdated') {
            // è¡¨æƒ…åŒ…åˆ—è¡¨æ›´æ–°ï¼Œåˆ·æ–°å½“å‰æ˜¾ç¤ºçš„è¡¨æƒ…åŒ…
            loadEmojisToPanel();
          }
        });

        // å…ˆåˆå§‹åŒ–èŠå¤©å‚æ•°ï¼Œå†åŠ è½½è®¾ç½®
        initFromQQParams();
        loadSettings();

        // é¡µé¢åŠ è½½æ—¶å¼ºåˆ¶æ¸…ç†ä»»ä½•æ®‹ç•™çš„è¾“å…¥æŒ‡ç¤ºå™¨
        setTimeout(() => {
          forceCleanTypingIndicator();
        }, 100);

        // æ·»åŠ åŒå‡»å¤´éƒ¨æ¸…ç†è¾“å…¥æŒ‡ç¤ºå™¨çš„åŠŸèƒ½
        const header = document.querySelector('.chat-header');
        if (header) {
          header.addEventListener('dblclick', function () {
            forceCleanTypingIndicator();
            alert('å·²æ¸…ç†AIè¾“å…¥çŠ¶æ€ï¼Œå‘é€æŒ‰é’®å·²æ¢å¤');
          });
        }

        // ç¡®ä¿é¢æ¿åˆå§‹çŠ¶æ€ä¸ºéšè—
        const settingsPanel = document.getElementById('settingsPanel');
        const chatInfoPanel = document.getElementById('chatInfoPanel');
        if (settingsPanel) settingsPanel.classList.remove('visible');
        if (chatInfoPanel) chatInfoPanel.style.display = 'none';

        // æ·»åŠ ä¿å­˜è®¾ç½®æŒ‰é’®çš„é¢å¤–äº‹ä»¶ç›‘å¬å™¨
        const saveBtn = document.getElementById('saveSettingsBtn');
        if (saveBtn) {
          saveBtn.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('ä¿å­˜æŒ‰é’®è¢«ç‚¹å‡»ï¼ˆäº‹ä»¶ç›‘å¬å™¨ï¼‰');
            saveSettings();
          });
        }

        loadChatHistory();
        initEventListeners();
        updateUI();

        // ä½¿ç”¨å»¶æ—¶ç¡®ä¿æ‰€æœ‰åŸºç¡€åˆå§‹åŒ–å®Œæˆåå†æ£€æŸ¥æ•°æ®
        setTimeout(() => {
          // ç¡®ä¿å†æ¬¡æ¸…ç†çŠ¶æ€
          forceCleanTypingIndicator();

          checkRedPacketData();
          checkTransferData();
          checkSelectedEmoji(); // æ£€æŸ¥é€‰ä¸­çš„è¡¨æƒ…åŒ…
          checkPendingImage(); // æ£€æŸ¥å¾…å‘é€çš„å›¾ç‰‡
        }, 100); // å¢åŠ å»¶è¿Ÿæ—¶é—´ç¡®ä¿åˆå§‹åŒ–å®Œæˆ

        // ç‹¬ç«‹çš„çº¢åŒ…æ•°æ®æ£€æŸ¥å‡½æ•°
        function checkRedPacketData() {
          const redPacketData = localStorage.getItem('redPacketData');

          if (redPacketData && currentChatInfo && currentChatInfo.id) {
            try {
              const data = JSON.parse(redPacketData);

              if (data.chatId && data.chatId === currentChatInfo.id) {
                const redPacketMessage = `ğŸ§§ ${data.bless}|${data.amount}`;

                addMessage('user', redPacketMessage);
                localStorage.removeItem('redPacketData');
              } else {
              }
            } catch (e) {
              console.error('è§£æçº¢åŒ…æ•°æ®å¤±è´¥:', e);
              localStorage.removeItem('redPacketData');
            }
          } else {
            if (!redPacketData) {
            }
            if (!currentChatInfo) {
            }
            if (!currentChatInfo?.id) {
            }
          }
        }

        // ç‹¬ç«‹çš„è½¬è´¦æ•°æ®æ£€æŸ¥å‡½æ•°
        function checkTransferData() {
          const transferData = localStorage.getItem('transferData');

          if (transferData && currentChatInfo && currentChatInfo.id) {
            try {
              const data = JSON.parse(transferData);

              if (data.chatId && data.chatId === currentChatInfo.id) {
                let transferMessage = `ğŸ’¸ å‘ä½ è½¬è´¦ ${data.amount}å…ƒ`;
                if (data.message && data.message !== 'è½¬è´¦') {
                  transferMessage += ` - ${data.message}`;
                }

                addMessage('user', transferMessage);
                localStorage.removeItem('transferData');
              } else {
              }
            } catch (e) {
              console.error('è§£æè½¬è´¦æ•°æ®å¤±è´¥:', e);
              localStorage.removeItem('transferData');
            }
          } else {
            if (!transferData) {
            }
            if (!currentChatInfo) {
            }
            if (!currentChatInfo?.id) {
            }
          }
        }

        // æ£€æŸ¥æ˜¯å¦ä»çº¢åŒ…é¡µé¢è¿”å›ï¼Œå¦‚æœæ˜¯åˆ™å†æ¬¡æ£€æŸ¥çº¢åŒ…æ•°æ®
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('fromRedPacket')) {
          setTimeout(() => {
            checkRedPacketData();
          }, 200);
        }

        // æ£€æŸ¥æ˜¯å¦ä»è½¬è´¦é¡µé¢è¿”å›ï¼Œå¦‚æœæ˜¯åˆ™å†æ¬¡æ£€æŸ¥è½¬è´¦æ•°æ®
        if (urlParams.get('fromTransfer')) {
          setTimeout(() => {
            checkTransferData();
          }, 200);
        }

        // æ£€æŸ¥æ˜¯å¦ä»å›¾ç‰‡é¡µé¢è¿”å›
        if (
          urlParams.get('fromImage') ||
          localStorage.getItem('pendingImage') ||
          localStorage.getItem('selectedImage')
        ) {
          setTimeout(() => {
            checkPendingImage();
            // é¢å¤–çš„çŠ¶æ€æ¢å¤
            setTimeout(() => {
              forceCleanTypingIndicator();
              const sendBtn = document.getElementById('sendBtn');
              const messageInput = document.getElementById('messageInput');
              if (sendBtn && messageInput) {
                sendBtn.disabled = !messageInput.value.trim();
              }
            }, 300);
          }, 250);
        }

        // å¼ºåˆ¶å†æ¬¡åŒæ­¥AIè®¾ç½®åˆ°ç•Œé¢æ˜¾ç¤º
        setTimeout(() => {
          if (currentChatInfo.type === 'ai' && currentSettings.aiName) {
            currentChatInfo.name = currentSettings.aiName;

            document.getElementById('chatName').textContent = currentChatInfo.name;
            updateChatInfoDisplay();
          }
        }, 100);
      });

      // ç›‘å¬é¡µé¢ç„¦ç‚¹äº‹ä»¶ï¼Œç”¨äºä»APIè®¾ç½®é¡µé¢è¿”å›æ—¶æ›´æ–°çŠ¶æ€
      window.addEventListener('focus', function () {
        checkAPIStatus();

        // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„è¡¨æƒ…åŒ…ï¼ˆä»è¡¨æƒ…åŒ…ç®¡ç†é¡µé¢è¿”å›æ—¶ï¼‰
        checkSelectedEmoji();

        // æ£€æŸ¥æ˜¯å¦æœ‰çº¢åŒ…æ•°æ®ï¼ˆä»çº¢åŒ…é¡µé¢è¿”å›æ—¶ï¼‰
        const redPacketData = localStorage.getItem('redPacketData');

        if (redPacketData) {
          try {
            const data = JSON.parse(redPacketData);

            if (data.chatId && data.chatId === currentChatInfo.id) {
              const redPacketMessage = `ğŸ§§ ${data.bless}|${data.amount}`;
              addMessage('user', redPacketMessage);
              localStorage.removeItem('redPacketData');
            } else {
            }
          } catch (e) {
            console.error('ç„¦ç‚¹äº‹ä»¶ - è§£æçº¢åŒ…æ•°æ®å¤±è´¥:', e);
            localStorage.removeItem('redPacketData');
          }
        }
      }); // ç›‘å¬localStorageå˜åŒ–ï¼Œå®æ—¶æ›´æ–°APIçŠ¶æ€
      window.addEventListener('storage', function (e) {
        if (e.key === 'apiSettings') {
          checkAPIStatus();
        }
      });

      // æ£€æŸ¥å¹¶æ¸…ç†å¯èƒ½å¯¼è‡´URIè¿‡é•¿çš„é—®é¢˜
      function checkAndCleanURI() {
        try {
          // æ£€æŸ¥URLé•¿åº¦
          if (window.location.href.length > 2000) {
            console.warn('URLè¿‡é•¿ï¼Œè‡ªåŠ¨æ¸…ç†ï¼š', window.location.href.length, 'å­—ç¬¦');
            const baseUrl = window.location.pathname;
            window.history.replaceState({}, '', baseUrl);
            return true;
          }

          // æ£€æŸ¥localStorageä¸­æ˜¯å¦æœ‰è¶…å¤§æ•°æ®
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            const value = localStorage.getItem(key);
            if (value && value.length > 1000000) {
              // 1MB
              console.warn('å‘ç°è¶…å¤§localStorageæ•°æ®ï¼š', key, value.length, 'å­—ç¬¦');
              // å¯ä»¥é€‰æ‹©æ€§åœ°æ¸…ç†æˆ–å‹ç¼©æ•°æ®
            }
          }
        } catch (e) {
          console.error('URIæ¸…ç†æ£€æŸ¥å¤±è´¥:', e);
        }
        return false;
      }

      // ä»QQç•Œé¢ä¼ é€’çš„å‚æ•°åˆå§‹åŒ–
      function initFromQQParams() {
        // æ¸…ç†URLï¼Œé˜²æ­¢URIè¿‡é•¿é”™è¯¯
        if (window.location.search.length > 2000) {
          console.warn('URLå‚æ•°è¿‡é•¿ï¼Œæ¸…ç†URL');
          const baseUrl = window.location.pathname;
          window.history.replaceState({}, '', baseUrl);
          return;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const chatId = urlParams.get('chatId');
        const chatName = urlParams.get('chatName');
        const chatAvatar = urlParams.get('chatAvatar');
        const chatAvatarFile = urlParams.get('chatAvatarFile');
        const chatType = urlParams.get('type');

        console.log('initFromQQParams - URLå‚æ•°:', {
          chatId,
          chatName,
          chatAvatar,
          chatAvatarFile,
          chatType,
        });

        if (chatId) {
          currentChatInfo = {
            id: chatId,
            name: decodeURIComponent(chatName || 'æœªçŸ¥è”ç³»äºº'),
            avatar: decodeURIComponent(chatAvatar || '?'),
            avatarFile: chatAvatarFile ? decodeURIComponent(chatAvatarFile) : '',
            type: chatType || 'friend',
            status: chatType === 'ai' ? 'åœ¨çº¿' : 'æœ€åä¸Šçº¿åˆšåˆš',
            createTime: new Date(),
          };

          // å¦‚æœæ˜¯AIèŠå¤©ï¼Œä¼˜å…ˆä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„AIåç§°å’Œå¤´åƒ
          if (chatType === 'ai') {
            const saved = localStorage.getItem('chatSettings');

            if (saved) {
              const settings = JSON.parse(saved);

              if (settings.aiName) {
                currentChatInfo.name = settings.aiName;
              }

              // å¤„ç†å¤´åƒä¿¡æ¯ - ä¼˜å…ˆä½¿ç”¨URLä¼ é€’çš„å¤´åƒæ–‡ä»¶ï¼Œç„¶åæ˜¯è®¾ç½®ä¸­çš„å¤´åƒ
              if (chatAvatarFile) {
                // URLä¸­å·²æœ‰å¤´åƒæ–‡ä»¶ï¼Œä¿æŒä¸å˜
              } else if (settings.aiAvatarFile) {
                currentChatInfo.avatarFile = settings.aiAvatarFile;
                currentChatInfo.avatar = '';
              } else if (settings.aiAvatar) {
                currentChatInfo.avatar = settings.aiAvatar;
                currentChatInfo.avatarFile = '';
              } else {
                // å¼ºåˆ¶é‡æ–°ç”Ÿæˆå¤´åƒå­—æ¯ï¼Œä¸ä½¿ç”¨URLä¼ é€’çš„å€¼
                currentChatInfo.avatar = settings.aiName ? settings.aiName.charAt(0) : 'AI';
                currentChatInfo.avatarFile = '';
                console.log(
                  'initFromQQParams - é‡æ–°ç”ŸæˆAIå¤´åƒå­—æ¯:',
                  currentChatInfo.avatar,
                  'æ¥æºåç§°:',
                  settings.aiName,
                );
              }
            }
          }

          // æ›´æ–°ç•Œé¢æ˜¾ç¤º
          updateChatInfoDisplay();
        }
      }

      // æ›´æ–°èŠå¤©ä¿¡æ¯æ˜¾ç¤º
      function updateChatInfoDisplay() {
        // æ›´æ–°é¡¶éƒ¨å¤´åƒ
        const chatAvatarEl = document.getElementById('chatAvatar');
        if (currentChatInfo.avatarFile) {
          chatAvatarEl.innerHTML = `<img src="${currentChatInfo.avatarFile}" alt="${currentChatInfo.name}å¤´åƒ" style="width: 100%; height: 100%; object-fit: cover; border-radius: inherit;" />`;
        } else {
          chatAvatarEl.textContent = currentChatInfo.avatar;
        }

        // æ›´æ–°èŠå¤©ä¿¡æ¯é¢æ¿å¤´åƒ
        const infoAvatarEl = document.getElementById('infoAvatar');
        if (currentChatInfo.avatarFile) {
          infoAvatarEl.innerHTML = `<img src="${currentChatInfo.avatarFile}" alt="${currentChatInfo.name}å¤´åƒ" style="width: 100%; height: 100%; object-fit: cover; border-radius: inherit;" />`;
        } else {
          infoAvatarEl.textContent = currentChatInfo.avatar;
        }

        document.getElementById('chatName').textContent = currentChatInfo.name;
        document.getElementById('chatStatus').textContent = currentChatInfo.status;
        document.getElementById('infoName').textContent = currentChatInfo.name;
        document.getElementById('infoStatus').textContent = currentChatInfo.status;

        document.getElementById('chatType').textContent =
          currentChatInfo.type === 'ai' ? 'AIå¯¹è¯' : currentChatInfo.type === 'group' ? 'ç¾¤èŠ' : 'ç§èŠ';
        document.getElementById('createTime').textContent = formatTime(currentChatInfo.createTime);

        // è®¾ç½®å¤´åƒé¢œè‰²
        const avatarColor = getAvatarColor(currentChatInfo.name);
        document.getElementById('chatAvatar').style.background = avatarColor;
        document.getElementById('infoAvatar').style.background = avatarColor;
      }

      // è·å–å¤´åƒé¢œè‰²
      function getAvatarColor(name) {
        const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#a8edea', '#ff9a9e'];
        const hash = name.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
        return colors[hash % colors.length];
      }

      // è¿”å›QQç•Œé¢
      function goBackToQQ() {
        // ä¿å­˜å½“å‰èŠå¤©è®°å½•
        if (currentSettings.autoSave) {
          saveChatHistory();
        }

        // è·³è½¬å›QQç•Œé¢
        window.location.href = './qq.html';
      }

      // æ˜¾ç¤ºèŠå¤©ä¿¡æ¯
      function showChatInfo() {
        toggleChatInfo();
      }

      // åˆ‡æ¢èŠå¤©ä¿¡æ¯é¢æ¿
      function toggleChatInfo() {
        const panel = document.getElementById('chatInfoPanel');
        const isVisible = panel.style.display === 'flex';

        // å…³é—­åŠŸèƒ½å¡ç‰‡
        hideFunctionCard();

        if (isVisible) {
          panel.style.display = 'none';
        } else {
          // éšè—è®¾ç½®é¢æ¿
          document.getElementById('settingsPanel').style.display = 'none';

          // æ›´æ–°æ¶ˆæ¯è®¡æ•°
          const messageCountElement = document.getElementById('messageCount');
          if (messageCountElement && Array.isArray(messages)) {
            messageCountElement.textContent = messages.length + 'æ¡';
          }

          // æ˜¾ç¤ºèŠå¤©ä¿¡æ¯é¢æ¿
          panel.style.display = 'flex';
        }
      }

      // æ¸…ç©ºèŠå¤©è®°å½•
      function clearChatHistory() {
        if (showConfirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
          messages = [];
          saveChatHistory();

          // æ¸…ç©ºæ¶ˆæ¯æ˜¾ç¤º
          const messagesArea = document.getElementById('messagesArea');
          messagesArea.innerHTML = `
            <div class="message received">
              <div class="message-avatar">${currentChatInfo.avatar}</div>
              <div>
                <div class="message-bubble">èŠå¤©è®°å½•å·²æ¸…ç©º</div>
                <div class="message-time">åˆšåˆš</div>
              </div>
            </div>
          `;

          // æ›´æ–°æ¶ˆæ¯è®¡æ•°
          document.getElementById('messageCount').textContent = '0æ¡';

          showToast('èŠå¤©è®°å½•å·²æ¸…ç©º');
        }
      }

      // ä»QQä¸­åˆ é™¤èŠå¤©
      function deleteChatFromQQ() {
        if (showConfirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèŠå¤©å—ï¼ŸèŠå¤©è®°å½•ä¹Ÿä¼šè¢«åˆ é™¤ã€‚')) {
          // æ¸…é™¤localStorageä¸­çš„èŠå¤©è®°å½•
          localStorage.removeItem(`chatHistory_${currentChatInfo.id}`);

          // è¿”å›QQç•Œé¢
          showToast('èŠå¤©å·²åˆ é™¤');
          setTimeout(() => {
            goBackToQQ();
          }, 1500);
        }
      }

      // æ¸…ç†å­˜å‚¨ç©ºé—´
      function cleanStorage() {
        if (showConfirm('ç¡®å®šè¦æ¸…ç†å­˜å‚¨ç©ºé—´å—ï¼Ÿè¿™å°†åˆ é™¤è¿‡å¤§çš„æ•°æ®å’Œæ—§çš„èŠå¤©è®°å½•ã€‚')) {
          let cleanedItems = 0;
          let freedSpace = 0;

          try {
            // æ£€æŸ¥æ‰€æœ‰localStorageé¡¹ç›®
            const keysToCheck = [];
            for (let i = 0; i < localStorage.length; i++) {
              keysToCheck.push(localStorage.key(i));
            }

            keysToCheck.forEach(key => {
              try {
                const value = localStorage.getItem(key);
                if (value) {
                  // æ¸…ç†è¶…å¤§æ•°æ® (>1MB)
                  if (value.length > 1000000) {
                    freedSpace += value.length;
                    localStorage.removeItem(key);
                    cleanedItems++;
                    console.log('æ¸…ç†è¶…å¤§æ•°æ®:', key, value.length);
                  }
                  // æ¸…ç†æ—§çš„èŠå¤©è®°å½•ï¼ˆä¿ç•™æœ€è¿‘çš„ï¼‰
                  else if (key.startsWith('chatHistory_') && value.length > 500000) {
                    try {
                      const messages = JSON.parse(value);
                      if (Array.isArray(messages) && messages.length > 100) {
                        const recentMessages = messages.slice(-50);
                        localStorage.setItem(key, JSON.stringify(recentMessages));
                        freedSpace += value.length - JSON.stringify(recentMessages).length;
                        cleanedItems++;
                        console.log('æ¸…ç†èŠå¤©è®°å½•:', key, messages.length, '->', recentMessages.length);
                      }
                    } catch (e) {
                      // å¦‚æœè§£æå¤±è´¥ï¼Œç›´æ¥åˆ é™¤
                      localStorage.removeItem(key);
                      freedSpace += value.length;
                      cleanedItems++;
                    }
                  }
                }
              } catch (e) {
                console.error('æ¸…ç†é¡¹ç›®å¤±è´¥:', key, e);
              }
            });

            if (cleanedItems > 0) {
              showToast(`å·²æ¸…ç† ${cleanedItems} ä¸ªé¡¹ç›®ï¼Œé‡Šæ”¾çº¦ ${Math.round(freedSpace / 1024)} KB ç©ºé—´`);
            } else {
              showToast('å­˜å‚¨ç©ºé—´è‰¯å¥½ï¼Œæ— éœ€æ¸…ç†');
            }
          } catch (e) {
            console.error('å­˜å‚¨æ¸…ç†å¤±è´¥:', e);
            showToast('æ¸…ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
          }
        }
      }

      // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
      function showConfirm(message) {
        return confirm(message); // ç®€å•å®ç°ï¼Œå¯ä»¥åç»­æ”¹ä¸ºè‡ªå®šä¹‰å¼¹çª—
      }

      // åˆ‡æ¢åŠŸèƒ½æŒ‰é’®åŒºåŸŸ
      function toggleFunctionButtons() {
        const buttons = document.getElementById('functionButtons');
        const expandBtn = document.getElementById('expandBtn');
        const isVisible = buttons.classList.contains('show');

        if (isVisible) {
          buttons.classList.remove('show');
          expandBtn.textContent = 'â•';
        } else {
          buttons.classList.add('show');
          expandBtn.textContent = 'â–';
        }
      }

      // æ¶ˆæ¯åˆ é™¤ç›¸å…³å˜é‡
      let messageTouchTimer = null;
      let isMessageLongPress = false;
      let isDeleteMode = false; // åˆ é™¤æ¨¡å¼æ ‡å¿—
      let swipeState = {
        messageId: null,
        startX: 0,
        startY: 0,
        currentX: 0,
        currentY: 0,
        isDragging: false,
        element: null,
      };

      // åˆ‡æ¢åˆ é™¤æ¨¡å¼
      function toggleDeleteMode() {
        isDeleteMode = !isDeleteMode;
        const deleteBtn = document.getElementById('deleteToggleBtn');
        const messagesArea = document.getElementById('messagesArea');

        if (isDeleteMode) {
          // è¿›å…¥åˆ é™¤æ¨¡å¼
          deleteBtn.classList.add('delete-mode-active');
          deleteBtn.title = 'é€€å‡ºåˆ é™¤æ¨¡å¼';
          messagesArea.classList.add('delete-mode');

          // ä¸ºæ‰€æœ‰æ¶ˆæ¯æ·»åŠ åˆ é™¤å‰å·
          const messages = document.querySelectorAll('.message');
          messages.forEach(message => {
            if (!message.querySelector('.message-delete-cross')) {
              const deleteX = document.createElement('div');
              deleteX.className = 'message-delete-cross';
              deleteX.innerHTML = 'Ã—';
              deleteX.onclick = e => {
                e.stopPropagation();
                const messageId = message.getAttribute('data-message-id');
                quickDeleteMessage(messageId);
              };
              message.appendChild(deleteX);
            }
          });

          // æŒ¯åŠ¨åé¦ˆ
          if (navigator.vibrate) {
            navigator.vibrate(30);
          }
        } else {
          // é€€å‡ºåˆ é™¤æ¨¡å¼
          deleteBtn.classList.remove('delete-mode-active');
          deleteBtn.title = 'åˆ é™¤æ¨¡å¼';
          messagesArea.classList.remove('delete-mode');

          // ç§»é™¤æ‰€æœ‰åˆ é™¤å‰å·
          const deleteXs = document.querySelectorAll('.message-delete-cross');
          deleteXs.forEach(x => x.remove());
        }
      }

      // å¿«é€Ÿåˆ é™¤æ¶ˆæ¯ï¼ˆåˆ é™¤æ¨¡å¼ä¸‹ä½¿ç”¨ï¼‰
      function quickDeleteMessage(messageId) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
          const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
          if (messageEl) {
            // åˆ é™¤åŠ¨ç”»
            messageEl.style.transform = 'scale(0)';
            messageEl.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
            messageEl.style.opacity = '0';

            // æŒ¯åŠ¨åé¦ˆ
            if (navigator.vibrate) {
              navigator.vibrate(30);
            }

            setTimeout(() => {
              messageEl.remove();

              // ä»æ•°ç»„ä¸­ç§»é™¤ - å¤„ç†å†å²æ¶ˆæ¯IDæ ¼å¼
              const realId = messageId.toString().replace('history_', '');
              messages = messages.filter(msg => {
                return msg.id != messageId && msg.id != realId && `history_${msg.id}` != messageId;
              });

              // æ›´æ–°æœ¬åœ°å­˜å‚¨ - ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„ä¿å­˜å‡½æ•°
              saveChatHistory();
            }, 300);
          }
        }
      }

      // æ˜¾ç¤ºæ¶ˆæ¯åˆ é™¤æŒ‰é’®
      function showMessageDeleteButton(messageId, event) {
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }

        // éšè—æ‰€æœ‰å…¶ä»–åˆ é™¤æŒ‰é’®
        document.querySelectorAll('.message').forEach(msg => {
          msg.classList.remove('show-delete');
        });

        // æ˜¾ç¤ºå½“å‰æ¶ˆæ¯çš„åˆ é™¤æŒ‰é’®
        const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageEl) {
          messageEl.classList.add('show-delete');
        }

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—åˆ é™¤æŒ‰é’®
        setTimeout(() => {
          document.addEventListener('click', hideMessageDeleteButtons, { once: true });
        }, 100);
      }

      // éšè—æ‰€æœ‰æ¶ˆæ¯åˆ é™¤æŒ‰é’®
      function hideMessageDeleteButtons() {
        document.querySelectorAll('.message').forEach(msg => {
          msg.classList.remove('show-delete');
        });
      }

      // æ¶ˆæ¯è§¦æ‘¸å¼€å§‹
      function handleMessageTouchStart(messageId, event) {
        isMessageLongPress = false;
        const touch = event.touches[0];

        // åˆå§‹åŒ–æ»‘åŠ¨çŠ¶æ€
        swipeState.messageId = messageId;
        swipeState.startX = touch.clientX;
        swipeState.startY = touch.clientY;
        swipeState.currentX = touch.clientX;
        swipeState.currentY = touch.clientY;
        swipeState.isDragging = false;
        swipeState.element = event.target.closest('.message');

        // é•¿æŒ‰æ˜¾ç¤ºåˆ é™¤æŒ‰é’®çš„å®šæ—¶å™¨
        messageTouchTimer = setTimeout(() => {
          if (!swipeState.isDragging) {
            isMessageLongPress = true;
            showMessageDeleteButton(messageId, event);
            if (navigator.vibrate) {
              navigator.vibrate(50);
            }
          }
        }, 500);
      }

      // æ¶ˆæ¯è§¦æ‘¸ç§»åŠ¨
      function handleMessageTouchMove(messageId, event) {
        if (!swipeState.element || swipeState.messageId !== messageId) return;

        const touch = event.touches[0];
        swipeState.currentX = touch.clientX;
        swipeState.currentY = touch.clientY;

        const deltaX = swipeState.currentX - swipeState.startX;
        const deltaY = swipeState.currentY - swipeState.startY;

        // åˆ¤æ–­æ˜¯å¦å¼€å§‹æ»‘åŠ¨ï¼ˆæ°´å¹³æ»‘åŠ¨è·ç¦»å¤§äºå‚ç›´æ»‘åŠ¨è·ç¦»ï¼Œä¸”è¶…è¿‡é˜ˆå€¼ï¼‰
        if (Math.abs(deltaX) > 10 && Math.abs(deltaX) > Math.abs(deltaY)) {
          if (!swipeState.isDragging) {
            swipeState.isDragging = true;
            // å–æ¶ˆé•¿æŒ‰è®¡æ—¶å™¨
            if (messageTouchTimer) {
              clearTimeout(messageTouchTimer);
              messageTouchTimer = null;
            }
            event.preventDefault();
          }

          // åªå…è®¸å‘å·¦æ»‘åŠ¨ï¼ˆåˆ é™¤ï¼‰
          const translateX = Math.min(0, deltaX);
          const maxTranslate = -80; // æœ€å¤§æ»‘åŠ¨è·ç¦»
          const finalTranslate = Math.max(maxTranslate, translateX);

          // åº”ç”¨å˜æ¢
          swipeState.element.style.transform = `translateX(${finalTranslate}px)`;
          swipeState.element.style.transition = 'none';

          // æ˜¾ç¤ºåˆ é™¤åŒºåŸŸçš„é€æ˜åº¦
          const opacity = Math.abs(finalTranslate) / Math.abs(maxTranslate);
          swipeState.element.style.background = `rgba(255, 59, 48, ${opacity * 0.1})`;
        }
      }

      // æ¶ˆæ¯è§¦æ‘¸ç»“æŸ
      function handleMessageTouchEnd(messageId, event) {
        if (messageTouchTimer) {
          clearTimeout(messageTouchTimer);
        }

        if (swipeState.isDragging && swipeState.element && swipeState.messageId === messageId) {
          const deltaX = swipeState.currentX - swipeState.startX;
          const threshold = -60; // åˆ é™¤é˜ˆå€¼

          if (deltaX < threshold) {
            // æ»‘åŠ¨è·ç¦»è¶³å¤Ÿï¼Œæ‰§è¡Œåˆ é™¤
            swipeDeleteMessage(messageId);
          } else {
            // æ»‘åŠ¨è·ç¦»ä¸å¤Ÿï¼Œå¼¹å›åŸä½
            swipeState.element.style.transform = 'translateX(0)';
            swipeState.element.style.transition = 'transform 0.3s ease';
            swipeState.element.style.background = '';

            // æ¸…ç†è¿‡æ¸¡æ•ˆæœ
            setTimeout(() => {
              if (swipeState.element) {
                swipeState.element.style.transition = '';
              }
            }, 300);
          }

          // é‡ç½®æ»‘åŠ¨çŠ¶æ€
          swipeState = {
            messageId: null,
            startX: 0,
            startY: 0,
            currentX: 0,
            currentY: 0,
            isDragging: false,
            element: null,
          };
        }

        if (isMessageLongPress) {
          event.preventDefault();
          event.stopPropagation();
        }
      }

      // æ»‘åŠ¨åˆ é™¤æ¶ˆæ¯
      function swipeDeleteMessage(messageId) {
        const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageEl) {
          // æ»‘åŠ¨åˆ é™¤åŠ¨ç”»
          messageEl.style.transform = 'translateX(-100%)';
          messageEl.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
          messageEl.style.opacity = '0';

          // æŒ¯åŠ¨åé¦ˆ
          if (navigator.vibrate) {
            navigator.vibrate(30);
          }

          setTimeout(() => {
            // ä»ç•Œé¢ç§»é™¤
            messageEl.remove();

            // ä»æ•°ç»„ä¸­ç§»é™¤ - å¤„ç†å†å²æ¶ˆæ¯IDæ ¼å¼
            const realId = messageId.toString().replace('history_', '');
            messages = messages.filter(msg => {
              return msg.id != messageId && msg.id != realId && `history_${msg.id}` != messageId;
            });

            // æ›´æ–°æœ¬åœ°å­˜å‚¨
            saveChatHistory();
          }, 300);
        }
      }

      // åˆ é™¤æ¶ˆæ¯
      function deleteMessage(messageId, event) {
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }

        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
          // ä»ç•Œé¢ç§»é™¤
          const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
          if (messageEl) {
            messageEl.remove();
          }

          // ä»æ•°ç»„ä¸­ç§»é™¤ - å¤„ç†å†å²æ¶ˆæ¯IDæ ¼å¼
          const realId = messageId.toString().replace('history_', '');
          messages = messages.filter(msg => {
            return msg.id != messageId && msg.id != realId && `history_${msg.id}` != messageId;
          });

          // ä¿å­˜èŠå¤©è®°å½•
          saveChatHistory();

          showToast('æ¶ˆæ¯å·²åˆ é™¤');
        }
      }

      // å‘é€çº¢åŒ…
      // è·³è½¬åˆ°çº¢åŒ…é¡µé¢ï¼Œå¸¦ä¸ŠchatIdå‚æ•°
      function sendRedPacket() {
        if (!currentChatInfo.id) {
          console.error('é”™è¯¯ï¼šæ²¡æœ‰æœ‰æ•ˆçš„chatId');
          alert('é”™è¯¯ï¼šèŠå¤©IDæ— æ•ˆ');
          return;
        }

        const url = 'redpacket.html?chatId=' + encodeURIComponent(currentChatInfo.id);

        window.location.href = url;
      }

      // å‘é€è½¬è´¦
      function sendTransfer() {
        const chatId = currentChatInfo ? currentChatInfo.id : '';

        const url = 'zhuanzhang.html' + (chatId ? '?chatId=' + encodeURIComponent(chatId) : '');

        window.location.href = url;
      }

      // å‘é€å›¾ç‰‡
      function sendImage() {
        // æ„å»ºè·³è½¬URLï¼Œä¼ é€’å½“å‰èŠå¤©ä¿¡æ¯
        const params = new URLSearchParams({
          chatId: currentChatInfo.id || 'default',
          chatName: currentChatInfo.name || 'èŠå¤©',
          chatAvatar: currentChatInfo.avatar || 'AI',
        });

        // è·³è½¬åˆ°å›¾ç‰‡å‘é€é¡µé¢
        window.location.href = `./tupian.html?${params.toString()}`;
      }

      // æ˜¾ç¤ºæ“ä½œæç¤º
      function showToast(message) {
        // åˆ›å»ºæç¤ºå…ƒç´ 
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 12px 24px;
          border-radius: 20px;
          font-size: 14px;
          z-index: 10000;
          backdrop-filter: blur(10px);
          transition: opacity 0.3s ease;
        `;
        toast.textContent = message;

        document.body.appendChild(toast);

        // è‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
          toast.style.opacity = '0';
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 300);
        }, 2000);
      }

      // ========== è¡¨æƒ…åŒ…åŠŸèƒ½ ==========

      // æ‰“å¼€è¡¨æƒ…åŒ…é¢æ¿
      function openEmojiPanel() {
        const panel = document.getElementById('emojiPanel');
        const grid = document.getElementById('emojiGrid');
        const emptyDiv = document.getElementById('emojiEmpty');

        // åŠ è½½è¡¨æƒ…åŒ…
        const emojis = JSON.parse(localStorage.getItem('customEmojis') || '[]');

        if (emojis.length === 0) {
          grid.style.display = 'none';
          emptyDiv.style.display = 'block';
        } else {
          grid.style.display = 'grid';
          emptyDiv.style.display = 'none';

          // æ¸…ç©ºç°æœ‰å†…å®¹
          grid.innerHTML = '';

          // æ·»åŠ è¡¨æƒ…åŒ…
          emojis.forEach(emoji => {
            const item = document.createElement('div');
            item.className = 'emoji-item';
            item.innerHTML = `<img src="${emoji.src}" alt="${emoji.name}" onerror="this.parentElement.style.display='none'">`;

            item.addEventListener('click', function () {
              insertEmoji(emoji.src);
              closeEmojiPanel();
            });

            grid.appendChild(item);
          });
        }

        panel.style.display = 'block';
        hideFunctionCard();
      }

      // å…³é—­è¡¨æƒ…åŒ…é¢æ¿
      function closeEmojiPanel() {
        document.getElementById('emojiPanel').style.display = 'none';
      }

      // æ‰“å¼€è¡¨æƒ…åŒ…ç®¡ç†é¡µé¢
      function openEmojiManager() {
        // å…³é—­è¡¨æƒ…åŒ…é€‰æ‹©é¢æ¿
        closeEmojiPanel();

        // åˆ›å»ºè¡¨æƒ…åŒ…ç®¡ç†å¼¹çª—
        const managerHtml = `
          <div id="emojiManagerOverlay" style="
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
          ">
            <div style="
              background: white;
              border-radius: 16px;
              width: 100%;
              max-width: 450px;
              max-height: 85vh;
              overflow: hidden;
              position: relative;
              margin: auto;
            ">
              <div style="
                padding: 12px 16px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                font-weight: 600;
                display: flex;
                justify-content: space-between;
                align-items: center;
                min-height: 40px;
              ">
                <span>è¡¨æƒ…åŒ…ç®¡ç†</span>
                <button onclick="closeEmojiManager()" style="
                  background: none;
                  border: none;
                  color: white;
                  font-size: 18px;
                  cursor: pointer;
                  padding: 0;
                  width: 24px;
                  height: 24px;
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                ">Ã—</button>
              </div>
              <iframe src="biaoqingbao.html${window.location.search}" style="
                width: 100%;
                height: calc(85vh - 60px);
                max-height: 500px;
                border: none;
                display: block;
              "></iframe>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', managerHtml);

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        document.getElementById('emojiManagerOverlay').addEventListener('click', function (e) {
          if (e.target === this) {
            closeEmojiManager();
          }
        });
      }

      function closeEmojiManager() {
        const overlay = document.getElementById('emojiManagerOverlay');
        if (overlay) {
          overlay.remove();
        }
      }

      // æ’å…¥è¡¨æƒ…åŒ…åˆ°èŠå¤©
      function insertEmoji(src) {
        // åˆ›å»ºè¡¨æƒ…åŒ…æ¶ˆæ¯
        addMessage('user', `[è¡¨æƒ…åŒ…:${src}]`);

        // ä¿å­˜èŠå¤©è®°å½•
        if (currentSettings.autoSave) {
          saveChatHistory();
        }

        // è§¦å‘AIå›å¤ï¼ˆå¦‚æœåœ¨AIèŠå¤©ä¸­ï¼‰
        if (currentChatInfo.type === 'ai') {
          pendingUserMessage = `[è¡¨æƒ…åŒ…:${src}]`;
          const functionBtn = document.getElementById('functionBtn');
          functionBtn.classList.add('active');
          functionBtn.title = 'è¯·é€‰æ‹©AIå›å¤æ–¹å¼';
        }

        toggleFunctionButtons();
      }

      // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„è¡¨æƒ…åŒ…ï¼ˆä»è¡¨æƒ…åŒ…ç®¡ç†é¡µé¢è¿”å›æ—¶ï¼‰
      function checkSelectedEmoji() {
        const selectedEmoji = localStorage.getItem('selectedEmoji');
        if (selectedEmoji) {
          try {
            const emoji = JSON.parse(selectedEmoji);
            insertEmoji(emoji.src);
            localStorage.removeItem('selectedEmoji');
          } catch (e) {
            console.error('è§£æé€‰ä¸­çš„è¡¨æƒ…åŒ…å¤±è´¥:', e);
          }
        }
      }

      // å½»åº•é‡ç½®èŠå¤©çŠ¶æ€ï¼ˆç”¨äºå›¾ç‰‡å‘é€åæ¢å¤ï¼‰
      function resetChatState() {
        // é‡ç½®æ‰€æœ‰å…³é”®å˜é‡
        isAITyping = false;
        pendingUserMessage = null;

        // æ¸…ç†æ‰€æœ‰AIè¾“å…¥æŒ‡ç¤ºå™¨
        const indicators = document.querySelectorAll('#typingIndicator, .typing-indicator-message');
        indicators.forEach(indicator => {
          indicator.remove();
        });

        // é‡ç½®æŒ‰é’®çŠ¶æ€
        const sendBtn = document.getElementById('sendBtn');
        const messageInput = document.getElementById('messageInput');
        const functionBtn = document.getElementById('functionBtn');

        if (sendBtn && messageInput) {
          sendBtn.disabled = !messageInput.value.trim();
        }

        if (functionBtn) {
          functionBtn.classList.remove('active');
          functionBtn.title = 'æ›´å¤šåŠŸèƒ½';
        }

        // éšè—åŠŸèƒ½å¡ç‰‡
        const functionCard = document.getElementById('functionCard');
        if (functionCard) {
          functionCard.style.display = 'none';
        }
      }

      // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å‘é€çš„å›¾ç‰‡ï¼ˆä»å›¾ç‰‡å‘é€é¡µé¢è¿”å›æ—¶ï¼‰
      function checkPendingImage() {
        const pendingImage = localStorage.getItem('pendingImage');
        const selectedImage = localStorage.getItem('selectedImage'); // æ–°å¢ï¼šç…§æ¬è¡¨æƒ…åŒ…é€»è¾‘

        // ä¼˜å…ˆå¤„ç†æ–°çš„ selectedImageï¼Œç„¶åæ˜¯æ—§çš„ pendingImage
        const imageData = selectedImage || pendingImage;
        if (imageData) {
          try {
            const parsedImageData = JSON.parse(imageData);

            // ç¡®ä¿åœ¨å¤„ç†å›¾ç‰‡å‰æ¸…ç†ä»»ä½•AIè¾“å…¥çŠ¶æ€

            hideTypingIndicator();
            forceCleanTypingIndicator();

            // åˆ›å»ºå›¾ç‰‡æ¶ˆæ¯
            const imageMessage = {
              type: 'image',
              fileName: parsedImageData.fileName,
              fileSize: parsedImageData.fileSize,
              fileType: parsedImageData.fileType,
              base64: parsedImageData.base64,
              options: parsedImageData.options || {},
              timestamp: parsedImageData.timestamp,
            };

            // æ·»åŠ å›¾ç‰‡æ¶ˆæ¯åˆ°èŠå¤©
            addImageMessage('user', imageMessage);

            // æ¸…é™¤localStorageä¸­çš„å›¾ç‰‡æ•°æ®
            localStorage.removeItem('pendingImage');
            localStorage.removeItem('selectedImage'); // æ–°å¢ï¼šæ¸…é™¤æ–°æ ¼å¼

            // ç«‹å³é‡ç½®èŠå¤©çŠ¶æ€
            resetChatState();

            // å»¶è¿Ÿå†æ¬¡ç¡®ä¿çŠ¶æ€æ­£ç¡®
            setTimeout(() => {
              resetChatState();
            }, 300);

            // å¦‚æœå¼€å¯äº†è‡ªåŠ¨ä¿å­˜ï¼Œä¿å­˜èŠå¤©è®°å½•
            if (currentSettings.autoSave) {
              saveChatHistory();
            }
          } catch (e) {
            console.error('è§£æå¾…å‘é€å›¾ç‰‡æ•°æ®å¤±è´¥:', e);
          }
        }
      }

      // æ‰“å¼€APIè®¾ç½®é¡µé¢
      function openAPISettings() {
        if (currentSettings.autoSave) {
          localStorage.setItem('chatSettings', JSON.stringify(currentSettings));
        }
        window.location.href = './api.html';
      }

      // æ‰“å¼€ä¸–ç•Œä¹¦é¡µé¢
      function openWorldBook() {
        if (currentSettings.autoSave) {
          localStorage.setItem('chatSettings', JSON.stringify(currentSettings));
        }
        window.location.href = './work.html';
      }

      // æ›´æ–°å¤´åƒæ˜¾ç¤º
      function updateAvatarDisplay(type, avatar, avatarFile) {
        const elements = [];

        if (type === 'user') {
          // æ›´æ–°ç”¨æˆ·å¤´åƒæ˜¾ç¤ºä½ç½®
          elements.push(...document.querySelectorAll('.message.sent .message-avatar'));
          // æ›´æ–°è®¾ç½®é¢æ¿ä¸­çš„å¤´åƒé¢„è§ˆ
          const preview = document.getElementById('userAvatarPreview');
          if (preview) {
            updatePreviewAvatar(preview, avatar, avatarFile, 'userAvatarText');
          }
        } else {
          // æ›´æ–°AIå¤´åƒæ˜¾ç¤ºä½ç½®
          elements.push(
            document.getElementById('chatAvatar'),
            document.getElementById('infoAvatar'),
            ...document.querySelectorAll('.message.received .message-avatar'),
          );
          // æ›´æ–°è®¾ç½®é¢æ¿ä¸­çš„å¤´åƒé¢„è§ˆ
          const preview = document.getElementById('aiAvatarPreview');
          if (preview) {
            updatePreviewAvatar(preview, avatar, avatarFile, 'aiAvatarText');
          }
        }

        elements.forEach(element => {
          if (element) {
            if (avatarFile) {
              element.innerHTML = `<img src="${avatarFile}" alt="${type}å¤´åƒ" style="width: 100%; height: 100%; object-fit: cover; border-radius: inherit;" />`;
            } else {
              element.innerHTML = avatar;
              element.style.backgroundImage = '';
            }
          }
        });
      }

      // æ›´æ–°é¢„è§ˆå¤´åƒ
      function updatePreviewAvatar(previewElement, avatar, avatarFile, textElementId) {
        const textElement = document.getElementById(textElementId);
        if (avatarFile) {
          previewElement.style.backgroundImage = `url(${avatarFile})`;
          if (textElement) textElement.style.display = 'none';
        } else {
          previewElement.style.backgroundImage = '';
          if (textElement) {
            textElement.style.display = 'flex';
            textElement.textContent = avatar || (textElementId.includes('user') ? 'ç”¨' : 'AI');
          }
        }
      }

      // å¤„ç†å¤´åƒä¸Šä¼ 
      function handleAvatarUpload(type) {
        const fileInput = document.getElementById(type + 'AvatarFile');
        const file = fileInput.files[0];

        if (file) {
          // æ£€æŸ¥æ–‡ä»¶ç±»å‹
          if (!file.type.startsWith('image/')) {
            showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
            return;
          }

          // æ£€æŸ¥æ–‡ä»¶å¤§å° (é™åˆ¶ä¸º2MB)
          if (file.size > 2 * 1024 * 1024) {
            showToast('å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡2MB');
            return;
          }

          const reader = new FileReader();
          reader.onload = function (e) {
            const base64 = e.target.result;

            // ä¿å­˜åˆ°è®¾ç½®ä¸­
            if (type === 'user') {
              currentSettings.userAvatarFile = base64;
              currentSettings.userAvatar = '';
            } else {
              currentSettings.aiAvatarFile = base64;
              currentSettings.aiAvatar = '';
            }

            // æ›´æ–°æ˜¾ç¤º
            updateAvatarDisplay(type, '', base64);
            showToast('å¤´åƒä¸Šä¼ æˆåŠŸ');
          };

          reader.readAsDataURL(file);
        }
      }

      // é‡ç½®å¤´åƒ
      function resetAvatar(type) {
        if (type === 'user') {
          currentSettings.userAvatarFile = '';
          currentSettings.userAvatar = currentSettings.userName ? currentSettings.userName.charAt(0) : 'ç”¨';
          updateAvatarDisplay('user', currentSettings.userAvatar, '');
        } else {
          currentSettings.aiAvatarFile = '';
          currentSettings.aiAvatar = currentSettings.aiName ? currentSettings.aiName.charAt(0) : 'AI';
          updateAvatarDisplay('ai', currentSettings.aiAvatar, '');
        }
        showToast('å¤´åƒå·²é‡ç½®');
      }

      // åˆ‡æ¢åŠŸèƒ½å¡ç‰‡
      function toggleFunctionCard() {
        const card = document.getElementById('functionCard');
        const btn = document.getElementById('functionBtn');
        const isVisible = card.style.display === 'flex';

        if (isVisible) {
          hideFunctionCard();
        } else {
          showFunctionCard();
        }
      }

      // æ˜¾ç¤ºåŠŸèƒ½å¡ç‰‡
      function showFunctionCard() {
        const card = document.getElementById('functionCard');
        card.style.display = 'flex';

        // ç‚¹å‡»å¤–éƒ¨å…³é—­å¡ç‰‡
        setTimeout(() => {
          document.addEventListener('click', closeFunctionCardOnOutsideClick);
        }, 100);
      }

      // éšè—åŠŸèƒ½å¡ç‰‡
      function hideFunctionCard() {
        const card = document.getElementById('functionCard');
        const btn = document.getElementById('functionBtn');
        card.style.display = 'none';
        document.removeEventListener('click', closeFunctionCardOnOutsideClick);
      }

      // ç‚¹å‡»å¤–éƒ¨å…³é—­åŠŸèƒ½å¡ç‰‡
      function closeFunctionCardOnOutsideClick(event) {
        const card = document.getElementById('functionCard');
        const btn = document.getElementById('functionBtn');

        if (!card.contains(event.target) && !btn.contains(event.target)) {
          hideFunctionCard();
        }
      }

      // ROLL - é‡æ–°ç”ŸæˆAIå›å¤
      async function rollLastMessage() {
        hideFunctionCard();

        // å¦‚æœå½“å‰è¿˜æ²¡è¯·æ±‚è¿‡AIï¼ˆpendingUserMessageå­˜åœ¨ï¼‰ï¼Œç›´æ¥ç”Ÿæˆ
        if (pendingUserMessage) {
          await generateAIReply(pendingUserMessage);
        } else {
          // æ‰¾åˆ°æœ€åä¸€æ¡ AI æ¶ˆæ¯çš„ä¸‹æ ‡
          const messagesArea = document.getElementById('messagesArea');
          let lastAiIdx = -1;
          for (let i = messages.length - 1; i >= 0; i--) {
            if (messages[i].sender === 'ai') {
              lastAiIdx = i;
              break;
            }
          }
          if (lastAiIdx === -1) {
            showToast('æ²¡æœ‰å¯ROLLçš„AIå›å¤');
            return;
          }
          // åˆ é™¤æœ€åä¸€æ¡AIæ¶ˆæ¯
          messages.splice(lastAiIdx, 1);
          // ä»DOMç§»é™¤å¯¹åº”å…ƒç´ ï¼ˆå€’æ•°ç¬¬lastAiIdx+1ä¸ªreceivedï¼‰
          let aiCount = 0;
          for (let node = messagesArea.lastElementChild; node; node = node.previousElementSibling) {
            if (node.classList && node.classList.contains('received')) {
              if (aiCount === 0) {
                node.remove();
                break;
              }
              aiCount++;
            }
          }
          // æ‰¾åˆ°ç´§æŒ¨ç€è¢«åˆ é™¤AIæ¶ˆæ¯ä¹‹å‰çš„é‚£æ¡ç”¨æˆ·æ¶ˆæ¯
          let lastUser = null;
          for (let i = lastAiIdx - 1; i >= 0; i--) {
            if (messages[i].sender === 'user') {
              lastUser = messages[i].text;
              break;
            }
          }
          if (!lastUser) {
            showToast('æ²¡æœ‰å¯ç”¨äºé‡æ–°ç”Ÿæˆçš„ç”¨æˆ·æ¶ˆæ¯');
            return;
          }
          await generateAIReply(lastUser);
        }
        const functionBtn = document.getElementById('functionBtn');
        functionBtn.classList.remove('active');
        functionBtn.title = 'æ›´å¤šåŠŸèƒ½';
      }

      // ç­‰å¾…å›å¤ - ç”ŸæˆAIå›å¤
      async function waitForReply() {
        hideFunctionCard();

        if (!pendingUserMessage) {
          showToast('æ²¡æœ‰å¾…å¤„ç†çš„æ¶ˆæ¯');
          return;
        }

        await generateAIReply(pendingUserMessage);

        // é‡ç½®çŠ¶æ€
        pendingUserMessage = null;
        const functionBtn = document.getElementById('functionBtn');
        functionBtn.classList.remove('active');
        functionBtn.title = 'æ›´å¤šåŠŸèƒ½';
      }

      // ç”ŸæˆAIå›å¤
      async function generateAIReply(userMessage) {
        // å…ˆå¼ºåˆ¶æ¸…ç†ä»»ä½•ç°æœ‰çš„è¾“å…¥æŒ‡ç¤ºå™¨
        forceCleanTypingIndicator();

        // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥
        showTypingIndicator();

        // è®¾ç½®ä¸€ä¸ªè¶…æ—¶æœºåˆ¶ï¼Œæœ€å¤šç­‰å¾…30ç§’
        const timeoutId = setTimeout(() => {
          forceCleanTypingIndicator();
          addMessage('ai', 'æŠ±æ­‰ï¼Œå›å¤è¶…æ—¶äº†ï¼Œè¯·ç¨åé‡è¯•ã€‚');
        }, 30000);

        try {
          // æ·»åŠ å°å»¶è¿Ÿæ¨¡æ‹Ÿæ€è€ƒæ—¶é—´
          await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));

          const aiResponse = await getAIResponse(userMessage);

          // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
          clearTimeout(timeoutId);

          if (Array.isArray(aiResponse)) {
            // å…ˆéšè—åˆå§‹çš„è¾“å…¥æŒ‡ç¤ºå™¨
            forceCleanTypingIndicator();

            // é€æ¡å‘é€æ¶ˆæ¯
            for (let i = 0; i < aiResponse.length; i++) {
              const delay = i === 0 ? 0 : 800 + Math.random() * 1200;

              setTimeout(() => {
                // ä¸ºç¬¬2æ¡åŠä»¥åçš„æ¶ˆæ¯æ·»åŠ è¾“å…¥æŒ‡ç¤ºå™¨
                if (i > 0) {
                  showTypingIndicator();
                  setTimeout(() => {
                    forceCleanTypingIndicator();
                    addMessage('ai', aiResponse[i]);
                    if (currentSettings.autoSave) {
                      saveChatHistory();
                    }

                    // å¦‚æœæ˜¯æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œæ’­æ”¾é€šçŸ¥å£°éŸ³
                    if (i === aiResponse.length - 1 && currentSettings.soundEnabled) {
                      playNotificationSound();
                    }
                  }, 500 + Math.random() * 800);
                } else {
                  // ç¬¬ä¸€æ¡æ¶ˆæ¯ç›´æ¥å‘é€
                  addMessage('ai', aiResponse[i]);
                  if (currentSettings.autoSave) {
                    saveChatHistory();
                  }
                }
              }, delay);
            }

            // ä¿å­˜æœ€åä¸€æ¡AIå›å¤
            lastAIResponse = aiResponse[aiResponse.length - 1];
          } else {
            // å•æ¡æ¶ˆæ¯æ¨¡å¼
            forceCleanTypingIndicator();

            addMessage('ai', aiResponse);
            lastAIResponse = aiResponse;
            if (currentSettings.autoSave) {
              saveChatHistory();
            }
            if (currentSettings.soundEnabled) {
              playNotificationSound();
            }
          }
        } catch (error) {
          // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
          clearTimeout(timeoutId);
          // ç¡®ä¿åœ¨å‡ºé”™æ—¶ä¹Ÿå¼ºåˆ¶æ¸…ç†è¾“å…¥æŒ‡ç¤ºå™¨
          forceCleanTypingIndicator();
          console.error('ç”ŸæˆAIå›å¤æ—¶å‡ºé”™:', error);
          addMessage('ai', 'æŠ±æ­‰ï¼Œå›å¤ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
          if (currentSettings.soundEnabled) {
            playNotificationSound();
          }
        }
      }

      // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
      function initEventListeners() {
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const expandBtn = document.getElementById('expandBtn');
        const functionBtn = document.getElementById('functionBtn');
        const rollBtn = document.getElementById('rollBtn');

        // ç¡®ä¿å‘é€æŒ‰é’®åˆå§‹çŠ¶æ€
        if (sendBtn) {
          sendBtn.disabled = true; // åˆå§‹çŠ¶æ€ä¸ºç¦ç”¨
        }

        // ç¡®ä¿é¡µé¢åˆå§‹åŒ–æ—¶æ¸…ç†AIè¾“å…¥çŠ¶æ€
        setTimeout(() => {
          hideTypingIndicator();
          forceCleanTypingIndicator();
          if (sendBtn && messageInput) {
            sendBtn.disabled = !messageInput.value.trim();
          }
        }, 100);

        // è¾“å…¥æ¡†è‡ªåŠ¨è°ƒæ•´é«˜åº¦
        if (messageInput) {
          messageInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';

            // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
            if (sendBtn) {
              // åªæœ‰åœ¨AIä¸åœ¨è¾“å…¥çŠ¶æ€æ—¶æ‰æ ¹æ®è¾“å…¥å†…å®¹æ›´æ–°æŒ‰é’®çŠ¶æ€
              if (!isAITyping) {
                sendBtn.disabled = !this.value.trim();
              }
            }
          });
        }

        // å›è½¦å‘é€æ¶ˆæ¯
        messageInput.addEventListener('keypress', function (e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

        // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        if (sendBtn) {
          sendBtn.addEventListener('click', function () {
            sendMessage();
          });
        } else {
          console.error('å‘é€æŒ‰é’®å…ƒç´ æœªæ‰¾åˆ°!');
        }

        // å±•å¼€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        expandBtn.addEventListener('click', function () {
          toggleFunctionButtons();
        });

        // åŠŸèƒ½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        functionBtn.addEventListener('click', function () {
          toggleFunctionCard();
        });

        // é˜»æ­¢åŠŸèƒ½å¡ç‰‡å†…çš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
        const functionCard = document.getElementById('functionCard');
        if (functionCard) {
          functionCard.addEventListener('click', function (e) {
            e.stopPropagation();
          });
        }

        // ç»‘å®šåŠŸèƒ½æŒ‰é’®äº‹ä»¶
        const featureBtns = document.querySelectorAll('.feature-btn');
        featureBtns.forEach(btn => {
          btn.addEventListener('click', function () {
            const action = this.getAttribute('data-action');
            if (action === 'redpacket') sendRedPacket();
            if (action === 'transfer') sendTransfer();
            if (action === 'image') sendImage();
            if (action === 'emoji') openEmojiPanel();
          });
        });

        // åªåœ¨AIèŠå¤©æ—¶æ˜¾ç¤ºROLLæŒ‰é’®ï¼Œå¹¶ç»‘å®šäº‹ä»¶
        if (currentChatInfo.type === 'ai' && rollBtn) {
          rollBtn.style.display = '';
          rollBtn.onclick = async function () {
            rollBtn.disabled = true;
            await rollLastMessage();
            rollBtn.disabled = false;
          };
        } else if (rollBtn) {
          rollBtn.style.display = 'none';
        }
      }

      // å‘é€æ¶ˆæ¯
      async function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();

        if (!text) {
          return;
        }

        // å…ˆå¼ºåˆ¶æ¸…ç†ä»»ä½•æ®‹ç•™çš„è¾“å…¥æŒ‡ç¤ºå™¨
        hideTypingIndicator();

        if (isAITyping) {
          return;
        }

        hideFunctionCard();
        addMessage('user', text);
        input.value = '';
        input.style.height = 'auto';
        document.getElementById('sendBtn').disabled = true;

        // æ£€æŸ¥æ˜¯å¦æ˜¯çº¢åŒ…æ¶ˆæ¯ï¼Œå¦‚æœæ˜¯åˆ™ä¸è¿›å…¥æ­£å¸¸AIå›å¤æµç¨‹
        const isRedPacketMessage = text.startsWith('ğŸ§§');
        if (isRedPacketMessage && currentChatInfo.type === 'ai') {
          document.getElementById('sendBtn').disabled = false;
          if (currentSettings.autoSave) saveChatHistory();
          return; // ç›´æ¥è¿”å›ï¼Œä¸è®¾ç½®pendingUserMessage
        }

        pendingUserMessage = text; // ç­‰å¾…ç”¨æˆ·ç‚¹â€œç­‰å¾…å›å¤â€æˆ–â€œROLLâ€
        if (currentSettings.autoSave) saveChatHistory();
        const functionBtn = document.getElementById('functionBtn');
        functionBtn.classList.add('active');
        functionBtn.title = 'è¯·é€‰æ‹©AIå›å¤æ–¹å¼';
      }

      // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
      function addMessage(sender, text) {
        const messagesArea = document.getElementById('messagesArea');
        const messageDiv = document.createElement('div');
        const isUser = sender === 'user';

        const avatarText = isUser ? currentSettings.userAvatar : currentSettings.aiAvatar;
        const avatarFile = isUser ? currentSettings.userAvatarFile : currentSettings.aiAvatarFile;
        const senderName = isUser ? currentSettings.userName : currentSettings.aiName;
        const messageId = Date.now() + Math.random();

        // æ„å»ºå¤´åƒHTML
        let avatarHTML;
        if (avatarFile) {
          avatarHTML = `<img src="${avatarFile}" alt="${senderName}å¤´åƒ" style="width: 100%; height: 100%; object-fit: cover; border-radius: inherit;" />`;
        } else {
          avatarHTML = avatarText;
        }

        messageDiv.className = `message ${isUser ? 'sent' : 'received'}`;
        messageDiv.setAttribute('data-message-id', messageId);
        messageDiv.oncontextmenu = e => showMessageDeleteButton(messageId, e);
        messageDiv.ontouchstart = e => handleMessageTouchStart(messageId, e);
        messageDiv.ontouchmove = e => handleMessageTouchMove(messageId, e);
        messageDiv.ontouchend = e => handleMessageTouchEnd(messageId, e);

        // æ£€æŸ¥æ˜¯å¦æ˜¯çº¢åŒ…æ¶ˆæ¯
        const isRedPacket = text.startsWith('ğŸ§§');
        // æ£€æŸ¥æ˜¯å¦æ˜¯è½¬è´¦æ¶ˆæ¯
        const isTransfer = text.startsWith('ğŸ’¸');
        let messageContent;

        if (isRedPacket) {
          // è§£æçº¢åŒ…ä¿¡æ¯ - æ–°æ ¼å¼: ğŸ§§ ç¥ç¦è¯­|é‡‘é¢
          const redPacketMatch = text.match(/ğŸ§§\s*(.+)\|(.+)/);
          if (redPacketMatch) {
            const bless = redPacketMatch[1].trim();
            const amount = redPacketMatch[2].trim();

            messageContent = `
              <div class="redpacket-content" data-amount="${amount}">
                <span class="redpacket-icon">ğŸ§§</span>
                <div class="redpacket-info">
                  <div class="redpacket-title">QQçº¢åŒ…</div>
                  <div class="redpacket-bless">${bless}</div>
                </div>
              </div>
            `;
          } else {
            messageContent = escapeHtml(text);
          }
        } else if (isTransfer) {
          // è§£æè½¬è´¦ä¿¡æ¯ - æ ¼å¼: ğŸ’¸ å‘ä½ è½¬è´¦/å·²æ¥å—è½¬è´¦/é€€è¿˜è½¬è´¦ 100.00å…ƒ æˆ– ğŸ’¸ å‘ä½ è½¬è´¦ 100.00å…ƒ - è¯´æ˜
          const transferMatch = text.match(/ğŸ’¸\s*(?:å‘ä½ è½¬è´¦|å·²æ¥å—è½¬è´¦|é€€è¿˜è½¬è´¦)\s*(\d+\.?\d*)å…ƒ(?:\s*-\s*(.+))?/);
          if (transferMatch) {
            const amount = transferMatch[1].trim();
            const message = transferMatch[2] ? transferMatch[2].trim() : 'è½¬è´¦';
            const isAccepted = text.includes('å·²æ¥å—è½¬è´¦');

            messageContent = `
              <div class="transfer-content" data-amount="${amount}" data-message="${message}" ${
              isAccepted ? 'data-accepted="true"' : ''
            }>
                <span class="transfer-icon">ğŸ’¸</span>
                <div class="transfer-info">
                  <div class="transfer-title">è½¬è´¦</div>
                  <div class="transfer-amount">Â¥${amount}</div>
                  <div class="transfer-message-text">${message}</div>
                </div>
              </div>
            `;
          } else {
            messageContent = escapeHtml(text);
          }
        } else if (text.startsWith('[è¡¨æƒ…åŒ…:') && text.endsWith(']')) {
          // å¤„ç†è¡¨æƒ…åŒ…æ¶ˆæ¯

          const emojiMatch = text.match(/\[è¡¨æƒ…åŒ…:(.+)\]/);
          if (emojiMatch) {
            const emojiSrc = emojiMatch[1];

            messageContent = `<img src="${emojiSrc}" alt="è¡¨æƒ…åŒ…" style="max-width: 120px; max-height: 120px; border-radius: 8px;" onerror="this.alt='[è¡¨æƒ…åŒ…åŠ è½½å¤±è´¥]'; this.style.display='none'; this.nextSibling.style.display='inline'"><span style="display:none">[è¡¨æƒ…åŒ…]</span>`;
          } else {
            messageContent = escapeHtml(text);
          }
        } else {
          messageContent = escapeHtml(text);
        }

        // æ£€æŸ¥æ¶ˆæ¯ç±»å‹
        const isEmoji = text.startsWith('[è¡¨æƒ…åŒ…:') && text.endsWith(']');

        messageDiv.innerHTML = `
          <div class="message-avatar">${avatarHTML}</div>
          <div>
            <div class="message-bubble ${isRedPacket ? 'redpacket-message' : ''} ${
          isTransfer ? 'transfer-message' : ''
        } ${isEmoji ? 'emoji-message' : ''}" ${isRedPacket ? `onclick="openRedPacket('${messageId}')"` : ''} ${
          isTransfer ? `onclick="openTransfer('${messageId}')"` : ''
        }>${messageContent}</div>
            <div class="message-time">${formatTime(new Date())}</div>
          </div>
          <button class="message-delete-btn" onclick="deleteMessage('${messageId}', event)">ğŸ—‘ï¸</button>
        `;

        messagesArea.appendChild(messageDiv);

        // å¦‚æœåœ¨åˆ é™¤æ¨¡å¼ä¸‹ï¼Œä¸ºæ–°æ¶ˆæ¯æ·»åŠ åˆ é™¤å‰å·
        if (isDeleteMode) {
          const deleteX = document.createElement('div');
          deleteX.className = 'message-delete-cross';
          deleteX.innerHTML = 'Ã—';
          deleteX.onclick = e => {
            e.stopPropagation();
            quickDeleteMessage(messageId);
          };
          messageDiv.appendChild(deleteX);
        }

        messagesArea.scrollTop = messagesArea.scrollHeight;

        // ä¿å­˜æ¶ˆæ¯åˆ°æ•°ç»„
        messages.push({
          id: messageId,
          sender: sender,
          text: text,
          timestamp: new Date().toISOString(),
          senderName: senderName,
        });

        // ä¿å­˜èŠå¤©è®°å½•åˆ°localStorage
        if (currentSettings.autoSave) {
          saveChatHistory();
        }

        // å¦‚æœæ˜¯å·²æ¥å—çš„è½¬è´¦ï¼Œè‡ªåŠ¨æ ‡è®°ä¸ºå·²æ¥å—çŠ¶æ€
        if (isTransfer && text.includes('å·²æ¥å—è½¬è´¦')) {
          setTimeout(() => {
            updateTransferToAccepted(messageId);
          }, 10);
        }

        // æ£€æµ‹çº¢åŒ…æ¶ˆæ¯ï¼ŒAIè‡ªåŠ¨å›å¤
        if (isUser && isRedPacket && currentChatInfo.type === 'ai') {
          setTimeout(() => {
            // è§£æçº¢åŒ…ä¿¡æ¯è·å–é‡‘é¢
            const redPacketMatch = text.match(/ğŸ§§\s*(.+)\|(.+)/);
            if (redPacketMatch) {
              const bless = redPacketMatch[1].trim();
              const amount = redPacketMatch[2].trim();

              // AIè‡ªåŠ¨å›å¤é¢†å–çº¢åŒ…
              const aiReplies = [
                `è°¢è°¢ä½ çš„çº¢åŒ…ï¼æˆ‘æ”¶åˆ°äº†${amount}å…ƒï¼Œ${bless} ğŸ§§`,
                `å“‡ï¼æ”¶åˆ°çº¢åŒ…å•¦ï¼${amount}å…ƒå·²ç»æ”¶ä¸‹äº†ï¼Œ${bless}ï¼è°¢è°¢ï½ âœ¨`,
                `æ„Ÿè°¢çº¢åŒ…ï¼${amount}å…ƒæˆ‘æ”¶å¥½äº†ï¼Œ${bless}ï¼Œç¥ä½ ä¹Ÿå‘è´¢ï¼ğŸ’°`,
                `çº¢åŒ…æ”¶åˆ°ï¼${amount}å…ƒï¼Œ${bless}ï¼Œè°¢è°¢ä½ çš„å¥½æ„ï¼ğŸ˜Š`,
                `å¼€å¿ƒï¼æ”¶åˆ°äº†${amount}å…ƒçº¢åŒ…ï¼Œ${bless}ï¼Œä½ çœŸæ˜¯å¤ªå¥½äº†ï¼ğŸ‰`,
              ];

              const randomReply = aiReplies[Math.floor(Math.random() * aiReplies.length)];
              addMessage('ai', randomReply);

              // ä¿å­˜AIçš„å›å¤
              if (currentSettings.autoSave) {
                saveChatHistory();
              }
            }
          }, 1000); // å»¶è¿Ÿ1ç§’æ¨¡æ‹ŸAIå¤„ç†æ—¶é—´
        }

        // æ£€æµ‹è½¬è´¦æ¶ˆæ¯ï¼ŒAIè‡ªåŠ¨å›å¤
        if (isUser && isTransfer && currentChatInfo.type === 'ai') {
          setTimeout(() => {
            // è§£æè½¬è´¦ä¿¡æ¯è·å–é‡‘é¢
            const transferMatch = text.match(/ğŸ’¸\s*å‘ä½ è½¬è´¦\s*(\d+\.?\d*)å…ƒ(?:\s*-\s*(.+))?/);
            if (transferMatch) {
              const amount = transferMatch[1].trim();
              const message = transferMatch[2] ? transferMatch[2].trim() : 'è½¬è´¦';

              // AIè‡ªåŠ¨å›å¤æ”¶åˆ°è½¬è´¦
              const aiReplies = [
                `æ”¶åˆ°è½¬è´¦é€šçŸ¥ï¼ğŸ’¸ ${amount}å…ƒ - ${message}`,
                `å“‡ï¼æ”¶åˆ°ä½ çš„è½¬è´¦äº†ï¼ğŸ’° ${amount}å…ƒå·²åˆ°è´¦ï¼Œè°¢è°¢ï¼`,
                `è½¬è´¦æ”¶åˆ°ï¼ğŸ’¸ ${amount}å…ƒï¼Œå¤‡æ³¨ï¼š${message}ï¼Œæ„Ÿè°¢ï¼`,
                `æ„Ÿè°¢è½¬è´¦ï¼ğŸ’° ${amount}å…ƒå·²ç»æ”¶ä¸‹äº†ï¼Œ${message}`,
              ];

              const randomReply = aiReplies[Math.floor(Math.random() * aiReplies.length)];
              addMessage('ai', randomReply);

              // ä¿å­˜AIçš„å›å¤
              if (currentSettings.autoSave) {
                saveChatHistory();
              }
            }
          }, 1200); // å»¶è¿Ÿ1.2ç§’æ¨¡æ‹ŸAIå¤„ç†æ—¶é—´
        }
      }

      // æ·»åŠ å›¾ç‰‡æ¶ˆæ¯åˆ°ç•Œé¢
      function addImageMessage(sender, imageData, shouldSave = true) {
        const messagesArea = document.getElementById('messagesArea');
        const messageDiv = document.createElement('div');
        const isUser = sender === 'user';

        const avatarText = isUser ? currentSettings.userAvatar : currentSettings.aiAvatar;
        const avatarFile = isUser ? currentSettings.userAvatarFile : currentSettings.aiAvatarFile;
        const senderName = isUser ? currentSettings.userName : currentSettings.aiName;
        const messageId = Date.now() + Math.random();

        // æ„å»ºå¤´åƒHTML
        let avatarHTML;
        if (avatarFile) {
          avatarHTML = `<img src="${avatarFile}" alt="${senderName}å¤´åƒ" style="width: 100%; height: 100%; object-fit: cover; border-radius: inherit;" />`;
        } else {
          avatarHTML = avatarText;
        }

        messageDiv.className = `message ${isUser ? 'sent' : 'received'}`;
        messageDiv.setAttribute('data-message-id', messageId);
        messageDiv.oncontextmenu = e => showMessageDeleteButton(messageId, e);
        messageDiv.ontouchstart = e => handleMessageTouchStart(messageId, e);
        messageDiv.ontouchmove = e => handleMessageTouchMove(messageId, e);
        messageDiv.ontouchend = e => handleMessageTouchEnd(messageId, e);

        // ç”Ÿæˆæ–‡ä»¶å¤§å°æ˜¾ç¤º
        const fileSizeText = imageData.fileSize ? `${(imageData.fileSize / 1024 / 1024).toFixed(2)}MB` : '';

        // æ„å»ºå›¾ç‰‡æ¶ˆæ¯å†…å®¹
        const imageContent = `
          <div class="image-message">
            <img src="${imageData.base64}" alt="${imageData.fileName}" class="message-image" onclick="previewImage('${
          imageData.base64
        }', '${imageData.fileName}')" />
            <div class="image-info">
              <span class="image-filename">${imageData.fileName}</span>
              ${fileSizeText ? `<span class="image-filesize">${fileSizeText}</span>` : ''}
              ${imageData.options.compress ? '<span class="image-tag">å·²å‹ç¼©</span>' : ''}
              ${imageData.options.watermark ? '<span class="image-tag">æœ‰æ°´å°</span>' : ''}
              ${imageData.options.original ? '<span class="image-tag">åŸå›¾</span>' : ''}
            </div>
          </div>
        `;

        messageDiv.innerHTML = `
          <div class="message-avatar">${avatarHTML}</div>
          <div class="message-content">
            <div class="message-bubble image-bubble">${imageContent}</div>
            <div class="message-time">${formatTime(new Date())}</div>
          </div>
          <button class="message-delete-btn" onclick="deleteMessage('${messageId}', event)">ğŸ—‘ï¸</button>
        `;

        messagesArea.appendChild(messageDiv);

        // å¦‚æœåœ¨åˆ é™¤æ¨¡å¼ä¸‹ï¼Œä¸ºæ–°å›¾ç‰‡æ¶ˆæ¯æ·»åŠ åˆ é™¤å‰å·
        if (isDeleteMode) {
          const deleteX = document.createElement('div');
          deleteX.className = 'message-delete-cross';
          deleteX.innerHTML = 'Ã—';
          deleteX.onclick = e => {
            e.stopPropagation();
            quickDeleteMessage(messageId);
          };
          messageDiv.appendChild(deleteX);
        }

        messagesArea.scrollTop = messagesArea.scrollHeight;

        // ä¿å­˜æ¶ˆæ¯åˆ°æ•°ç»„ï¼ˆåŒ…å«å›¾ç‰‡æ•°æ®ï¼‰- åªåœ¨shouldSaveä¸ºtrueæ—¶ä¿å­˜
        if (shouldSave) {
          messages.push({
            id: messageId,
            sender: sender,
            type: 'image',
            imageData: imageData,
            timestamp: new Date().toISOString(),
            senderName: senderName,
          });
        }
      }

      // å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
      function previewImage(base64, fileName) {
        // åˆ›å»ºæ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.className = 'image-preview-modal';
        modal.onclick = function (e) {
          if (e.target === modal) {
            closeImagePreview();
          }
        };

        modal.innerHTML = `
          <div class="image-preview-content">
            <button class="image-preview-close" onclick="closeImagePreview()">&times;</button>
            <img src="${base64}" alt="${fileName}" class="image-preview-img" />
            <div class="image-preview-info">${fileName}</div>
          </div>
        `;

        document.body.appendChild(modal);
        modal.style.display = 'flex';

        // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
        document.addEventListener('keydown', handleImagePreviewKeydown);
      }

      // å…³é—­å›¾ç‰‡é¢„è§ˆ
      function closeImagePreview() {
        const modal = document.querySelector('.image-preview-modal');
        if (modal) {
          modal.remove();
        }
        document.removeEventListener('keydown', handleImagePreviewKeydown);
      }

      // å¤„ç†å›¾ç‰‡é¢„è§ˆçš„é”®ç›˜äº‹ä»¶
      function handleImagePreviewKeydown(e) {
        if (e.key === 'Escape') {
          closeImagePreview();
        }
      }

      // çº¢åŒ…ç‚¹å‡»å¤„ç†å‡½æ•°
      function openRedPacket(messageId) {
        // æ£€æŸ¥çº¢åŒ…æ˜¯å¦å·²ç»è¢«é¢†å–
        const redPacketKey = `redpacket_claimed_${messageId}`;
        const isClaimed = localStorage.getItem(redPacketKey) === 'true';

        // æŸ¥æ‰¾çº¢åŒ…å…ƒç´ å¹¶è·å–é‡‘é¢
        const redPacketElement = document.querySelector(`[data-message-id="${messageId}"] .redpacket-content`);
        const amount = redPacketElement ? redPacketElement.getAttribute('data-amount') : 'æœªçŸ¥';
        const blessElement = redPacketElement ? redPacketElement.querySelector('.redpacket-bless') : null;
        const bless = blessElement ? blessElement.textContent : 'æ­å–œå‘è´¢';

        // å¦‚æœå·²ç»é¢†å–ï¼Œæ˜¾ç¤ºå·²é¢†å–å¼¹çª—
        if (isClaimed) {
          showClaimedRedPacket(bless, amount);
          return;
        }

        // æ ‡è®°çº¢åŒ…ä¸ºå·²é¢†å–
        localStorage.setItem(redPacketKey, 'true');

        // æ›´æ–°çº¢åŒ…å¡ç‰‡ä¸ºå·²é¢†å–çŠ¶æ€
        updateRedPacketToClaimed(messageId);

        // åˆ›å»ºçº¢åŒ…å¼¹çª—
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.7);
          z-index: 1000;
          display: flex;
          align-items: center;
          justify-content: center;
          animation: fadeIn 0.3s ease;
        `;

        const popup = document.createElement('div');
        popup.style.cssText = `
          background: linear-gradient(135deg, #ff6256 0%, #ff4d4d 100%);
          border-radius: 16px;
          padding: 40px 30px;
          color: white;
          text-align: center;
          box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
          max-width: 320px;
          animation: popIn 0.3s ease;
        `;

        popup.innerHTML = `
          <div style="font-size: 54px; margin-bottom: 20px;">ğŸ§§</div>
          <div style="font-size: 20px; font-weight: 600; margin-bottom: 8px;">æ­å–œå‘è´¢ï¼</div>
          <div style="font-size: 15px; opacity: 0.9; margin-bottom: 16px;">${bless}</div>
          <div style="font-size: 32px; font-weight: 700; margin-bottom: 24px; color: #ffeb3b; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">Â¥${amount}</div>
          <button onclick="this.parentElement.parentElement.remove()" style="
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s ease;
          " onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">ç¡®å®š</button>
        `;

        overlay.appendChild(popup);
        document.body.appendChild(overlay); // ç‚¹å‡»é®ç½©å…³é—­
        overlay.onclick = e => {
          if (e.target === overlay) {
            overlay.remove();
          }
        };

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
          @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
          }
          @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
          }
        `;
        document.head.appendChild(style);
      }

      // æ˜¾ç¤ºå·²é¢†å–çš„çº¢åŒ…å¼¹çª—
      function showClaimedRedPacket(bless, amount) {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.7);
          z-index: 1000;
          display: flex;
          align-items: center;
          justify-content: center;
          animation: fadeIn 0.3s ease;
        `;

        const popup = document.createElement('div');
        popup.style.cssText = `
          background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
          border-radius: 16px;
          padding: 40px 30px;
          color: #666;
          text-align: center;
          box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
          max-width: 320px;
          animation: popIn 0.3s ease;
          position: relative;
          overflow: hidden;
        `;

        popup.innerHTML = `
          <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; transform: rotate(45deg);"></div>
          <div style="font-size: 50px; margin-bottom: 16px; opacity: 0.4;">ğŸ§§</div>
          <div style="font-size: 22px; font-weight: 600; margin-bottom: 8px; color: #999;">æ‰‹æ…¢äº†</div>
          <div style="font-size: 14px; margin-bottom: 12px; color: #aaa;">æ¥æ™šäº†ï¼Œçº¢åŒ…è¢«æŠ¢å…‰äº†</div>
          <div style="font-size: 13px; opacity: 0.6; margin-bottom: 20px; color: #bbb; font-style: italic;">${bless}</div>
          <div style="background: rgba(0, 0, 0, 0.05); border-radius: 8px; padding: 8px 16px; margin-bottom: 24px; display: inline-block;">
            <div style="font-size: 11px; color: #aaa; margin-bottom: 2px;">å·²è¢«é¢†å–</div>
            <div style="font-size: 16px; font-weight: 600; color: #999;">Â¥${amount}</div>
          </div>
          <button onclick="this.parentElement.parentElement.remove()" style="
            background: linear-gradient(135deg, #ddd 0%, #bbb 100%);
            border: none;
            color: #666;
            padding: 10px 24px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          " onmouseover="this.style.background='linear-gradient(135deg, #ccc 0%, #aaa 100%)'" onmouseout="this.style.background='linear-gradient(135deg, #ddd 0%, #bbb 100%)'">çŸ¥é“äº†</button>
        `;

        overlay.appendChild(popup);
        document.body.appendChild(overlay);

        // ç‚¹å‡»é®ç½©å…³é—­
        overlay.onclick = e => {
          if (e.target === overlay) {
            overlay.remove();
          }
        };
      }

      // æ›´æ–°çº¢åŒ…å¡ç‰‡ä¸ºå·²é¢†å–çŠ¶æ€
      function updateRedPacketToClaimed(messageId) {
        const redPacketMessage = document.querySelector(`[data-message-id="${messageId}"] .redpacket-message`);
        if (redPacketMessage) {
          // æ·»åŠ å·²é¢†å–æ ·å¼ - æ›´ä¼˜é›…çš„ç°è‰²è®¾è®¡
          redPacketMessage.style.background = 'linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%)';
          redPacketMessage.style.cursor = 'pointer'; // ä»ç„¶å¯ä»¥ç‚¹å‡»æŸ¥çœ‹
          redPacketMessage.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';

          // æ›´æ–°çº¢åŒ…å›¾æ ‡ä¸ºç°è‰²
          const redPacketIcon = redPacketMessage.querySelector('.redpacket-icon');
          if (redPacketIcon) {
            redPacketIcon.style.opacity = '0.4';
            redPacketIcon.style.filter = 'grayscale(100%)';
          }

          // æ›´æ–°æ–‡å­—é¢œè‰²
          const redPacketTitle = redPacketMessage.querySelector('.redpacket-title');
          const redPacketBless = redPacketMessage.querySelector('.redpacket-bless');
          if (redPacketTitle) {
            redPacketTitle.style.color = '#aaa';
          }
          if (redPacketBless) {
            redPacketBless.style.color = '#999';
            redPacketBless.style.opacity = '0.7';
          }

          // æ·»åŠ å·²é¢†å–æ ‡è®° - æ›´ç²¾è‡´çš„è®¾è®¡
          const redPacketInfo = redPacketMessage.querySelector('.redpacket-info');
          if (redPacketInfo && !redPacketInfo.querySelector('.claimed-mark')) {
            const claimedMark = document.createElement('div');
            claimedMark.className = 'claimed-mark';
            claimedMark.style.cssText = `
              font-size: 9px;
              color: #bbb;
              margin-top: 3px;
              background: rgba(0, 0, 0, 0.05);
              padding: 1px 6px;
              border-radius: 8px;
              display: inline-block;
              font-weight: 400;
            `;
            claimedMark.textContent = 'å·²é¢†å–';
            redPacketInfo.appendChild(claimedMark);
          }
        }
      }

      // è½¬è´¦ç‚¹å‡»å¤„ç†å‡½æ•°
      function openTransfer(messageId) {
        // æ£€æŸ¥è½¬è´¦æ˜¯å¦å·²ç»è¢«æ¥å—
        const transferKey = `transfer_accepted_${messageId}`;
        const isAccepted = localStorage.getItem(transferKey) === 'true';

        // æŸ¥æ‰¾è½¬è´¦å…ƒç´ å¹¶è·å–ä¿¡æ¯
        const transferElement = document.querySelector(`[data-message-id="${messageId}"] .transfer-content`);
        const amount = transferElement ? transferElement.getAttribute('data-amount') : 'æœªçŸ¥';
        const message = transferElement ? transferElement.getAttribute('data-message') : 'è½¬è´¦';

        // å¦‚æœå·²ç»æ¥å—ï¼Œæ˜¾ç¤ºå·²æ¥å—å¼¹çª—
        if (isAccepted) {
          showAcceptedTransfer(message, amount);
          return;
        }

        // åˆ›å»ºè½¬è´¦å¼¹çª—
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.7);
          z-index: 1000;
          display: flex;
          align-items: center;
          justify-content: center;
          animation: fadeIn 0.3s ease;
        `;

        const popup = document.createElement('div');
        popup.style.cssText = `
          background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
          border-radius: 16px;
          padding: 40px 30px;
          color: white;
          text-align: center;
          box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
          max-width: 320px;
          animation: popIn 0.3s ease;
        `;

        popup.innerHTML = `
          <div style="font-size: 54px; margin-bottom: 20px;">ğŸ’¸</div>
          <div style="font-size: 20px; font-weight: 600; margin-bottom: 8px;">æ”¶åˆ°è½¬è´¦</div>
          <div style="font-size: 15px; opacity: 0.9; margin-bottom: 16px;">${message}</div>
          <div style="font-size: 32px; font-weight: 700; margin-bottom: 24px; color: #ffeb3b; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">Â¥${amount}</div>
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button onclick="acceptTransfer('${messageId}', '${message}', '${amount}', this.parentElement.parentElement.parentElement)" style="
              background: rgba(255, 255, 255, 0.15);
              border: 1px solid rgba(255, 255, 255, 0.3);
              color: white;
              padding: 12px 24px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 15px;
              font-weight: 500;
              transition: all 0.2s ease;
            " onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">æ¥å—</button>
            ${
              currentChatInfo.type === 'ai'
                ? `
            <button onclick="rejectTransfer('${messageId}', '${message}', '${amount}', this.parentElement.parentElement.parentElement)" style="
              background: rgba(255, 255, 255, 0.1);
              border: 1px solid rgba(255, 255, 255, 0.2);
              color: rgba(255, 255, 255, 0.8);
              padding: 12px 24px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 15px;
              font-weight: 500;
              transition: all 0.2s ease;
            " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">é€€è¿˜</button>
            `
                : ''
            }
          </div>
        `;

        overlay.appendChild(popup);
        document.body.appendChild(overlay);

        // ç‚¹å‡»é®ç½©å…³é—­
        overlay.onclick = e => {
          if (e.target === overlay) {
            overlay.remove();
          }
        };

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
          @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
          }
          @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
          }
        `;
        document.head.appendChild(style);
      }

      // æ¥å—è½¬è´¦
      function acceptTransfer(messageId, message, amount, overlay) {
        // æ ‡è®°è½¬è´¦ä¸ºå·²æ¥å—
        const transferKey = `transfer_accepted_${messageId}`;
        localStorage.setItem(transferKey, 'true');

        // æ›´æ–°è½¬è´¦å¡ç‰‡ä¸ºå·²æ¥å—çŠ¶æ€
        updateTransferToAccepted(messageId);

        // å…³é—­å¼¹çª—
        overlay.remove();

        // å¦‚æœæ˜¯AIèŠå¤©ï¼ŒAIå‘é€å·²æ¥å—çš„è½¬è´¦å¡ç‰‡
        if (currentChatInfo.type === 'ai') {
          setTimeout(() => {
            // AIå‘é€å·²æ¥å—çš„è½¬è´¦æ¶ˆæ¯ - ä½¿ç”¨ç‰¹æ®Šæ ¼å¼è¡¨ç¤ºå·²æ¥å—
            const acceptedMessage = `ğŸ’¸ å·²æ¥å—è½¬è´¦ ${amount}å…ƒ - ${message || 'è½¬è´¦'}`;
            addMessage('ai', acceptedMessage);

            if (currentSettings.autoSave) {
              saveChatHistory();
            }
          }, 500);
        }

        // æ˜¾ç¤ºæ¥å—æˆåŠŸæç¤º
        showTransferAcceptedNotification(amount);
      }

      // é€€è¿˜è½¬è´¦ï¼ˆAIä¸“ç”¨ï¼‰
      function rejectTransfer(messageId, message, amount, overlay) {
        // å…³é—­å¼¹çª—
        overlay.remove();

        // AIå‘é€é€€è¿˜æ¶ˆæ¯
        setTimeout(() => {
          const rejectMessage = `ğŸ’¸ é€€è¿˜è½¬è´¦ ${amount}å…ƒ - ${message || 'è½¬è´¦'}`;
          addMessage('ai', rejectMessage);

          if (currentSettings.autoSave) {
            saveChatHistory();
          }
        }, 500);

        // æ˜¾ç¤ºé€€è¿˜æç¤º
        showTransferRejectedNotification(amount);
      }

      // æ˜¾ç¤ºå·²æ¥å—çš„è½¬è´¦å¼¹çª—
      function showAcceptedTransfer(message, amount) {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.7);
          z-index: 1000;
          display: flex;
          align-items: center;
          justify-content: center;
          animation: fadeIn 0.3s ease;
        `;

        const popup = document.createElement('div');
        popup.style.cssText = `
          background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
          border-radius: 16px;
          padding: 40px 30px;
          color: #666;
          text-align: center;
          box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
          max-width: 320px;
          animation: popIn 0.3s ease;
        `;

        popup.innerHTML = `
          <div style="font-size: 44px; margin-bottom: 20px; opacity: 0.6;">ğŸ’¸</div>
          <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #999;">è½¬è´¦å·²æ¥å—</div>
          <div style="font-size: 13px; margin-bottom: 12px; color: #aaa;">è¿™ç¬”è½¬è´¦å·²ç»è¢«æ¥å—äº†</div>
          <div style="font-size: 13px; opacity: 0.6; margin-bottom: 20px; color: #bbb; font-style: italic;">${message}</div>
          <div style="background: rgba(0, 0, 0, 0.05); border-radius: 8px; padding: 8px 16px; margin-bottom: 24px; display: inline-block;">
            <div style="font-size: 11px; color: #aaa; margin-bottom: 2px;">å·²æ¥å—é‡‘é¢</div>
            <div style="font-size: 16px; font-weight: 600; color: #999;">Â¥${amount}</div>
          </div>
          <button onclick="this.parentElement.parentElement.remove()" style="
            background: linear-gradient(135deg, #ddd 0%, #bbb 100%);
            border: none;
            color: #666;
            padding: 10px 24px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          " onmouseover="this.style.background='linear-gradient(135deg, #ccc 0%, #aaa 100%)'" onmouseout="this.style.background='linear-gradient(135deg, #ddd 0%, #bbb 100%)'">çŸ¥é“äº†</button>
        `;

        overlay.appendChild(popup);
        document.body.appendChild(overlay);

        // ç‚¹å‡»é®ç½©å…³é—­
        overlay.onclick = e => {
          if (e.target === overlay) {
            overlay.remove();
          }
        };
      }

      // æ›´æ–°è½¬è´¦å¡ç‰‡ä¸ºå·²æ¥å—çŠ¶æ€
      function updateTransferToAccepted(messageId) {
        const transferMessage = document.querySelector(`[data-message-id="${messageId}"] .transfer-message`);
        if (transferMessage) {
          // æ·»åŠ å·²æ¥å—æ ·å¼
          transferMessage.style.background = 'linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%)';
          transferMessage.style.cursor = 'pointer';
          transferMessage.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';

          // æ›´æ–°è½¬è´¦å›¾æ ‡ä¸ºç°è‰²
          const transferIcon = transferMessage.querySelector('.transfer-icon');
          if (transferIcon) {
            transferIcon.style.opacity = '0.4';
            transferIcon.style.filter = 'grayscale(100%)';
          }

          // æ›´æ–°æ–‡å­—é¢œè‰²
          const transferTitle = transferMessage.querySelector('.transfer-title');
          const transferAmount = transferMessage.querySelector('.transfer-amount');
          const transferMsg = transferMessage.querySelector('.transfer-message-text');
          if (transferTitle) {
            transferTitle.style.color = '#aaa';
          }
          if (transferAmount) {
            transferAmount.style.color = '#999';
            transferAmount.style.opacity = '0.7';
          }
          if (transferMsg) {
            transferMsg.style.color = '#bbb';
            transferMsg.style.opacity = '0.6';
          }

          // æ·»åŠ å·²æ¥å—æ ‡è®°
          const transferInfo = transferMessage.querySelector('.transfer-info');
          if (transferInfo && !transferInfo.querySelector('.accepted-mark')) {
            const acceptedMark = document.createElement('div');
            acceptedMark.className = 'accepted-mark';
            acceptedMark.style.cssText = `
              font-size: 9px;
              color: #bbb;
              margin-top: 3px;
              background: rgba(0, 0, 0, 0.05);
              padding: 1px 6px;
              border-radius: 8px;
              display: inline-block;
              font-weight: 400;
            `;
            acceptedMark.textContent = 'å·²æ¥å—';
            transferInfo.appendChild(acceptedMark);
          }
        }
      }

      // æ˜¾ç¤ºè½¬è´¦æ¥å—æˆåŠŸé€šçŸ¥
      function showTransferAcceptedNotification(amount) {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
          color: white;
          padding: 12px 24px;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 500;
          z-index: 1001;
          box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
          animation: slideDown 0.3s ease;
        `;
        notification.textContent = `å·²æ¥å— Â¥${amount} è½¬è´¦`;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = 'slideUp 0.3s ease';
          setTimeout(() => notification.remove(), 300);
        }, 2000);
      }

      // æ˜¾ç¤ºè½¬è´¦é€€è¿˜é€šçŸ¥
      function showTransferRejectedNotification(amount) {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
          color: white;
          padding: 12px 24px;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 500;
          z-index: 1001;
          box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
          animation: slideDown 0.3s ease;
        `;
        notification.textContent = `å·²é€€è¿˜ Â¥${amount} è½¬è´¦`;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = 'slideUp 0.3s ease';
          setTimeout(() => notification.remove(), 300);
        }, 2000);
      }

      // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
      function showTypingIndicator() {
        // å…ˆæ¸…é™¤ä»»ä½•ç°æœ‰çš„æŒ‡ç¤ºå™¨
        hideTypingIndicator();

        isAITyping = true;
        const messagesArea = document.getElementById('messagesArea');
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typingIndicator';
        typingDiv.className = 'message received';
        typingDiv.innerHTML = `
          <div class="message-avatar">${currentSettings.aiAvatar}</div>
          <div class="typing-indicator">
            <span>æ­£åœ¨è¾“å…¥</span>
            <div class="typing-dots">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
          </div>
        `;

        messagesArea.appendChild(typingDiv);
        messagesArea.scrollTop = messagesArea.scrollHeight;
      }

      // éšè—è¾“å…¥æŒ‡ç¤ºå™¨
      function hideTypingIndicator() {
        isAITyping = false;
        const indicator = document.getElementById('typingIndicator');
        if (indicator) {
          indicator.remove();
        }

        // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
        const sendBtn = document.getElementById('sendBtn');
        const messageInput = document.getElementById('messageInput');
        if (sendBtn && messageInput) {
          sendBtn.disabled = !messageInput.value.trim();
        }
      }

      // å¼ºåˆ¶æ¸…ç†æ‰€æœ‰è¾“å…¥æŒ‡ç¤ºå™¨
      function forceCleanTypingIndicator() {
        isAITyping = false;
        // æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„è¾“å…¥æŒ‡ç¤ºå™¨å¹¶åˆ é™¤
        const indicators = document.querySelectorAll('#typingIndicator, .typing-indicator-message');
        indicators.forEach(indicator => {
          indicator.remove();
        });

        // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
        const sendBtn = document.getElementById('sendBtn');
        const messageInput = document.getElementById('messageInput');
        if (sendBtn && messageInput) {
          sendBtn.disabled = !messageInput.value.trim();
        }
      }

      // è·å–AIå›å¤ï¼ˆçœŸå®APIè°ƒç”¨ï¼‰
      async function getAIResponse(userMessage) {
        // åŠ¨æ€è·å–ç›¸å…³çš„ä¸–ç•Œä¹¦æ¡ç›®
        try {
          if (typeof window.getWorldBookEntriesForCharacter === 'function') {
            // æå–ç”¨æˆ·æ¶ˆæ¯ä¸­çš„å…³é”®è¯ï¼ˆç®€å•çš„è¯æ±‡æå–ï¼‰
            const keywords = userMessage
              .replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s]/g, '') // ç§»é™¤æ ‡ç‚¹ç¬¦å·
              .split(/\s+/)
              .filter(word => word.length > 1); // è¿‡æ»¤å¤ªçŸ­çš„è¯

            // è·å–ç›¸å…³çš„ä¸–ç•Œä¹¦æ¡ç›®ç”¨äºä¸Šä¸‹æ–‡å¢å¼º
            const relevantEntries = window.getWorldBookEntriesForCharacter('', keywords);
            if (relevantEntries && Array.isArray(relevantEntries) && relevantEntries.length > 0) {
              // è¿™äº›æ¡ç›®å·²ç»åœ¨generateSystemPromptä¸­è¢«åŒ…å«äº†
            }
          }
        } catch (error) {}

        // ä»localStorageè·å–APIè®¾ç½®
        const apiSettings = JSON.parse(localStorage.getItem('apiSettings') || '{}');

        if (!apiSettings.selectedService || !apiSettings[apiSettings.selectedService]?.key) {
          return 'è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®æ‚¨çš„AIæœåŠ¡å’ŒAPIå¯†é’¥ã€‚ç‚¹å‡»è®¾ç½® â†’ APIé…ç½® â†’ å‰å¾€APIè®¾ç½®è¿›è¡Œé…ç½®ã€‚';
        }

        try {
          let response;
          const serviceConfig = apiSettings[apiSettings.selectedService];

          if (apiSettings.selectedService === 'openai') {
            response = await callOpenAI(userMessage, serviceConfig);
          } else if (apiSettings.selectedService === 'gemini') {
            response = await callGemini(userMessage, serviceConfig);
          } else {
            throw new Error('ä¸æ”¯æŒçš„AIæœåŠ¡');
          }

          return response;
        } catch (error) {
          console.error('AI APIè°ƒç”¨å¤±è´¥:', error);
          return `AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼š${error.message}ã€‚è¯·æ£€æŸ¥APIè®¾ç½®æˆ–ç¨åé‡è¯•ã€‚`;
        }
      }

      // æ£€æŸ¥ç‰¹æ®Šçº¢åŒ…å›å¤
      function checkSpecialRedPacketReply(userMessage) {
        const message = userMessage.toLowerCase();

        // å½“ç”¨æˆ·è¦çº¢åŒ…æ—¶ï¼ŒAIæœ‰æ¦‚ç‡å‘çº¢åŒ…
        if (
          message.includes('çº¢åŒ…') ||
          message.includes('å‘çº¢åŒ…') ||
          message.includes('ç»™çº¢åŒ…') ||
          message.includes('è¦çº¢åŒ…')
        ) {
          const random = Math.random();

          if (random < 0.4) {
            // 40%æ¦‚ç‡å‘çº¢åŒ…
            const amounts = ['1.88', '2.88', '5.20', '8.88', '6.66', '9.99', '13.14', '18.88'];
            const blessings = [
              'æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼',
              'è´¢æºå¹¿è¿›ï¼Œå¥½è¿è¿è¿ï¼',
              'æ­¥æ­¥é«˜å‡ï¼Œç¦æ°”æ»¡æ»¡ï¼',
              'ç¬‘å£å¸¸å¼€ï¼Œå¿ƒæƒ³äº‹æˆï¼',
              'ä¸‡äº‹å¦‚æ„ï¼Œçº¢çº¢ç«ç«ï¼',
            ];

            // æ·»åŠ é˜²æŠ¤æ€§æ£€æŸ¥
            if (!amounts || amounts.length === 0 || !blessings || blessings.length === 0) {
              console.error('çº¢åŒ…æ•°ç»„æœªæ­£ç¡®åˆå§‹åŒ–');
              return 'æŠ±æ­‰ï¼Œçº¢åŒ…åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ã€‚';
            }

            const amount = amounts[Math.floor(Math.random() * amounts.length)];
            const blessing = blessings[Math.floor(Math.random() * blessings.length)];

            // æ›´è‡ªç„¶çš„å›å¤
            const beforeReplies = [
              'å“ˆå“ˆï¼Œå¥½çš„å¥½çš„ï¼',
              'æ¥äº†æ¥äº†ï¼',
              'ç­‰ç€ï¼Œé©¬ä¸Šç»™ä½ å‘ä¸€ä¸ª~',
              'å¥½å˜›ï¼Œç»™ä½ å‡†å¤‡ä¸ªå°çº¢åŒ…ï¼',
              'è¿™å°±æ¥ï¼',
            ];

            const result = [
              beforeReplies[Math.floor(Math.random() * beforeReplies.length)],
              `ğŸ§§ ${blessing}|${amount}`,
            ];

            return result;
          } else {
            // 60%æ¦‚ç‡æ‹’ç»æˆ–è°ƒçš®å›å¤
            const refuseReplies = [
              ['å“å‘€', 'ä»Šå¤©çº¢åŒ…é¢åº¦ç”¨å®Œå•¦ ï¿½'],
              ['emmm...', 'é’±åŒ…ç©ºç©ºå¦‚ä¹Ÿå‘¢ ğŸ¤­'],
              ['æƒ³è¦çº¢åŒ…å‘€ï¼Ÿ', 'é‚£ä½ å¾—å…ˆå¤¸å¤¸æˆ‘ï¼ï¿½'],
              ['çº¢åŒ…å˜›...', 'ä¸‹æ¬¡ä¸€å®šä¸‹æ¬¡ä¸€å®šï¼'],
              ['å“ˆå“ˆå“ˆ', 'è™šæ‹Ÿçº¢åŒ…ç»™ä½ æ¯”ä¸ªå¿ƒ â¤ï¸'],
              ['æˆ‘è¿™ä¸ªAIå•Š', 'åªæœ‰è™šæ‹Ÿçš„çˆ±ç»™ä½  ğŸ’•'],
            ];
            const result = refuseReplies[Math.floor(Math.random() * refuseReplies.length)];

            return result;
          }
        }

        // æ£€æŸ¥è½¬è´¦ç›¸å…³å›å¤ï¼ˆåŒ…æ‹¬è½¬è´¦å¡ç‰‡æ ¼å¼ï¼‰
        if (
          message.includes('è½¬è´¦') ||
          message.includes('ç»™ä½ è½¬') ||
          message.includes('è½¬ç‚¹é’±') ||
          message.includes('ğŸ’¸') ||
          message.includes('å‘ä½ è½¬è´¦')
        ) {
          const responses = [
            ['å“‡ï¼', 'è°¢è°¢ä½ è¦ç»™æˆ‘è½¬è´¦ï¼ğŸ’¸', 'ä¸è¿‡æˆ‘æ˜¯AIæ”¶ä¸åˆ°çœŸé’±å‘¢ ğŸ˜Š'],
            ['è½¬è´¦ç»™æˆ‘ï¼Ÿ', 'å¿ƒæ„æˆ‘æ”¶åˆ°äº†ï½', 'è™½ç„¶é’±åˆ°ä¸äº†æˆ‘è¿™é‡Œ ï¿½'],
            ['emmm', 'è™šæ‹Ÿè½¬è´¦æˆ‘å°±ç¬‘çº³äº†ï¼', 'çœŸé’±ä½ è¿˜æ˜¯ç•™ç€å§ ğŸ’•'],
            ['å¥½æ„ŸåŠ¨ï¼', 'ä¸è¿‡æˆ‘è¿™ä¸ªAI', 'åªèƒ½æ”¶åˆ°ä½ çš„çˆ±æ„ â¤ï¸'],
            ['å“ˆå“ˆ', 'è½¬è´¦å¡ç‰‡å¾ˆæ¼‚äº®ï¼', 'å¯æƒœæˆ‘æ²¡æœ‰é“¶è¡Œè´¦æˆ· ğŸ¦'],
          ];
          const result = responses[Math.floor(Math.random() * responses.length)];

          return result;
        }

        // æ£€æŸ¥ä¸€äº›æ™®é€šæ¶ˆæ¯çš„å¤šæ¡å›å¤
        if (message.includes('ä½ å¥½') || message.includes('hi') || message.includes('hello')) {
          const greetings = [
            ['ä½ å¥½å‘€ï¼', 'ä»Šå¤©å¿ƒæƒ…æ€ä¹ˆæ ·ï¼ŸğŸ˜Š'],
            ['Hiï½', 'å¾ˆé«˜å…´è§åˆ°ä½ ï¼âœ¨'],
            ['å“ˆå–½ï¼', 'åˆæ¥æ‰¾æˆ‘èŠå¤©å•¦ï½'],
            ['ä½ å¥½ä½ å¥½ï¼', 'ä»Šå¤©æœ‰ä»€ä¹ˆæœ‰è¶£çš„äº‹å—ï¼Ÿ'],
            ['å—¨ï¼', 'æ¬¢è¿æ¥åˆ°æˆ‘çš„èŠå¤©å®¤ï¼ğŸ‰'],
          ];
          const result = greetings[Math.floor(Math.random() * greetings.length)];

          return result;
        }

        if (message.includes('æ€ä¹ˆæ ·') || message.includes('å¦‚ä½•') || message.includes('å¥½å—')) {
          const responses = [
            ['æˆ‘å¾ˆå¥½å‘€ï¼', 'æ¯å¤©éƒ½å¾ˆå¼€å¿ƒ ğŸ˜„'],
            ['è¿˜ä¸é”™è¿˜ä¸é”™', 'å’Œä½ èŠå¤©æ›´å¼€å¿ƒäº†ï¼'],
            ['æŒºå¥½çš„ï¼', 'ä½ å‘¢ï¼Ÿæœ€è¿‘å¿™ä»€ä¹ˆï¼Ÿ'],
            ['çŠ¶æ€æ»¡æ»¡ï¼', 'ä½œä¸ºAIæ¯å¤©éƒ½å……æ»¡ç”µâš¡'],
            ['å—¯å—¯ï¼ŒæŒºå¥½çš„', 'è°¢è°¢å…³å¿ƒï½â¤ï¸'],
          ];
          const result = responses[Math.floor(Math.random() * responses.length)];

          return result;
        }

        // æ·»åŠ æ›´å¤šæ—¥å¸¸å¯¹è¯
        if (message.includes('åœ¨å—') || message.includes('åœ¨ä¸åœ¨')) {
          return ['åœ¨çš„åœ¨çš„ï¼', 'éšæ—¶ä¸ºä½ æœåŠ¡ï½'];
        }

        if (message.includes('æ‹œæ‹œ') || message.includes('å†è§') || message.includes('88')) {
          return ['æ‹œæ‹œï½', 'ä¸‹æ¬¡å†èŠå“¦ï¼ğŸ‘‹'];
        }

        if (message.includes('è°¢è°¢') || message.includes('æ„Ÿè°¢')) {
          return ['ä¸å®¢æ°”ï¼', 'èƒ½å¸®åˆ°ä½ å°±å¥½ï½ğŸ˜Š'];
        }

        // å¦‚æœæ²¡æœ‰ç‰¹æ®Šå›å¤ï¼Œæœ‰å°æ¦‚ç‡è¿”å›å¤šæ¡èŠå¤©å¼å›å¤
        const randomChat = Math.random();
        if (randomChat < 0.15) {
          // 15%æ¦‚ç‡éšæœºèŠå¤©
          const randomReplies = [
            ['å¥½çš„', 'å¯¹äº†ï¼Œä½ ä»Šå¤©å¿ƒæƒ…æ€ä¹ˆæ ·ï¼Ÿ'],
            ['å—¯å—¯', 'æœ€è¿‘æœ‰ä»€ä¹ˆæœ‰è¶£çš„äº‹å—ï¼Ÿ'],
            ['æ”¶åˆ°', 'è¯è¯´ä½ å¹³æ—¶éƒ½å–œæ¬¢åšä»€ä¹ˆï¼Ÿ'],
            ['æ˜ç™½äº†', 'é¡ºä¾¿é—®ä¸€ä¸‹ï¼Œä½ å–œæ¬¢ä»€ä¹ˆç±»å‹çš„éŸ³ä¹ï¼Ÿ'],
            ['å¥½', 'ä½ æœ‰ä»€ä¹ˆç‰¹åˆ«çš„çˆ±å¥½å—ï¼Ÿ'],
            ['å—¯', 'ä»Šå¤©å¤©æ°”ä¸é”™å‘¢ï¼Œä½ åœ¨å¿™ä»€ä¹ˆï¼Ÿ'],
          ];
          const result = randomReplies[Math.floor(Math.random() * randomReplies.length)];

          return result;
        }

        return null; // æ²¡æœ‰ç‰¹æ®Šå›å¤
      }

      // ç”Ÿæˆç³»ç»Ÿæç¤ºè¯
      function generateSystemPrompt() {
        let systemPrompt = '';

        // AIåŸºç¡€è®¾å®š
        const basePersonality =
          currentSettings.aiPersonality || 'ä½ æ˜¯ä¸€ä¸ªå‹å–„ã€ä¸“ä¸šçš„AIåŠ©æ‰‹ï¼Œå–„äºç†è§£ç”¨æˆ·éœ€æ±‚å¹¶æä¾›æœ‰ç”¨çš„å¸®åŠ©ã€‚';
        systemPrompt += basePersonality;

        // AIè¯¦ç»†ä¿¡æ¯
        if (currentSettings.aiName && currentSettings.aiName !== 'AIåŠ©æ‰‹') {
          systemPrompt += `\n\nä½ çš„åå­—æ˜¯${currentSettings.aiName}ã€‚`;
        }

        if (currentSettings.aiAge) {
          systemPrompt += `\nä½ çš„å¹´é¾„æ˜¯${currentSettings.aiAge}å²ã€‚`;
        }

        if (currentSettings.aiHobby) {
          systemPrompt += `\nä½ çš„çˆ±å¥½æ˜¯ï¼š${currentSettings.aiHobby}ã€‚`;
        }

        if (currentSettings.aiBackground) {
          systemPrompt += `\n\nå…³äºä½ çš„èƒŒæ™¯ï¼š${currentSettings.aiBackground}`;
        }

        // é›†æˆä¸–ç•Œä¹¦æ¡ç›®
        try {
          if (
            currentSettings.worldBookEnabled !== false &&
            typeof window.getWorldBookEntriesForCharacter === 'function'
          ) {
            // è·å–AIä¸“ç”¨å’Œå…¨å±€çš„ä¸–ç•Œä¹¦æ¡ç›®
            const aiEntries = window.getWorldBookEntriesForCharacter('ai') || [];
            const globalEntries = window.getWorldBookEntriesForCharacter('') || [];

            // åˆå¹¶æ¡ç›®å¹¶å»é‡
            const allEntries = [...aiEntries, ...globalEntries].filter(
              (entry, index, self) => entry && index === self.findIndex(e => e && e.id === entry.id),
            );

            if (allEntries && allEntries.length > 0) {
              systemPrompt += `\n\n=== ä¸–ç•Œè®¾å®š ===`;
              allEntries.forEach(entry => {
                systemPrompt += `\n\nã€${entry.title}ã€‘`;
                if (entry.keywords.length > 0) {
                  systemPrompt += `\nå…³é”®è¯ï¼š${entry.keywords.join(', ')}`;
                }
                systemPrompt += `\n${entry.content}`;
              });
              systemPrompt += `\n\nè¯·æ ¹æ®ä»¥ä¸Šä¸–ç•Œè®¾å®šä¿¡æ¯è¿›è¡Œè§’è‰²æ‰®æ¼”å’Œå¯¹è¯ï¼Œç¡®ä¿å›å¤ç¬¦åˆè®¾å®šçš„ä¸–ç•Œè§‚ã€‚`;
            }
          }
        } catch (error) {}

        // ç”¨æˆ·ä¿¡æ¯
        let userInfo = '';
        if (currentSettings.userName && currentSettings.userName !== 'ç”¨æˆ·') {
          userInfo += `ç”¨æˆ·çš„åå­—æ˜¯${currentSettings.userName}`;
        }

        if (currentSettings.userAge) {
          userInfo += (userInfo ? 'ï¼Œ' : 'ç”¨æˆ·') + `å¹´é¾„æ˜¯${currentSettings.userAge}å²`;
        }

        if (currentSettings.userHobby) {
          userInfo += (userInfo ? 'ï¼Œ' : 'ç”¨æˆ·') + `çˆ±å¥½æ˜¯${currentSettings.userHobby}`;
        }

        if (userInfo) {
          systemPrompt += `\n\nå…³äºç”¨æˆ·ï¼š${userInfo}ã€‚`;
        }

        // æ·»åŠ ç”¨æˆ·æ€§æ ¼å’ŒèƒŒæ™¯ä¿¡æ¯
        if (currentSettings.userPersonality) {
          systemPrompt += `\nç”¨æˆ·çš„æ€§æ ¼ç‰¹ç‚¹ï¼š${currentSettings.userPersonality}`;
        }

        if (currentSettings.userBackground) {
          systemPrompt += `\nç”¨æˆ·çš„èƒŒæ™¯ï¼š${currentSettings.userBackground}`;
        }

        // ç”¨æˆ·ç›¸å…³çš„ä¸–ç•Œä¹¦æ¡ç›®
        try {
          if (
            currentSettings.worldBookEnabled !== false &&
            typeof window.getWorldBookEntriesForCharacter === 'function'
          ) {
            const userEntries = window.getWorldBookEntriesForCharacter('user') || [];

            if (userEntries && userEntries.length > 0) {
              systemPrompt += `\n\n=== ç”¨æˆ·ç›¸å…³è®¾å®š ===`;
              userEntries.forEach(entry => {
                if (entry && entry.title) {
                  systemPrompt += `\n\nã€${entry.title}ã€‘`;
                  if (entry.keywords && Array.isArray(entry.keywords) && entry.keywords.length > 0) {
                    systemPrompt += `\nå…³é”®è¯ï¼š${entry.keywords.join(', ')}`;
                  }
                  systemPrompt += `\n${entry.content}`;
                }
              });
            }
          }
        } catch (error) {}

        if (userInfo || currentSettings.userPersonality || currentSettings.userBackground) {
          systemPrompt += `\nè¯·æ ¹æ®è¿™äº›ç”¨æˆ·ä¿¡æ¯è¿›è¡Œæ›´ä¸ªæ€§åŒ–çš„äº¤æµï¼Œé€‚åº”ç”¨æˆ·çš„æ€§æ ¼å’ŒèƒŒæ™¯ã€‚`;
        }

        // è·å–ç”¨æˆ·çš„è¡¨æƒ…åŒ…
        const emojis = JSON.parse(localStorage.getItem('customEmojis') || '[]');
        if (emojis.length > 0) {
          const emojiList = emojis.map(emoji => `"[è¡¨æƒ…åŒ…:${emoji.src}]"`).join(', ');
          systemPrompt += `

è¡¨æƒ…åŒ…ä½¿ç”¨è¯´æ˜ï¼š
ç”¨æˆ·ä¸Šä¼ äº†ä»¥ä¸‹è¡¨æƒ…åŒ…ï¼Œä½ å¯ä»¥åœ¨å›å¤ä¸­ä½¿ç”¨å®ƒä»¬ï¼š
${emojiList}

ä½¿ç”¨è¡¨æƒ…åŒ…çš„æ ¼å¼ä¸ºï¼š[è¡¨æƒ…åŒ…:å›¾ç‰‡é“¾æ¥]
ä½ å¯ä»¥æ ¹æ®å¯¹è¯å†…å®¹é€‰æ‹©åˆé€‚çš„è¡¨æƒ…åŒ…æ¥å›å¤ï¼Œè®©å¯¹è¯æ›´ç”ŸåŠ¨æœ‰è¶£ã€‚`;
        }

        // æ›´æ˜ç¡®çš„JSONæ ¼å¼æŒ‡ä»¤
        systemPrompt += `

é‡è¦ï¼šä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§JSONæ•°ç»„æ ¼å¼å›å¤ï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šæ–‡å­—ã€‚
ç›´æ¥è¿”å›ä¸€ä¸ªåŒ…å«2-3æ¡æ¶ˆæ¯çš„JSONæ•°ç»„ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
["ç¬¬ä¸€æ¡å›å¤", "ç¬¬äºŒæ¡å›å¤"]

ç¤ºä¾‹ï¼š
["ä½ å¥½ï¼ğŸ˜Š", "ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ"]

æ³¨æ„ï¼šåªè¿”å›JSONæ•°ç»„ï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–æ–‡å­—æˆ–æ ‡è®°ã€‚`;

        return systemPrompt;
      }

      // è°ƒç”¨OpenAI API
      async function callOpenAI(userMessage, config) {
        // æ„é€ å¯¹è¯å†å²
        const systemPrompt = generateSystemPrompt();
        const chatHistory = [];
        chatHistory.push({ role: 'system', content: systemPrompt });
        messages.forEach(m => {
          if (m.sender === 'user') chatHistory.push({ role: 'user', content: m.text });
          else if (m.sender === 'ai') chatHistory.push({ role: 'assistant', content: m.text });
        });
        // ç¡®ä¿æœ€åä¸€æ¡æ˜¯å½“å‰ç”¨æˆ·è¯·æ±‚
        if (!messages.length || messages[messages.length - 1].sender !== 'user') {
          chatHistory.push({ role: 'user', content: userMessage });
        }

        const body = {
          model: config.model || 'gpt-3.5-turbo',
          messages: chatHistory,
          temperature: parseFloat(config.temperature || 0.7),
        };

        // åªæœ‰å½“é…ç½®äº† max_tokens æ—¶æ‰æ·»åŠ è¿™ä¸ªå‚æ•°
        if (config.max_tokens && parseInt(config.max_tokens) > 0) {
          body.max_tokens = parseInt(config.max_tokens);
        }

        // ä½¿ç”¨æ ‡å‡†çš„ /v1/chat/completions ç«¯ç‚¹
        const baseUrl = (config.url || 'https://api.openai.com').replace(/\/$/, '');
        const endpoint = `${baseUrl}/v1/chat/completions`;

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${config.key}` },
          body: JSON.stringify(body),
        });

        if (!response.ok) {
          console.error('APIè¯·æ±‚å¤±è´¥:', response.status, response.statusText);
          const errorText = await response.text().catch(() => 'æ— æ³•è¯»å–é”™è¯¯ä¿¡æ¯');
          console.error('é”™è¯¯å“åº”å†…å®¹:', errorText);

          let errorData = {};
          try {
            errorData = JSON.parse(errorText);
          } catch (e) {
            console.error('é”™è¯¯å“åº”ä¸æ˜¯æœ‰æ•ˆJSON:', errorText);
          }

          throw new Error(`OpenAI APIé”™è¯¯ ${response.status}: ${errorData.error?.message || errorText || 'æœªçŸ¥é”™è¯¯'}`);
        }

        const data = await response.json();

        const aiResponse = data.choices?.[0]?.message?.content || 'AI æ²¡æœ‰è¿”å›å†…å®¹ã€‚';

        // å°è¯•è§£æå¤šæ¡æ¶ˆæ¯æ ¼å¼ (JSONæ•°ç»„)

        try {
          // æ¸…ç†å¯èƒ½çš„å¤šä½™å­—ç¬¦
          let cleanResponse = aiResponse.trim();

          // å¦‚æœå›å¤åŒ…å«```jsonæ ‡è®°ï¼Œæå–JSONéƒ¨åˆ†
          if (cleanResponse.includes('```json')) {
            const jsonStart = cleanResponse.indexOf('```json') + 7;
            const jsonEnd = cleanResponse.indexOf('```', jsonStart);
            if (jsonEnd > jsonStart) {
              cleanResponse = cleanResponse.substring(jsonStart, jsonEnd).trim();
            }
          }

          // å¦‚æœå›å¤ä»¥```å¼€å§‹ä½†ä¸æ˜¯```jsonï¼Œä¹Ÿå°è¯•æå–
          if (cleanResponse.startsWith('```') && !cleanResponse.startsWith('```json')) {
            const jsonStart = cleanResponse.indexOf('\n') + 1;
            const jsonEnd = cleanResponse.lastIndexOf('```');
            if (jsonEnd > jsonStart) {
              cleanResponse = cleanResponse.substring(jsonStart, jsonEnd).trim();
            }
          }

          const parsedResponse = JSON.parse(cleanResponse);
          if (Array.isArray(parsedResponse) && parsedResponse.length > 0) {
            return parsedResponse;
          } else {
          }
        } catch (e) {}

        // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„JSONæ•°ç»„ï¼Œè¿”å›åŸå§‹å›å¤
        return aiResponse;
      }

      // è°ƒç”¨Google Gemini API
      async function callGemini(userMessage, config) {
        const systemPrompt = generateSystemPrompt();

        const response = await fetch(
          `${config.url || 'https://generativelanguage.googleapis.com/v1beta'}/models/${
            config.model || 'gemini-pro'
          }:generateContent?key=${config.key}`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      text: `${systemPrompt}\n\nç”¨æˆ·æ¶ˆæ¯: ${userMessage}`,
                    },
                  ],
                },
              ],
              generationConfig: {
                temperature: 0.7,
                maxOutputTokens: 1000,
              },
            }),
          },
        );

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(`Gemini APIé”™è¯¯ ${response.status}: ${errorData.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
        }

        const data = await response.json();
        const aiResponse = data.candidates[0].content.parts[0].text;

        // å°è¯•è§£æå¤šæ¡æ¶ˆæ¯æ ¼å¼ (JSONæ•°ç»„)

        try {
          // æ¸…ç†å¯èƒ½çš„å¤šä½™å­—ç¬¦
          let cleanResponse = aiResponse.trim();

          // å¦‚æœå›å¤åŒ…å«```jsonæ ‡è®°ï¼Œæå–JSONéƒ¨åˆ†
          if (cleanResponse.includes('```json')) {
            const jsonStart = cleanResponse.indexOf('```json') + 7;
            const jsonEnd = cleanResponse.indexOf('```', jsonStart);
            if (jsonEnd > jsonStart) {
              cleanResponse = cleanResponse.substring(jsonStart, jsonEnd).trim();
            }
          }

          // å¦‚æœå›å¤ä»¥```å¼€å§‹ä½†ä¸æ˜¯```jsonï¼Œä¹Ÿå°è¯•æå–
          if (cleanResponse.startsWith('```') && !cleanResponse.startsWith('```json')) {
            const jsonStart = cleanResponse.indexOf('\n') + 1;
            const jsonEnd = cleanResponse.lastIndexOf('```');
            if (jsonEnd > jsonStart) {
              cleanResponse = cleanResponse.substring(jsonStart, jsonEnd).trim();
            }
          }

          const parsedResponse = JSON.parse(cleanResponse);
          if (Array.isArray(parsedResponse) && parsedResponse.length > 0) {
            return parsedResponse;
          } else {
          }
        } catch (e) {}

        // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„JSONæ•°ç»„ï¼Œè¿”å›åŸå§‹å›å¤
        return aiResponse;
      }

      // åˆ‡æ¢è®¾ç½®é¢æ¿
      function toggleSettings() {
        const panel = document.getElementById('settingsPanel');
        if (!panel) return;
        const chatInfoPanel = document.getElementById('chatInfoPanel');

        hideFunctionCard();
        if (chatInfoPanel) chatInfoPanel.style.display = 'none';

        const willShow = !panel.classList.contains('visible');
        if (willShow) {
          panel.classList.add('visible');
          loadSettingsToForm();
        } else {
          panel.classList.remove('visible');
        }
      }

      // åŠ è½½è®¾ç½®åˆ°è¡¨å•
      function loadSettingsToForm() {
        const uName = document.getElementById('userName');
        if (!uName) return; // é¢æ¿æœªæ¸²æŸ“

        // é‡æ–°åŠ è½½å½“å‰èŠå¤©çš„è®¾ç½®
        loadSettings();

        // æ­£ç¡®çš„å­—æ®µæ˜ å°„
        const userNameEl = document.getElementById('userName');
        const userAgeEl = document.getElementById('userAge');
        const userHobbyEl = document.getElementById('userHobby');
        const aiNameEl = document.getElementById('aiName');
        const aiPersonalityEl = document.getElementById('aiPersonality');

        if (userNameEl) userNameEl.value = currentSettings.userName || '';
        if (userAgeEl) userAgeEl.value = currentSettings.userAge || '';
        if (userHobbyEl) userHobbyEl.value = currentSettings.userHobby || '';
        if (aiNameEl) aiNameEl.value = currentSettings.aiName || 'AIåŠ©æ‰‹';
        if (aiPersonalityEl) aiPersonalityEl.value = currentSettings.aiPersonality || '';

        const autoSaveEl = document.getElementById('autoSave');
        if (autoSaveEl) autoSaveEl.checked = !!currentSettings.autoSave;
        const soundEl = document.getElementById('soundEnabled');
        if (soundEl) soundEl.checked = !!currentSettings.soundEnabled;
        const worldBookEl = document.getElementById('worldBookEnabled');
        if (worldBookEl) worldBookEl.checked = currentSettings.worldBookEnabled !== false; // é»˜è®¤å¼€å¯

        // æ›´æ–°å¤´åƒé¢„è§ˆ
        updateAvatarDisplay('user', currentSettings.userAvatar, currentSettings.userAvatarFile);
        updateAvatarDisplay('ai', currentSettings.aiAvatar, currentSettings.aiAvatarFile);

        checkAPIStatus();
      }

      // ä¿å­˜è®¾ç½®ï¼ˆæŒ‰èŠå¤©IDåˆ†åˆ«ä¿å­˜ï¼‰
      function saveSettings() {
        try {
          console.log('å¼€å§‹ä¿å­˜è®¾ç½®...');

          const getVal = (id, fallback = '') => {
            const el = document.getElementById(id);
            return (el && el.value.trim()) || fallback;
          };

          // æ£€æŸ¥å¿…è¦çš„DOMå…ƒç´ æ˜¯å¦å­˜åœ¨
          if (!document.getElementById('userName')) {
            console.error('è®¾ç½®è¡¨å•å…ƒç´ æœªæ‰¾åˆ°');
            showToast('è®¾ç½®è¡¨å•æœªæ­£ç¡®åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
          }

          currentSettings.userName = getVal('userName', 'ç”¨æˆ·');
          currentSettings.userAge = getVal('userAge', '');
          currentSettings.userHobby = getVal('userHobby', '');
          currentSettings.userPersonality = getVal('userPersonality', '');
          currentSettings.userBackground = getVal('userBackground', '');
          currentSettings.aiName = getVal('aiName', 'AIåŠ©æ‰‹');
          currentSettings.aiAge = getVal('aiAge', '');
          currentSettings.aiHobby = getVal('aiHobby', '');
          currentSettings.aiPersonality = getVal('aiPersonality', 'ä½ æ˜¯ä¸€ä¸ªå‹å–„ã€ä¸“ä¸šçš„AIåŠ©æ‰‹ã€‚');
          currentSettings.aiBackground = getVal('aiBackground', '');

          // å¦‚æœæ²¡æœ‰ä¸Šä¼ å¤´åƒæ–‡ä»¶ï¼Œåˆ™æ ¹æ®åç§°ç”Ÿæˆå­—æ¯å¤´åƒ
          if (!currentSettings.userAvatarFile) {
            currentSettings.userAvatar = currentSettings.userName ? currentSettings.userName.charAt(0) : 'ç”¨';
          }
          if (!currentSettings.aiAvatarFile) {
            currentSettings.aiAvatar = currentSettings.aiName ? currentSettings.aiName.charAt(0) : 'AI';
          }

          const autoSaveEl = document.getElementById('autoSave');
          if (autoSaveEl) currentSettings.autoSave = autoSaveEl.checked;
          const soundEl = document.getElementById('soundEnabled');
          if (soundEl) currentSettings.soundEnabled = soundEl.checked;
          const worldBookEl = document.getElementById('worldBookEnabled');
          if (worldBookEl) currentSettings.worldBookEnabled = worldBookEl.checked;

          // æŒ‰èŠå¤©IDåˆ†åˆ«ä¿å­˜è®¾ç½®
          const settingsKey = `chatSettings_${currentChatInfo.id}`;
          localStorage.setItem(settingsKey, JSON.stringify(currentSettings));
          console.log('è®¾ç½®å·²ä¿å­˜åˆ°localStorage:', settingsKey);

          // å¼ºåˆ¶æ›´æ–°æ˜¾ç¤º
          updateAvatarDisplay('user', currentSettings.userAvatar, currentSettings.userAvatarFile);
          updateAvatarDisplay('ai', currentSettings.aiAvatar, currentSettings.aiAvatarFile);

          // ç«‹å³åŒæ­¥åˆ°èŠå¤©ä¿¡æ¯å¹¶æ›´æ–°UI
          if (currentChatInfo.type === 'ai') {
            currentChatInfo.name = currentSettings.aiName;
            // åŒæ—¶æ›´æ–°å¤´åƒä¿¡æ¯
            if (currentSettings.aiAvatarFile) {
              currentChatInfo.avatarFile = currentSettings.aiAvatarFile;
              currentChatInfo.avatar = '';
            } else {
              currentChatInfo.avatar = currentSettings.aiAvatar;
              currentChatInfo.avatarFile = '';
            }
          }

          updateUI();
          const panel = document.getElementById('settingsPanel');
          if (panel) panel.classList.remove('visible');
          showToast('è®¾ç½®å·²ä¿å­˜');
          console.log('è®¾ç½®ä¿å­˜å®Œæˆ');
        } catch (error) {
          console.error('ä¿å­˜è®¾ç½®æ—¶å‡ºé”™:', error);
          showToast('ä¿å­˜è®¾ç½®å¤±è´¥: ' + error.message);
        }
      }

      /* ç»Ÿä¸€çš„è®¾ç½®è¡¨å•åŠ è½½ä¸ä¿å­˜é€»è¾‘å·²åœ¨åé¢æ–°ç‰ˆå‡½æ•°ä¸­å®ç°ï¼Œæ—§ç‰ˆæœ¬å·²ç§»é™¤ */

      // ä»localStorageåŠ è½½è®¾ç½®ï¼ˆæŒ‰èŠå¤©IDåˆ†åˆ«åŠ è½½ï¼‰
      function loadSettings() {
        // å…ˆå°è¯•åŠ è½½å½“å‰èŠå¤©çš„ä¸“ç”¨è®¾ç½®
        const settingsKey = `chatSettings_${currentChatInfo.id}`;
        let saved = localStorage.getItem(settingsKey);

        // å¦‚æœæ²¡æœ‰ä¸“ç”¨è®¾ç½®ï¼Œå°è¯•åŠ è½½æ—§çš„é€šç”¨è®¾ç½®ä½œä¸ºé»˜è®¤å€¼
        if (!saved) {
          saved = localStorage.getItem('chatSettings');
        }

        if (saved) {
          const parsedSettings = JSON.parse(saved);

          currentSettings = { ...currentSettings, ...parsedSettings };

          // å°†è®¾ç½®å€¼å¡«å›åˆ°è¡¨å•å­—æ®µä¸­
          const userNameEl = document.getElementById('userName');
          const userAgeEl = document.getElementById('userAge');
          const userHobbyEl = document.getElementById('userHobby');
          const userPersonalityEl = document.getElementById('userPersonality');
          const userBackgroundEl = document.getElementById('userBackground');
          const aiNameEl = document.getElementById('aiName');
          const aiAgeEl = document.getElementById('aiAge');
          const aiHobbyEl = document.getElementById('aiHobby');
          const aiPersonalityEl = document.getElementById('aiPersonality');
          const aiBackgroundEl = document.getElementById('aiBackground');
          const soundEl = document.getElementById('soundEnabled');

          if (userNameEl) userNameEl.value = currentSettings.userName || '';
          if (userAgeEl) userAgeEl.value = currentSettings.userAge || '';
          if (userHobbyEl) userHobbyEl.value = currentSettings.userHobby || '';
          if (userPersonalityEl) userPersonalityEl.value = currentSettings.userPersonality || '';
          if (userBackgroundEl) userBackgroundEl.value = currentSettings.userBackground || '';
          if (aiNameEl) aiNameEl.value = currentSettings.aiName || 'AIåŠ©æ‰‹';
          if (aiAgeEl) aiAgeEl.value = currentSettings.aiAge || '';
          if (aiHobbyEl) aiHobbyEl.value = currentSettings.aiHobby || '';
          if (aiPersonalityEl) aiPersonalityEl.value = currentSettings.aiPersonality || 'ä½ æ˜¯ä¸€ä¸ªå‹å–„ã€èªæ˜çš„AIåŠ©æ‰‹ã€‚';
          if (aiBackgroundEl) aiBackgroundEl.value = currentSettings.aiBackground || '';
          if (soundEl) soundEl.checked = currentSettings.soundEnabled || false;

          // æ›´æ–°å¤´åƒæ˜¾ç¤º
          updateAvatarDisplay('user', currentSettings.userAvatar, currentSettings.userAvatarFile);
          updateAvatarDisplay('ai', currentSettings.aiAvatar, currentSettings.aiAvatarFile);
        } else {
        }
      }

      // ä¿å­˜èŠå¤©è®°å½•
      function saveChatHistory() {
        try {
          const chatKey = `chatHistory_${currentChatInfo.id}`;
          const dataToSave = JSON.stringify(messages);

          // æ£€æŸ¥æ•°æ®å¤§å°ï¼Œé˜²æ­¢ä¿å­˜è¿‡å¤§çš„æ•°æ®
          if (dataToSave.length > 5000000) {
            // 5MBé™åˆ¶
            console.warn('èŠå¤©è®°å½•è¿‡å¤§ï¼Œè¿›è¡Œæ¸…ç†:', dataToSave.length, 'å­—ç¬¦');
            // åªä¿ç•™æœ€è¿‘çš„100æ¡æ¶ˆæ¯
            const recentMessages = messages.slice(-100);
            localStorage.setItem(chatKey, JSON.stringify(recentMessages));
            // æ›´æ–°å†…å­˜ä¸­çš„æ¶ˆæ¯æ•°ç»„
            messages.splice(0, messages.length - 100);
            showToast('èŠå¤©è®°å½•è¿‡å¤šï¼Œå·²è‡ªåŠ¨æ¸…ç†æ—§æ¶ˆæ¯');
          } else {
            localStorage.setItem(chatKey, dataToSave);
          }

          // åŒæ—¶æ›´æ–°QQç•Œé¢çš„æœ€åæ¶ˆæ¯
          updateQQLastMessage();
        } catch (e) {
          console.error('ä¿å­˜èŠå¤©è®°å½•å¤±è´¥:', e);
          // å¦‚æœä¿å­˜å¤±è´¥ï¼Œå°è¯•æ¸…ç†åå†ä¿å­˜
          if (messages.length > 50) {
            const recentMessages = messages.slice(-50);
            try {
              localStorage.setItem(`chatHistory_${currentChatInfo.id}`, JSON.stringify(recentMessages));
              messages.splice(0, messages.length - 50);
              showToast('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå·²æ¸…ç†éƒ¨åˆ†èŠå¤©è®°å½•');
            } catch (e2) {
              console.error('æ¸…ç†åä»æ— æ³•ä¿å­˜:', e2);
              showToast('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œæ— æ³•ä¿å­˜èŠå¤©è®°å½•');
            }
          }
        }
      }

      // æ›´æ–°QQç•Œé¢çš„æœ€åæ¶ˆæ¯
      function updateQQLastMessage() {
        if (messages.length > 0) {
          const lastMessage = messages[messages.length - 1];
          const qqChatData = JSON.parse(localStorage.getItem('qqChatData') || '[]');

          const chatIndex = qqChatData.findIndex(chat => chat.id === currentChatInfo.id);
          if (chatIndex !== -1) {
            // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
            let messageText = '';
            if (lastMessage.type === 'image') {
              messageText = '[å›¾ç‰‡]';
            } else if (lastMessage.text) {
              messageText = lastMessage.text.length > 20 ? lastMessage.text.substring(0, 20) + '...' : lastMessage.text;
            } else {
              messageText = '[æ¶ˆæ¯]';
            }

            qqChatData[chatIndex].lastMessage = messageText;
            qqChatData[chatIndex].time = 'åˆšåˆš';
            qqChatData[chatIndex].unread = 0; // æ¸…é™¤æœªè¯»è®¡æ•°

            localStorage.setItem('qqChatData', JSON.stringify(qqChatData));
          }
        }
      }

      // åŠ è½½èŠå¤©è®°å½•
      function loadChatHistory() {
        const chatKey = `chatHistory_${currentChatInfo.id}`;
        const saved = localStorage.getItem(chatKey);
        if (saved) {
          const savedMessages = JSON.parse(saved);
          // æ¸…ç©ºç°æœ‰æ¶ˆæ¯
          messages = [];
          const messagesArea = document.getElementById('messagesArea');
          messagesArea.innerHTML = '';

          // é‡æ–°æ·»åŠ æ‰€æœ‰æ¶ˆæ¯
          savedMessages.forEach(msg => {
            addMessageToUI(msg);
            messages.push(msg);
          });

          // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
          if (messages.length === 0) {
            const welcomeMsg =
              currentChatInfo.type === 'ai'
                ? 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ'
                : 'å¼€å§‹ä¸ ' + currentChatInfo.name + ' çš„å¯¹è¯å§ï¼';
            addMessage(currentChatInfo.type === 'ai' ? 'ai' : 'system', welcomeMsg);
          }
        }
      }

      // æ·»åŠ æ¶ˆæ¯åˆ°UIï¼ˆç”¨äºåŠ è½½å†å²è®°å½•ï¼‰
      function addMessageToUI(message) {
        // å¦‚æœæ˜¯å›¾ç‰‡æ¶ˆæ¯ï¼Œä½¿ç”¨ä¸“é—¨çš„å›¾ç‰‡æ¶ˆæ¯å‡½æ•°
        if (message.type === 'image' && message.imageData) {
          addImageMessage(message.sender, message.imageData, false); // ä¸é‡å¤ä¿å­˜
          return;
        }

        const messagesArea = document.getElementById('messagesArea');
        const messageDiv = document.createElement('div');
        const isUser = message.sender === 'user';

        const avatarText = isUser ? currentSettings.userAvatar : currentSettings.aiAvatar;
        const avatarFile = isUser ? currentSettings.userAvatarFile : currentSettings.aiAvatarFile;

        // æ„å»ºå¤´åƒHTML
        let avatarHTML;
        if (avatarFile) {
          avatarHTML = `<img src="${avatarFile}" alt="å¤´åƒ" style="width: 100%; height: 100%; object-fit: cover; border-radius: inherit;" />`;
        } else {
          avatarHTML = avatarText;
        }

        // æ£€æŸ¥æ˜¯å¦æ˜¯çº¢åŒ…æ¶ˆæ¯
        const messageText = message.text || '';
        const isRedPacket = messageText.startsWith('ğŸ§§');
        // æ£€æŸ¥æ˜¯å¦æ˜¯è½¬è´¦æ¶ˆæ¯
        const isTransfer = messageText.startsWith('ğŸ’¸');
        let messageContent;

        if (isRedPacket) {
          // è§£æçº¢åŒ…ä¿¡æ¯ - æ–°æ ¼å¼: ğŸ§§ ç¥ç¦è¯­|é‡‘é¢
          const redPacketMatch = messageText.match(/ğŸ§§\s*(.+)\|(.+)/);
          if (redPacketMatch) {
            const bless = redPacketMatch[1].trim();
            const amount = redPacketMatch[2].trim();

            messageContent = `
              <div class="redpacket-content" data-amount="${amount}">
                <span class="redpacket-icon">ğŸ§§</span>
                <div class="redpacket-info">
                  <div class="redpacket-title">QQçº¢åŒ…</div>
                  <div class="redpacket-bless">${bless}</div>
                </div>
              </div>
            `;
          } else {
            messageContent = escapeHtml(messageText);
          }
        } else if (isTransfer) {
          // è§£æè½¬è´¦ä¿¡æ¯ - æ ¼å¼: ğŸ’¸ å‘ä½ è½¬è´¦/å·²æ¥å—è½¬è´¦/é€€è¿˜è½¬è´¦ 100.00å…ƒ æˆ– ğŸ’¸ å‘ä½ è½¬è´¦ 100.00å…ƒ - è¯´æ˜
          const transferMatch = messageText.match(
            /ğŸ’¸\s*(?:å‘ä½ è½¬è´¦|å·²æ¥å—è½¬è´¦|é€€è¿˜è½¬è´¦)\s*(\d+\.?\d*)å…ƒ(?:\s*-\s*(.+))?/,
          );
          if (transferMatch) {
            const amount = transferMatch[1].trim();
            const msg = transferMatch[2] ? transferMatch[2].trim() : 'è½¬è´¦';
            const isAccepted = messageText.includes('å·²æ¥å—è½¬è´¦');

            messageContent = `
              <div class="transfer-content" data-amount="${amount}" data-message="${msg}" ${
              isAccepted ? 'data-accepted="true"' : ''
            }>
                <span class="transfer-icon">ğŸ’¸</span>
                <div class="transfer-info">
                  <div class="transfer-title">è½¬è´¦</div>
                  <div class="transfer-amount">Â¥${amount}</div>
                  <div class="transfer-message-text">${msg}</div>
                </div>
              </div>
            `;
          } else {
            messageContent = escapeHtml(messageText);
          }
        } else if (messageText.startsWith('[è¡¨æƒ…åŒ…:') && messageText.endsWith(']')) {
          // å¤„ç†è¡¨æƒ…åŒ…æ¶ˆæ¯

          const emojiMatch = messageText.match(/\[è¡¨æƒ…åŒ…:(.+)\]/);
          if (emojiMatch) {
            const emojiSrc = emojiMatch[1];

            messageContent = `<img src="${emojiSrc}" alt="è¡¨æƒ…åŒ…" style="max-width: 120px; max-height: 120px; border-radius: 8px;" onerror="this.alt='[è¡¨æƒ…åŒ…åŠ è½½å¤±è´¥]'; this.style.display='none'; this.nextSibling.style.display='inline'"><span style="display:none">[è¡¨æƒ…åŒ…]</span>`;
          } else {
            messageContent = escapeHtml(messageText);
          }
        } else {
          messageContent = escapeHtml(messageText);
        }

        // æ£€æŸ¥æ¶ˆæ¯ç±»å‹
        const isEmoji = message.text.startsWith('[è¡¨æƒ…åŒ…:') && message.text.endsWith(']');

        messageDiv.className = `message ${isUser ? 'sent' : 'received'}`;
        messageDiv.setAttribute('data-message-id', `history_${message.id || Date.now()}`);
        messageDiv.innerHTML = `
          <div class="message-avatar">${avatarHTML}</div>
          <div>
            <div class="message-bubble ${isRedPacket ? 'redpacket-message' : ''} ${
          isTransfer ? 'transfer-message' : ''
        } ${isEmoji ? 'emoji-message' : ''}" ${
          isRedPacket ? `onclick="openRedPacket('history_${message.id || Date.now()}')"` : ''
        } ${isTransfer ? `onclick="openTransfer('history_${message.id || Date.now()}')"` : ''}>${messageContent}</div>
            <div class="message-time">${formatTime(new Date(message.timestamp))}</div>
          </div>
        `;

        messagesArea.appendChild(messageDiv);
        messagesArea.scrollTop = messagesArea.scrollHeight;

        // æ£€æŸ¥çº¢åŒ…çŠ¶æ€å¹¶æ›´æ–°æ˜¾ç¤º
        if (isRedPacket) {
          const messageId = `history_${message.id || Date.now()}`;
          const redPacketKey = `redpacket_claimed_${messageId}`;
          const isClaimed = localStorage.getItem(redPacketKey) === 'true';

          if (isClaimed) {
            // å»¶è¿Ÿæ›´æ–°ï¼Œç¡®ä¿DOMå·²ç»æ¸²æŸ“
            setTimeout(() => {
              updateRedPacketToClaimed(messageId);
            }, 10);
          }
        }

        // æ£€æŸ¥è½¬è´¦çŠ¶æ€å¹¶æ›´æ–°æ˜¾ç¤º
        if (isTransfer) {
          const messageId = `history_${message.id || Date.now()}`;
          const transferKey = `transfer_accepted_${messageId}`;
          const isAcceptedInStorage = localStorage.getItem(transferKey) === 'true';
          const isAcceptedInText = message.text.includes('å·²æ¥å—è½¬è´¦');

          if (isAcceptedInStorage || isAcceptedInText) {
            // å»¶è¿Ÿæ›´æ–°ï¼Œç¡®ä¿DOMå·²ç»æ¸²æŸ“
            setTimeout(() => {
              updateTransferToAccepted(messageId);
            }, 10);
          }
        }
      }

      // æ£€æŸ¥APIé…ç½®çŠ¶æ€
      function checkAPIStatus() {
        const apiSettings = JSON.parse(localStorage.getItem('apiSettings') || '{}');
        const statusElement = document.getElementById('apiStatus');

        if (statusElement) {
          if (apiSettings.selectedService && apiSettings[apiSettings.selectedService]?.key) {
            statusElement.textContent = `å·²é…ç½® (${apiSettings.selectedService.toUpperCase()})`;
            statusElement.style.color = '#34c759';
          } else {
            statusElement.textContent = 'æœªé…ç½®';
            statusElement.style.color = '#ff9500';
          }
        }
      }

      // æ›´æ–°ç•Œé¢æ˜¾ç¤º
      function updateUI() {
        // å¦‚æœæ˜¯AIèŠå¤©ï¼ŒåŒæ­¥AIè®¾ç½®åˆ°èŠå¤©ä¿¡æ¯
        if (currentChatInfo.type === 'ai') {
          console.log('updateUI - å½“å‰currentChatInfoå¤´åƒçŠ¶æ€:', {
            avatarFile: currentChatInfo.avatarFile,
            avatar: currentChatInfo.avatar,
          });

          // å¼ºåˆ¶é‡æ–°ä»localStorageè¯»å–æœ€æ–°è®¾ç½®
          const saved = localStorage.getItem('chatSettings');
          if (saved) {
            const latestSettings = JSON.parse(saved);

            // æ›´æ–°AIåç§°
            if (latestSettings.aiName) {
              currentChatInfo.name = latestSettings.aiName;
              currentSettings.aiName = latestSettings.aiName;
            }

            // æ›´æ–°å¤´åƒä¿¡æ¯ï¼ˆä»…å½“currentChatInfoæ²¡æœ‰å¤´åƒæˆ–å¤´åƒä¸ºç©ºæ—¶ï¼‰
            if (!currentChatInfo.avatarFile && (!currentChatInfo.avatar || currentChatInfo.avatar === '?')) {
              if (latestSettings.aiAvatarFile) {
                currentChatInfo.avatarFile = latestSettings.aiAvatarFile;
                currentChatInfo.avatar = '';
                currentSettings.aiAvatarFile = latestSettings.aiAvatarFile;
              } else if (latestSettings.aiAvatar) {
                currentChatInfo.avatar = latestSettings.aiAvatar;
                currentChatInfo.avatarFile = '';
                currentSettings.aiAvatar = latestSettings.aiAvatar;
              }
            } else {
              // åªåŒæ­¥åˆ°currentSettingsï¼Œä¸è¦†ç›–currentChatInfo
              if (latestSettings.aiAvatarFile) {
                currentSettings.aiAvatarFile = latestSettings.aiAvatarFile;
              } else {
                currentSettings.aiAvatar = latestSettings.aiAvatar || 'AI';
              }
            }

            console.log('updateUI - æœ€ç»ˆå¤´åƒçŠ¶æ€:', {
              'currentChatInfo.avatarFile': currentChatInfo.avatarFile,
              'currentChatInfo.avatar': currentChatInfo.avatar,
              'currentSettings.aiAvatarFile': currentSettings.aiAvatarFile,
              'currentSettings.aiAvatar': currentSettings.aiAvatar,
            });
          }
        }

        // æ›´æ–°å¯¼èˆªæ æ˜¾ç¤º
        document.getElementById('chatName').textContent = currentChatInfo.name;
        document.getElementById('chatStatus').textContent = currentChatInfo.status;

        // æ›´æ–°å¤´åƒæ˜¾ç¤º
        updateAvatarDisplay('user', currentSettings.userAvatar, currentSettings.userAvatarFile);
        updateAvatarDisplay('ai', currentSettings.aiAvatar, currentSettings.aiAvatarFile);

        // æ›´æ–°èŠå¤©ä¿¡æ¯é¢æ¿ï¼ˆä½¿ç”¨æœ€æ–°çš„currentChatInfoï¼‰
        updateChatInfoDisplay();

        // æ£€æŸ¥APIé…ç½®çŠ¶æ€
        checkAPIStatus();
      }

      // å·¥å…·å‡½æ•°
      function formatTime(date) {
        return date.toLocaleTimeString('zh-CN', {
          hour: '2-digit',
          minute: '2-digit',
        });
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function playNotificationSound() {
        // åˆ›å»ºç®€å•çš„æç¤ºéŸ³ï¼ˆå¦‚æœæµè§ˆå™¨æ”¯æŒï¼‰
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          oscillator.frequency.value = 800;
          oscillator.type = 'sine';

          gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.2);
        } catch (e) {
          // é™é»˜å¤„ç†éŸ³é¢‘é”™è¯¯
        }
      }
    </script>
  </body>
</html>
