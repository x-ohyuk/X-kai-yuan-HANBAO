<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>APIè®¾ç½®</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Segoe UI', Roboto, Arial,
          sans-serif;
        background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .iphone-frame {
        width: 390px;
        height: 844px;
        border-radius: 54px;
        background: linear-gradient(180deg, #4a7fb4 0%, #5474a7 50%, #537096 100%);
        border: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6), inset 0 -6px 18px rgba(0, 0, 0, 0.06),
          0 12px 36px rgba(20, 30, 48, 0.12);
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .screen {
        width: 370px;
        height: 804px;
        border-radius: 44px;
        background: linear-gradient(135deg, #60aaff 0%, #b8e0ff 100%);
        position: relative;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        padding: 20px;
      }
      /* çµåŠ¨å²› */
      .dynamic-island {
        position: absolute;
        top: 18px;
        left: 50%;
        transform: translateX(-50%);
        width: 120px;
        height: 36px;
        background: #0b0b0b;
        border-radius: 18px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
        z-index: 10;
      }
      /* çŠ¶æ€æ  */
      .status-bar {
        position: absolute;
        top: 6px;
        left: 0;
        width: 100%;
        height: 48px;
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        padding: 6px 18px;
        color: #fff;
        font-size: 15px;
        pointer-events: none;
      }
      .status-left {
        font-weight: 600;
      }
      .status-right {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      /* æ ‡é¢˜æ  */
      .header {
        margin-top: 70px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .back-btn {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: #fff;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 150ms ease;
      }
      .back-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }
      .title {
        font-size: 28px;
        font-weight: 700;
        color: #fff;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      /* å†…å®¹åŒº */
      .content {
        flex: 1;
        overflow-y: auto;
        padding-bottom: 20px;
      }
      .api-section {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 20px;
        padding: 20px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      }
      .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #fff;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .form-group {
        margin-bottom: 16px;
      }
      .form-label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 6px;
      }
      .form-input {
        width: 100%;
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.9);
        font-size: 16px;
        color: #333;
        transition: all 150ms ease;
      }
      .form-input:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.6);
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
      }
      .form-input::placeholder {
        color: rgba(0, 0, 0, 0.4);
      }
      .form-select {
        width: 100%;
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.9);
        font-size: 16px;
        color: #333;
        cursor: pointer;
      }
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.3);
        transition: 0.4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: '';
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #4caf50;
      }
      input:checked + .slider:before {
        transform: translateX(26px);
      }
      .test-btn {
        background: linear-gradient(135deg, #00d4aa 0%, #00b894 100%);
        border: none;
        border-radius: 12px;
        padding: 12px 20px;
        color: white;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 150ms ease;
        margin-top: 8px;
      }
      .test-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 212, 170, 0.3);
      }
      .save-btn {
        background: linear-gradient(135deg, #6c5ce7 0%, #5a4fcf 100%);
        border: none;
        border-radius: 16px;
        padding: 16px 32px;
        color: white;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 150ms ease;
        width: 100%;
        margin-top: 20px;
      }
      .save-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(108, 92, 231, 0.3);
      }
    </style>
  </head>
  <body>
    <div class="iphone-frame">
      <div class="screen">
        <div class="dynamic-island"></div>
        <div class="status-bar">
          <div class="status-left" id="currentTime">13:28</div>
          <div class="status-right"><span style="color: #00d4aa">100%ğŸ”‹</span></div>
        </div>

        <div class="header">
          <button class="back-btn" onclick="history.back()">â†</button>
          <h1 class="title">APIè®¾ç½®</h1>
        </div>

        <div class="content">
          <!-- OpenAI API é…ç½® -->
          <div class="api-section">
            <h2 class="section-title">ğŸ¤– OpenAI API</h2>

            <div class="form-group">
              <label class="form-label">å¯ç”¨ OpenAI API</label>
              <label class="toggle-switch">
                <input type="checkbox" id="openai-enabled" checked />
                <span class="slider"></span>
              </label>
            </div>

            <div class="form-group">
              <label class="form-label" for="openai-url">API åœ°å€</label>
              <input type="url" id="openai-url" class="form-input" placeholder="https://ä½ çš„newapiæœåŠ¡å™¨åœ°å€" />
            </div>

            <div class="form-group">
              <label class="form-label" for="openai-key">API å¯†é’¥</label>
              <input type="password" id="openai-key" class="form-input" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx" />
            </div>

            <div class="form-group">
              <label class="form-label" for="openai-model">é»˜è®¤æ¨¡å‹</label>
              <select id="openai-model" class="form-select">
                <option value="">è¯·å…ˆæµ‹è¯•è¿æ¥ä»¥è·å–å¯ç”¨æ¨¡å‹</option>
              </select>
            </div>

            <button class="test-btn" onclick="testOpenAI()">æµ‹è¯•è¿æ¥</button>
          </div>

          <!-- Google Gemini API é…ç½® -->
          <div class="api-section">
            <h2 class="section-title">ğŸ’ Google Gemini API</h2>

            <div class="form-group">
              <label class="form-label">å¯ç”¨ Gemini API</label>
              <label class="toggle-switch">
                <input type="checkbox" id="gemini-enabled" />
                <span class="slider"></span>
              </label>
            </div>

            <div class="form-group">
              <label class="form-label" for="gemini-url">API åœ°å€</label>
              <input type="url" id="gemini-url" class="form-input" placeholder="https://ä½ çš„newapiæœåŠ¡å™¨åœ°å€" />
            </div>

            <div class="form-group">
              <label class="form-label" for="gemini-key">API å¯†é’¥</label>
              <input type="password" id="gemini-key" class="form-input" placeholder="AIzaSyxxxxxxxxxxxxxxxxxxxxxxxx" />
            </div>

            <div class="form-group">
              <label class="form-label" for="gemini-model">é»˜è®¤æ¨¡å‹</label>
              <select id="gemini-model" class="form-select">
                <option value="">è¯·å…ˆæµ‹è¯•è¿æ¥ä»¥è·å–å¯ç”¨æ¨¡å‹</option>
              </select>
            </div>

            <button class="test-btn" onclick="testGemini()">æµ‹è¯•è¿æ¥</button>
          </div>

          <button class="save-btn" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
        </div>
      </div>
    </div>

    <script>
      // åŠ è½½ä¿å­˜çš„è®¾ç½®
      function loadSettings() {
        const settings = JSON.parse(localStorage.getItem('apiSettings') || '{}');

        // OpenAI è®¾ç½®
        if (settings.openai) {
          document.getElementById('openai-enabled').checked = settings.openai.enabled !== false;
          document.getElementById('openai-url').value = settings.openai.url || '';
          document.getElementById('openai-key').value = settings.openai.key || '';

          // åˆå§‹åŒ–æ¨¡å‹é€‰æ‹©æ¡†ï¼Œæ˜¾ç¤ºæç¤º
          const modelSelect = document.getElementById('openai-model');
          if (settings.openai.model) {
            modelSelect.innerHTML = `<option value="${settings.openai.model}">${settings.openai.model} (å·²ä¿å­˜)</option>`;
            modelSelect.value = settings.openai.model;
          } else {
            modelSelect.innerHTML = '<option value="">è¯·å…ˆæµ‹è¯•è¿æ¥ä»¥è·å–æ¨¡å‹åˆ—è¡¨</option>';
          }
        } else {
          // å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œæ˜¾ç¤ºæç¤º
          const modelSelect = document.getElementById('openai-model');
          modelSelect.innerHTML = '<option value="">è¯·å…ˆæµ‹è¯•è¿æ¥ä»¥è·å–æ¨¡å‹åˆ—è¡¨</option>';
        }

        // Gemini è®¾ç½®
        if (settings.gemini) {
          document.getElementById('gemini-enabled').checked = settings.gemini.enabled || false;
          document.getElementById('gemini-url').value = settings.gemini.url || '';
          document.getElementById('gemini-key').value = settings.gemini.key || '';
          if (settings.gemini.model) {
            // å¦‚æœæœ‰ä¿å­˜çš„æ¨¡å‹ï¼Œå…ˆæ·»åŠ åˆ°é€‰æ‹©æ¡†ä¸­
            const modelSelect = document.getElementById('gemini-model');
            modelSelect.innerHTML = `<option value="${settings.gemini.model}">${settings.gemini.model}</option>`;
            modelSelect.value = settings.gemini.model;
          }
        }
      }

      // ä¿å­˜è®¾ç½®
      function saveSettings() {
        const openaiEnabled = document.getElementById('openai-enabled').checked;
        const geminiEnabled = document.getElementById('gemini-enabled').checked;

        const settings = {
          openai: {
            enabled: openaiEnabled,
            url: document.getElementById('openai-url').value,
            key: document.getElementById('openai-key').value,
            model: document.getElementById('openai-model').value,
          },
          gemini: {
            enabled: geminiEnabled,
            url: document.getElementById('gemini-url').value,
            key: document.getElementById('gemini-key').value,
            model: document.getElementById('gemini-model').value,
          },
        };

        // è‡ªåŠ¨è®¾ç½®é€‰ä¸­çš„æœåŠ¡
        if (openaiEnabled && settings.openai.key) {
          settings.selectedService = 'openai';
        } else if (geminiEnabled && settings.gemini.key) {
          settings.selectedService = 'gemini';
        }

        localStorage.setItem('apiSettings', JSON.stringify(settings));

        // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
        const btn = document.querySelector('.save-btn');
        const originalText = btn.textContent;
        btn.textContent = 'å·²ä¿å­˜ âœ“';
        btn.style.background = 'linear-gradient(135deg, #00d4aa 0%, #00b894 100%)';

        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = 'linear-gradient(135deg, #6c5ce7 0%, #5a4fcf 100%)';
        }, 2000);
      }

      // æµ‹è¯• OpenAI è¿æ¥
      async function testOpenAI() {
        const url = document.getElementById('openai-url').value;
        const key = document.getElementById('openai-key').value;

        if (!url || !key) {
          alert('è¯·å¡«å†™å®Œæ•´çš„ API åœ°å€å’Œå¯†é’¥');
          return;
        }

        const btn = event.target;
        btn.textContent = 'æµ‹è¯•ä¸­...';
        btn.disabled = true;

        try {
          const baseUrl = url.replace(/\/$/, '');
          console.log('æµ‹è¯•APIåœ°å€:', baseUrl);
          console.log('APIå¯†é’¥é•¿åº¦:', key.length);

          // é¦–å…ˆå°è¯•è·å–æ¨¡å‹åˆ—è¡¨
          const modelSelect = document.getElementById('openai-model');
          modelSelect.innerHTML = '<option value="">æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...</option>';

          let availableModels = [];
          let testModel = 'gpt-3.5-turbo'; // é»˜è®¤æµ‹è¯•æ¨¡å‹

          try {
            console.log('å°è¯•è·å–æ¨¡å‹åˆ—è¡¨...');
            const modelsResponse = await fetch(`${baseUrl}/v1/models`, {
              method: 'GET',
              headers: {
                Authorization: `Bearer ${key}`,
                'Content-Type': 'application/json',
              },
            });

            console.log('æ¨¡å‹åˆ—è¡¨å“åº”çŠ¶æ€:', modelsResponse.status);
            if (modelsResponse.ok) {
              const modelsData = await modelsResponse.json();
              console.log('è·å–åˆ°çš„æ¨¡å‹æ•°æ®:', modelsData);
              if (modelsData.data && Array.isArray(modelsData.data) && modelsData.data.length > 0) {
                availableModels = modelsData.data.map(model => model.id);
                testModel = availableModels[0]; // ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨æ¨¡å‹è¿›è¡Œæµ‹è¯•
                console.log('å¯ç”¨æ¨¡å‹:', availableModels);
                console.log('é€‰æ‹©æµ‹è¯•æ¨¡å‹:', testModel);
              }
            } else {
              const errorText = await modelsResponse.text();
              console.log('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', modelsResponse.status, errorText);
            }
          } catch (e) {
            console.error('è·å–æ¨¡å‹åˆ—è¡¨å¼‚å¸¸:', e);
            console.log('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ¨¡å‹æµ‹è¯•è¿æ¥');
          }

          // ä½¿ç”¨è·å–åˆ°çš„ç¬¬ä¸€ä¸ªæ¨¡å‹æˆ–é»˜è®¤æ¨¡å‹æµ‹è¯•è¿æ¥
          console.log('å¼€å§‹æµ‹è¯•è¿æ¥ï¼Œä½¿ç”¨æ¨¡å‹:', testModel);
          const testResponse = await fetch(`${baseUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${key}`,
            },
            body: JSON.stringify({
              model: testModel,
              messages: [
                { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„åŠ©æ‰‹ã€‚' },
                { role: 'user', content: 'ä½ å¥½ï¼è¯·ç®€å•å›å¤ã€‚' },
              ],
              max_tokens: 50,
              temperature: 0.7,
            }),
          });

          console.log('æµ‹è¯•è¿æ¥å“åº”çŠ¶æ€:', testResponse.status);
          if (!testResponse.ok) {
            const errorData = await testResponse.json().catch(async () => {
              const errorText = await testResponse.text();
              return { error: { message: errorText } };
            });
            console.error('è¿æ¥æµ‹è¯•å¤±è´¥:', errorData);
            throw new Error(`è¿æ¥å¤±è´¥ ${testResponse.status}: ${errorData.error?.message || testResponse.statusText}`);
          }

          const testData = await testResponse.json();
          console.log('æµ‹è¯•è¿æ¥æˆåŠŸï¼Œå“åº”æ•°æ®:', testData);

          // è¿æ¥æˆåŠŸï¼Œæ›´æ–°æŒ‰é’®çŠ¶æ€
          btn.textContent = 'è¿æ¥æˆåŠŸ âœ“';
          btn.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';

          // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
          let statusDiv = document.getElementById('test-status');
          if (statusDiv) {
            statusDiv.textContent = `âœ“ è¿æ¥æµ‹è¯•æˆåŠŸï¼\nä½¿ç”¨æ¨¡å‹: ${testModel}\nå¯ç”¨æ¨¡å‹: ${
              availableModels.length > 0 ? availableModels.length + ' ä¸ª' : 'ä½¿ç”¨é»˜è®¤åˆ—è¡¨'
            }`;
            statusDiv.style.background = 'rgba(76, 175, 80, 0.2)';
          }

          // è¿æ¥æˆåŠŸï¼Œå¡«å……æ¨¡å‹åˆ—è¡¨
          modelSelect.innerHTML = '';

          if (availableModels.length > 0) {
            availableModels.forEach(modelId => {
              const option = document.createElement('option');
              option.value = modelId;
              option.textContent = modelId;
              modelSelect.appendChild(option);
            });
            // é»˜è®¤é€‰æ‹©æµ‹è¯•æˆåŠŸçš„æ¨¡å‹
            modelSelect.value = testModel;
          } else {
            // å¦‚æœæ— æ³•è·å–æ¨¡å‹åˆ—è¡¨ï¼Œä½¿ç”¨å¸¸è§æ¨¡å‹å¹¶æ ‡æ³¨æµ‹è¯•æˆåŠŸçš„æ¨¡å‹
            addCommonOpenAIModels(modelSelect);
            // å¦‚æœæµ‹è¯•æ¨¡å‹åœ¨å¸¸è§æ¨¡å‹ä¸­ï¼Œé€‰ä¸­å®ƒ
            if ([...modelSelect.options].some(opt => opt.value === testModel)) {
              modelSelect.value = testModel;
            }
          }

          // ä¿å­˜è¿æ¥æˆåŠŸçš„çŠ¶æ€
          const saved = JSON.parse(localStorage.getItem('apiSettings') || '{}');
          if (!saved.openai) saved.openai = {};
          saved.openai.endpoint = 'chat'; // æ ‡è®°ä¸º chat completions å…¼å®¹
          saved.openai.enabled = true; // è‡ªåŠ¨å¯ç”¨
          saved.openai.url = url;
          saved.openai.key = key;
          saved.openai.model = testModel;
          saved.selectedService = 'openai'; // è®¾ç½®ä¸ºé€‰ä¸­çš„æœåŠ¡
          localStorage.setItem('apiSettings', JSON.stringify(saved));

          // åŒæ­¥æ›´æ–°ç•Œé¢çŠ¶æ€
          document.getElementById('openai-enabled').checked = true;

          btn.textContent = 'è¿æ¥æˆåŠŸ âœ“';
          btn.style.background = 'linear-gradient(135deg, #00d4aa 0%, #00b894 100%)';
        } catch (error) {
          console.error('APIæµ‹è¯•å¤±è´¥ï¼Œè¯¦ç»†é”™è¯¯:', error);
          btn.textContent = 'è¿æ¥å¤±è´¥ âœ—';
          btn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)';

          // æ˜¾ç¤ºå¤±è´¥çŠ¶æ€
          let statusDiv = document.getElementById('test-status');
          if (statusDiv) {
            statusDiv.textContent = `âœ— è¿æ¥æµ‹è¯•å¤±è´¥\né”™è¯¯: ${error.message}`;
            statusDiv.style.background = 'rgba(255, 107, 107, 0.2)';
          }

          // è¿æ¥å¤±è´¥æ—¶æ¸…ç©ºæ¨¡å‹åˆ—è¡¨
          const modelSelect = document.getElementById('openai-model');
          modelSelect.innerHTML = '<option value="">è¿æ¥å¤±è´¥ï¼Œæ— å¯ç”¨æ¨¡å‹</option>';

          // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
          let errorMessage = 'è¿æ¥å¤±è´¥';
          if (error.message.includes('Failed to fetch')) {
            errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š\n1. APIåœ°å€æ˜¯å¦æ­£ç¡®\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. æ˜¯å¦å­˜åœ¨é˜²ç«å¢™é˜»æ­¢';
          } else if (error.message.includes('401')) {
            errorMessage = 'APIå¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥å¯†é’¥æ˜¯å¦æ­£ç¡®';
          } else if (error.message.includes('403')) {
            errorMessage = 'APIè®¿é—®è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥å¯†é’¥æƒé™';
          } else if (error.message.includes('404')) {
            errorMessage = 'APIåœ°å€ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥åœ°å€æ˜¯å¦æ­£ç¡®';
          } else if (error.message.includes('429')) {
            errorMessage = 'APIè°ƒç”¨é¢‘ç‡è¶…é™ï¼Œè¯·ç¨åé‡è¯•';
          } else if (error.message.includes('500')) {
            errorMessage = 'APIæœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
          } else {
            errorMessage = `è¿æ¥å¤±è´¥: ${error.message}`;
          }

          setTimeout(() => alert(errorMessage), 100);
        } finally {
          // æ¢å¤æŒ‰é’®çŠ¶æ€
          btn.disabled = false;
        }

        setTimeout(() => {
          btn.textContent = 'æµ‹è¯•è¿æ¥';
          btn.style.background = 'linear-gradient(135deg, #00d4aa 0%, #00b894 100%)';
          btn.disabled = false;
        }, 3000);
      }

      // æ·»åŠ å¸¸è§çš„OpenAIæ¨¡å‹
      function addCommonOpenAIModels(modelSelect) {
        const commonModels = [
          'gpt-4.1',
          'gpt-4.1-mini',
          'gpt-4o',
          'gpt-4o-mini',
          'gpt-4-turbo',
          'gpt-4',
          'gpt-3.5-turbo',
        ];
        commonModels.forEach(modelName => {
          const option = document.createElement('option');
          option.value = modelName;
          option.textContent = modelName;
          modelSelect.appendChild(option);
        });
      }

      // æµ‹è¯• Gemini è¿æ¥
      async function testGemini() {
        const url = document.getElementById('gemini-url').value;
        const key = document.getElementById('gemini-key').value;

        if (!url || !key) {
          alert('è¯·å¡«å†™å®Œæ•´çš„ API åœ°å€å’Œå¯†é’¥');
          return;
        }

        const btn = event.target;
        btn.textContent = 'æµ‹è¯•ä¸­...';
        btn.disabled = true;

        try {
          // å»æ‰æœ«å°¾çš„æ–œæ 
          const baseUrl = url.replace(/\/$/, '');

          let response;
          let isNewApiFormat = false;

          // å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯newapiç­‰ä»£ç†æœåŠ¡ï¼ˆä½¿ç”¨OpenAIå…¼å®¹æ ¼å¼ï¼‰
          try {
            response = await fetch(`${baseUrl}/v1/models`, {
              method: 'GET',
              headers: {
                Authorization: `Bearer ${key}`,
                'Content-Type': 'application/json',
              },
            });

            if (response.ok) {
              isNewApiFormat = true;
            }
          } catch (error) {
            // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­å°è¯•åŸç”ŸGemini API
          }

          // å¦‚æœä¸æ˜¯newapiæ ¼å¼ï¼Œå°è¯•åŸç”ŸGemini API
          if (!isNewApiFormat) {
            try {
              response = await fetch(`${baseUrl}/v1beta/models?key=${key}`, {
                method: 'GET',
                headers: {
                  'Content-Type': 'application/json',
                },
              });
            } catch (error) {
              // å¦‚æœåŸç”ŸAPIä¹Ÿå¤±è´¥ï¼Œå°è¯•ç®€å•çš„ç”Ÿæˆè¯·æ±‚
              response = await fetch(`${baseUrl}/v1beta/models/gemini-pro:generateContent?key=${key}`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  contents: [{ parts: [{ text: 'test' }] }],
                }),
              });
            }
          }

          if (response.ok) {
            const data = await response.json();

            // æ›´æ–°æ¨¡å‹é€‰æ‹©æ¡†
            const modelSelect = document.getElementById('gemini-model');
            modelSelect.innerHTML = '';

            if (isNewApiFormat && data.data && Array.isArray(data.data)) {
              // newapiæ ¼å¼çš„å“åº”
              const models = data.data;
              if (models.length > 0) {
                models.forEach(model => {
                  const option = document.createElement('option');
                  option.value = model.id;
                  option.textContent = model.id;
                  modelSelect.appendChild(option);
                });
                modelSelect.selectedIndex = 0;
              } else {
                addCommonGeminiModels(modelSelect);
              }
            } else if (data.models && Array.isArray(data.models)) {
              // åŸç”ŸGemini APIæ ¼å¼çš„å“åº”
              const models = data.models;
              if (models.length > 0) {
                models.forEach(model => {
                  const modelName = model.name.replace('models/', '');
                  const option = document.createElement('option');
                  option.value = modelName;
                  option.textContent = modelName;
                  modelSelect.appendChild(option);
                });
                modelSelect.selectedIndex = 0;
              } else {
                addCommonGeminiModels(modelSelect);
              }
            } else {
              // å¦‚æœæ˜¯ç”Ÿæˆå†…å®¹çš„å“åº”ï¼Œè¯´æ˜è¿æ¥æˆåŠŸ
              addCommonGeminiModels(modelSelect);
            }

            btn.textContent = 'è¿æ¥æˆåŠŸ âœ“';
            btn.style.background = 'linear-gradient(135deg, #00d4aa 0%, #00b894 100%)';

            // ä¿å­˜è¿æ¥æˆåŠŸçš„çŠ¶æ€
            const saved = JSON.parse(localStorage.getItem('apiSettings') || '{}');
            if (!saved.gemini) saved.gemini = {};
            saved.gemini.enabled = true; // è‡ªåŠ¨å¯ç”¨
            saved.gemini.url = url;
            saved.gemini.key = key;
            saved.gemini.model = modelSelect.value || 'gemini-1.5-pro';
            saved.selectedService = 'gemini'; // è®¾ç½®ä¸ºé€‰ä¸­çš„æœåŠ¡
            localStorage.setItem('apiSettings', JSON.stringify(saved));

            // åŒæ­¥æ›´æ–°ç•Œé¢çŠ¶æ€
            document.getElementById('gemini-enabled').checked = true;
          } else {
            const errorText = await response.text();
            console.error('Gemini API Error:', response.status, errorText);
            btn.textContent = 'è¿æ¥å¤±è´¥ âœ—';
            btn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)';

            // è¿æ¥å¤±è´¥æ—¶æ¸…ç©ºæ¨¡å‹åˆ—è¡¨
            const modelSelect = document.getElementById('gemini-model');
            modelSelect.innerHTML = '<option value="">è¿æ¥å¤±è´¥ï¼Œæ— å¯ç”¨æ¨¡å‹</option>';

            // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
            setTimeout(() => {
              alert(`è¿æ¥å¤±è´¥: ${response.status} - ${response.statusText}`);
            }, 100);
          }
        } catch (error) {
          console.error('Network Error:', error);
          btn.textContent = 'è¿æ¥å¤±è´¥ âœ—';
          btn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)';

          // è¿æ¥å¤±è´¥æ—¶æ¸…ç©ºæ¨¡å‹åˆ—è¡¨
          const modelSelect = document.getElementById('gemini-model');
          modelSelect.innerHTML = '<option value="">è¿æ¥å¤±è´¥ï¼Œæ— å¯ç”¨æ¨¡å‹</option>';

          // æ˜¾ç¤ºç½‘ç»œé”™è¯¯ä¿¡æ¯
          setTimeout(() => {
            alert(`ç½‘ç»œé”™è¯¯: ${error.message}`);
          }, 100);
        }

        setTimeout(() => {
          btn.textContent = 'æµ‹è¯•è¿æ¥';
          btn.style.background = 'linear-gradient(135deg, #00d4aa 0%, #00b894 100%)';
          btn.disabled = false;
        }, 3000);
      }

      // æ·»åŠ å¸¸è§çš„Geminiæ¨¡å‹
      function addCommonGeminiModels(modelSelect) {
        const commonModels = ['gemini-2.0-flash-exp', 'gemini-1.5-pro', 'gemini-1.5-flash', 'gemini-pro'];
        commonModels.forEach(modelName => {
          const option = document.createElement('option');
          option.value = modelName;
          option.textContent = modelName;
          modelSelect.appendChild(option);
        });
      }

      // æ›´æ–°çŠ¶æ€æ æ—¶é—´
      function updateTime() {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const timeString = `${hours}:${minutes}`;

        const timeElement = document.getElementById('currentTime');
        if (timeElement) {
          timeElement.textContent = timeString;
        }
      }

      // é¡µé¢åŠ è½½æ—¶åŠ è½½è®¾ç½®
      document.addEventListener('DOMContentLoaded', function () {
        // ç«‹å³æ›´æ–°æ—¶é—´
        updateTime();

        // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ—¶é—´
        setInterval(updateTime, 60000);

        // åŠ è½½APIè®¾ç½®
        loadSettings();
      });
    </script>
  </body>
</html>
