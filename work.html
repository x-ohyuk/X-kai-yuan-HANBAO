<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ä¸–ç•Œä¹¦</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Segoe UI', Roboto, Arial,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #a1c4fd 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: backgroundShift 10s ease-in-out infinite;
      }

      @keyframes backgroundShift {
        0%,
        100% {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #a1c4fd 100%);
        }
        33% {
          background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 50%, #667eea 100%);
        }
        66% {
          background: linear-gradient(135deg, #764ba2 0%, #667eea 50%, #c2e9fb 100%);
        }
      }

      .iphone-frame {
        width: 390px;
        height: 844px;
        border-radius: 54px;
        background: linear-gradient(180deg, #0f1724 0%, #0b1220 60%);
        border: none;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.02), inset 0 -6px 20px rgba(0, 0, 0, 0.6),
          0 8px 30px rgba(2, 6, 23, 0.55);
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .screen {
        width: 370px;
        height: 804px;
        border-radius: 44px;
        background: #f7f7f7;
        position: relative;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* çµåŠ¨å²› */
      .dynamic-island {
        position: absolute;
        top: 18px;
        left: 50%;
        transform: translateX(-50%);
        width: 120px;
        height: 36px;
        background: #0b0b0b;
        border-radius: 18px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
        z-index: 10;
      }

      /* çŠ¶æ€æ  */
      .status-bar {
        position: absolute;
        top: 6px;
        left: 0;
        width: 100%;
        height: 48px;
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        padding: 6px 18px;
        color: #000;
        font-size: 15px;
        font-weight: 600;
        pointer-events: none;
        z-index: 5;
      }

      .status-left {
        font-weight: 600;
      }
      .status-right {
        display: flex;
        gap: 8px;
        align-items: center;
        color: #00d4aa;
      }

      /* å¯¼èˆªæ  */
      .navbar {
        margin-top: 54px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 20px;
        height: 60px;
      }

      .nav-title {
        font-size: 20px;
        font-weight: 700;
        color: #1a1a1a;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .nav-btn {
        background: none;
        border: none;
        font-size: 18px;
        color: #007aff;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s ease;
      }

      .nav-btn:hover {
        background: rgba(0, 122, 255, 0.1);
      }

      /* ä¸»å†…å®¹åŒºåŸŸ */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* æœç´¢æ  */
      .search-bar {
        padding: 16px 20px;
        background: #fff;
        border-bottom: 1px solid #e5e5e7;
      }

      .search-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e5e7;
        border-radius: 12px;
        font-size: 16px;
        background: #f8f9fa;
        transition: all 0.2s ease;
      }

      .search-input:focus {
        outline: none;
        border-color: #007aff;
        background: #fff;
      }

      /* åˆ†ç±»æ ‡ç­¾ */
      .category-tabs {
        display: flex;
        overflow-x: auto;
        padding: 8px 20px;
        background: #fff;
        border-bottom: 1px solid #e5e5e7;
        gap: 8px;
      }

      .category-tab {
        flex-shrink: 0;
        padding: 8px 16px;
        border-radius: 20px;
        border: 2px solid #e5e5e7;
        background: #f8f9fa;
        color: #666;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .category-tab.active {
        background: #007aff;
        border-color: #007aff;
        color: #fff;
      }

      /* æ¡ç›®åˆ—è¡¨ */
      .entries-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
      }

      .entry-card {
        background: #fff;
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e5e7;
        transition: all 0.2s ease;
      }

      .entry-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      }

      .entry-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .entry-title {
        font-size: 18px;
        font-weight: 600;
        color: #1a1a1a;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .entry-category {
        background: #007aff;
        color: #fff;
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
      }

      .entry-actions {
        display: flex;
        gap: 8px;
      }

      .action-btn {
        background: none;
        border: none;
        padding: 6px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.2s ease;
      }

      .action-btn:hover {
        background: rgba(0, 0, 0, 0.1);
      }
      .action-btn.edit {
        color: #007aff;
      }
      .action-btn.delete {
        color: #ff3b30;
      }

      .entry-keywords {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 12px;
      }

      .keyword-tag {
        background: #f0f0f0;
        color: #666;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .character-binding {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        margin-bottom: 8px;
        display: inline-block;
      }

      .entry-content {
        color: #666;
        font-size: 14px;
        line-height: 1.4;
        max-height: 60px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .entry-priority {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }

      .priority-high {
        background: #ff3b30;
      }
      .priority-medium {
        background: #ff9500;
      }
      .priority-low {
        background: #34c759;
      }

      /* æ·»åŠ æŒ‰é’® */
      .add-btn {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 56px;
        height: 56px;
        background: #007aff;
        border: none;
        border-radius: 28px;
        color: #fff;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 16px rgba(0, 122, 255, 0.4);
        transition: all 0.2s ease;
        z-index: 100;
      }

      .add-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0, 122, 255, 0.6);
      }

      /* æ¨¡æ€æ¡† */
      .modal {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        border-radius: 44px;
        overflow: hidden;
      }

      .modal-content {
        background: #fff;
        border-radius: 16px;
        padding: 20px;
        width: 85%;
        max-width: 320px;
        max-height: 70%;
        overflow-y: auto;
        margin: 0 auto;
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: #1a1a1a;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        color: #666;
        cursor: pointer;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #333;
      }

      .form-input,
      .form-textarea,
      .form-select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e5e7;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.2s ease;
      }

      .form-input:focus,
      .form-textarea:focus,
      .form-select:focus {
        outline: none;
        border-color: #007aff;
      }

      .form-textarea {
        min-height: 100px;
        resize: vertical;
      }

      .keywords-input {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        padding: 8px;
        border: 2px solid #e5e5e7;
        border-radius: 8px;
        min-height: 44px;
        align-items: center;
      }

      .keywords-input:focus-within {
        border-color: #007aff;
      }

      .keyword-input {
        border: none;
        outline: none;
        padding: 4px;
        font-size: 14px;
        flex: 1;
        min-width: 80px;
      }

      .btn-group {
        display: flex;
        gap: 12px;
        margin-top: 20px;
      }

      .btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn-primary {
        background: #007aff;
        color: #fff;
      }

      .btn-primary:hover {
        background: #0056d3;
      }

      .btn-secondary {
        background: #f0f0f0;
        color: #333;
      }

      .btn-secondary:hover {
        background: #e0e0e0;
      }

      /* ç©ºçŠ¶æ€ */
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #666;
      }

      .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .empty-text {
        font-size: 16px;
        margin-bottom: 8px;
      }

      .empty-subtext {
        font-size: 14px;
        opacity: 0.7;
      }

      /* æ»šåŠ¨æ¡æ ·å¼ */
      ::-webkit-scrollbar {
        width: 6px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }
    </style>
  </head>
  <body>
    <div class="iphone-frame">
      <div class="screen">
        <!-- çµåŠ¨å²› -->
        <div class="dynamic-island"></div>

        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
          <div class="status-left" id="currentTime">9:41</div>
          <div class="status-right">
            <span>100%</span>
            <span>ğŸ”‹</span>
          </div>
        </div>

        <!-- å¯¼èˆªæ  -->
        <div class="navbar">
          <button class="nav-btn" onclick="goBack()">â€¹</button>
          <div class="nav-title">ğŸ“š ä¸–ç•Œä¹¦</div>
          <button class="nav-btn" onclick="showImportExport()">â‹¯</button>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
          <!-- æœç´¢æ  -->
          <div class="search-bar">
            <input
              type="text"
              class="search-input"
              id="searchInput"
              placeholder="æœç´¢æ¡ç›®ã€å…³é”®è¯..."
              oninput="filterEntries()"
            />
          </div>

          <!-- åˆ†ç±»æ ‡ç­¾ -->
          <div class="category-tabs">
            <div class="category-tab active" data-category="all" onclick="filterByCategory('all')">å…¨éƒ¨</div>
            <div class="category-tab" data-category="character" onclick="filterByCategory('character')">è§’è‰²</div>
            <div class="category-tab" data-category="location" onclick="filterByCategory('location')">åœ°ç‚¹</div>
            <div class="category-tab" data-category="item" onclick="filterByCategory('item')">ç‰©å“</div>
            <div class="category-tab" data-category="lore" onclick="filterByCategory('lore')">è®¾å®š</div>
            <div class="category-tab" data-category="event" onclick="filterByCategory('event')">äº‹ä»¶</div>
          </div>

          <!-- æ¡ç›®åˆ—è¡¨ -->
          <div class="entries-container" id="entriesContainer">
            <!-- ç©ºçŠ¶æ€ -->
            <div class="empty-state" id="emptyState">
              <div class="empty-icon">ğŸ“–</div>
              <div class="empty-text">è¿˜æ²¡æœ‰ä¸–ç•Œä¹¦æ¡ç›®</div>
              <div class="empty-subtext">ç‚¹å‡»å³ä¸‹è§’çš„ + æŒ‰é’®æ·»åŠ ç¬¬ä¸€ä¸ªæ¡ç›®</div>
            </div>
          </div>
        </div>

        <!-- æ·»åŠ æŒ‰é’® -->
        <button class="add-btn" onclick="showAddModal()">+</button>

        <!-- æ·»åŠ /ç¼–è¾‘æ¨¡æ€æ¡† -->
        <div class="modal" id="entryModal">
          <div class="modal-content">
            <div class="modal-header">
              <div class="modal-title" id="modalTitle">æ·»åŠ ä¸–ç•Œä¹¦æ¡ç›®</div>
              <button class="close-btn" onclick="hideModal()">&times;</button>
            </div>

            <form id="entryForm" onsubmit="return handleFormSubmit(event)">
              <div class="form-group">
                <label class="form-label">æ ‡é¢˜ *</label>
                <input type="text" class="form-input" id="entryTitle" placeholder="è¾“å…¥æ¡ç›®æ ‡é¢˜" required />
              </div>

              <div class="form-group">
                <label class="form-label">åˆ†ç±»</label>
                <select class="form-select" id="entryCategory">
                  <option value="character">è§’è‰²</option>
                  <option value="location">åœ°ç‚¹</option>
                  <option value="item">ç‰©å“</option>
                  <option value="lore">è®¾å®š</option>
                  <option value="event">äº‹ä»¶</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">å…³é”®è¯ (ç”¨é€—å·åˆ†éš”)</label>
                <input type="text" class="form-input" id="entryKeywords" placeholder="å…³é”®è¯1, å…³é”®è¯2, ..." />
              </div>

              <div class="form-group">
                <label class="form-label">ä¼˜å…ˆçº§</label>
                <select class="form-select" id="entryPriority">
                  <option value="low">ä½ - ä¸å¤ªé‡è¦</option>
                  <option value="medium" selected>ä¸­ - ä¸€èˆ¬é‡è¦</option>
                  <option value="high">é«˜ - éå¸¸é‡è¦</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">è§’è‰²ç»‘å®š (å¯é€‰)</label>
                <select class="form-select" id="entryCharacterBinding">
                  <option value="">æ— ç»‘å®š - å…¨å±€å¯ç”¨</option>
                  <option value="user">ç”¨æˆ·è§’è‰²ä¸“ç”¨</option>
                  <option value="ai">AIè§’è‰²ä¸“ç”¨</option>
                </select>
                <small style="color: #666; font-size: 12px; margin-top: 4px; display: block">
                  é€‰æ‹©åï¼Œæ­¤æ¡ç›®ä»…åœ¨å¯¹åº”è§’è‰²ç›¸å…³çš„å¯¹è¯ä¸­ç”Ÿæ•ˆ
                </small>
              </div>

              <div class="form-group">
                <label class="form-label">å†…å®¹ *</label>
                <textarea class="form-textarea" id="entryContent" placeholder="è¾“å…¥è¯¦ç»†æè¿°..." required></textarea>
              </div>

              <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="hideModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary" onclick="return handleFormSubmit(event)">ä¿å­˜</button>
              </div>
            </form>
          </div>
        </div>

        <!-- å¯¼å…¥å¯¼å‡ºæ¨¡æ€æ¡† -->
        <div class="modal" id="importExportModal">
          <div class="modal-content">
            <div class="modal-header">
              <div class="modal-title">å¯¼å…¥/å¯¼å‡º</div>
              <button class="close-btn" onclick="hideImportExportModal()">&times;</button>
            </div>

            <div class="form-group">
              <label class="form-label">å¯¼å‡ºä¸–ç•Œä¹¦</label>
              <button type="button" class="btn btn-primary" onclick="exportWorldBook()">å¯¼å‡ºä¸ºJSONæ–‡ä»¶</button>
            </div>

            <div class="form-group">
              <label class="form-label">å¯¼å…¥ä¸–ç•Œä¹¦</label>
              <input type="file" id="importFile" accept=".json" style="display: none" onchange="importWorldBook()" />
              <button type="button" class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                é€‰æ‹©JSONæ–‡ä»¶
              </button>
            </div>

            <div class="form-group">
              <label class="form-label">æ¸…ç©ºæ‰€æœ‰æ•°æ®</label>
              <button type="button" class="btn btn-secondary" onclick="clearAllData()">æ¸…ç©ºä¸–ç•Œä¹¦</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // å…¨å±€å˜é‡
      let worldBookEntries = [];
      let currentEditingId = null;
      let currentFilter = 'all';

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', function () {
        console.log('é¡µé¢åŠ è½½å®Œæˆ');
        loadWorldBookData();
        renderEntries();

        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†åŠ¨æ€ç”Ÿæˆçš„æŒ‰é’®
        const entriesContainer = document.getElementById('entriesContainer');
        if (entriesContainer) {
          entriesContainer.addEventListener('click', function (e) {
            const button = e.target.closest('.action-btn');
            if (button) {
              const action = button.getAttribute('data-action');
              const id = button.getAttribute('data-id');
              console.log('æŒ‰é’®ç‚¹å‡»:', action, id);

              if (action === 'edit') {
                editEntry(id);
              } else if (action === 'delete') {
                deleteEntry(id);
              }
            }
          });
        }
      });

      // åŠ è½½ä¸–ç•Œä¹¦æ•°æ®
      function loadWorldBookData() {
        const saved = localStorage.getItem('worldBookEntries');
        if (saved) {
          worldBookEntries = JSON.parse(saved);
        }
      }

      // ä¿å­˜ä¸–ç•Œä¹¦æ•°æ®
      function saveWorldBookData() {
        console.log('ä¿å­˜ä¸–ç•Œä¹¦æ•°æ®ï¼Œæ¡ç›®æ•°é‡:', worldBookEntries.length);
        try {
          localStorage.setItem('worldBookEntries', JSON.stringify(worldBookEntries));
          console.log('ä¿å­˜æˆåŠŸ');
          return true;
        } catch (error) {
          console.error('ä¿å­˜å¤±è´¥:', error);
          alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
          return false;
        }
      }

      // æ¸²æŸ“æ¡ç›®åˆ—è¡¨
      function renderEntries() {
        const container = document.getElementById('entriesContainer');
        const emptyState = document.getElementById('emptyState');

        if (!container) {
          console.error('æœªæ‰¾åˆ° entriesContainer å…ƒç´ ');
          return;
        }

        if (!emptyState) {
          console.error('æœªæ‰¾åˆ° emptyState å…ƒç´ ');
          return;
        }

        // è¿‡æ»¤æ¡ç›®
        let filteredEntries = worldBookEntries;

        // æŒ‰åˆ†ç±»è¿‡æ»¤
        if (currentFilter !== 'all') {
          filteredEntries = filteredEntries.filter(entry => entry.category === currentFilter);
        }

        // æŒ‰æœç´¢è¯è¿‡æ»¤
        const searchInput = document.getElementById('searchInput');
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        if (searchTerm) {
          filteredEntries = filteredEntries.filter(
            entry =>
              entry.title.toLowerCase().includes(searchTerm) ||
              entry.content.toLowerCase().includes(searchTerm) ||
              entry.keywords.some(keyword => keyword.toLowerCase().includes(searchTerm)),
          );
        }

        if (filteredEntries.length === 0) {
          emptyState.style.display = 'block';
          container.innerHTML = '';
          container.appendChild(emptyState);
          return;
        }

        emptyState.style.display = 'none';

        // æŒ‰ä¼˜å…ˆçº§æ’åº
        const priorityOrder = { high: 3, medium: 2, low: 1 };
        filteredEntries.sort((a, b) => priorityOrder[b.priority] - priorityOrder[a.priority]);

        container.innerHTML = filteredEntries
          .map(
            entry => `
                <div class="entry-card">
                    <div class="entry-priority priority-${entry.priority}"></div>
                    <div class="entry-header">
                        <div class="entry-title">
                            ${getCategoryIcon(entry.category)} ${entry.title}
                        </div>
                        <div class="entry-actions">
                            <button class="action-btn edit" data-action="edit" data-id="${
                              entry.id
                            }" title="ç¼–è¾‘">âœï¸</button>
                            <button class="action-btn delete" data-action="delete" data-id="${
                              entry.id
                            }" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <div class="entry-category">${getCategoryName(entry.category)}</div>
                    ${
                      entry.characterBinding
                        ? `
                        <div class="character-binding">
                            ${getCharacterBindingIcon(entry.characterBinding)} ${getCharacterBindingName(
                            entry.characterBinding,
                          )}
                        </div>
                    `
                        : ''
                    }
                    ${
                      entry.keywords.length > 0
                        ? `
                        <div class="entry-keywords">
                            ${entry.keywords.map(keyword => `<span class="keyword-tag">${keyword}</span>`).join('')}
                        </div>
                    `
                        : ''
                    }
                    <div class="entry-content">${entry.content}</div>
                </div>
            `,
          )
          .join('');
      }

      // è·å–åˆ†ç±»å›¾æ ‡
      function getCategoryIcon(category) {
        const icons = {
          character: 'ğŸ‘¤',
          location: 'ğŸï¸',
          item: 'ğŸ“¦',
          lore: 'ğŸ“œ',
          event: 'âš¡',
        };
        return icons[category] || 'ğŸ“';
      }

      // è·å–åˆ†ç±»åç§°
      function getCategoryName(category) {
        const names = {
          character: 'è§’è‰²',
          location: 'åœ°ç‚¹',
          item: 'ç‰©å“',
          lore: 'è®¾å®š',
          event: 'äº‹ä»¶',
        };
        return names[category] || 'å…¶ä»–';
      }

      // è·å–è§’è‰²ç»‘å®šå›¾æ ‡
      function getCharacterBindingIcon(binding) {
        const icons = {
          user: 'ğŸ‘¤',
          ai: 'ğŸ¤–',
        };
        return icons[binding] || '';
      }

      // è·å–è§’è‰²ç»‘å®šåç§°
      function getCharacterBindingName(binding) {
        const names = {
          user: 'ç”¨æˆ·ä¸“ç”¨',
          ai: 'AIä¸“ç”¨',
        };
        return names[binding] || '';
      }

      // æŒ‰åˆ†ç±»è¿‡æ»¤
      function filterByCategory(category) {
        currentFilter = category;

        // æ›´æ–°æ ‡ç­¾æ ·å¼
        document.querySelectorAll('.category-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        document.querySelector(`[data-category="${category}"]`).classList.add('active');

        renderEntries();
      }

      // æœç´¢è¿‡æ»¤
      function filterEntries() {
        renderEntries();
      }

      // æ˜¾ç¤ºæ·»åŠ æ¨¡æ€æ¡†
      function showAddModal() {
        console.log('æ˜¾ç¤ºæ·»åŠ æ¨¡æ€æ¡†');
        currentEditingId = null;
        document.getElementById('modalTitle').textContent = 'æ·»åŠ ä¸–ç•Œä¹¦æ¡ç›®';
        document.getElementById('entryForm').reset();
        document.getElementById('entryModal').style.display = 'flex';
      }

      // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
      function editEntry(id) {
        console.log('ç¼–è¾‘æ¡ç›®ï¼ŒID:', id);
        currentEditingId = id;
        const entry = worldBookEntries.find(e => e.id === id);
        if (!entry) {
          console.error('æœªæ‰¾åˆ°æ¡ç›®:', id);
          return;
        }

        console.log('æ‰¾åˆ°æ¡ç›®:', entry);
        document.getElementById('modalTitle').textContent = 'ç¼–è¾‘ä¸–ç•Œä¹¦æ¡ç›®';
        document.getElementById('entryTitle').value = entry.title;
        document.getElementById('entryCategory').value = entry.category;
        document.getElementById('entryKeywords').value = entry.keywords.join(', ');
        document.getElementById('entryPriority').value = entry.priority;
        document.getElementById('entryCharacterBinding').value = entry.characterBinding || '';
        document.getElementById('entryContent').value = entry.content;
        document.getElementById('entryModal').style.display = 'flex';
      }

      // åˆ é™¤æ¡ç›®
      function deleteEntry(id) {
        console.log('åˆ é™¤æ¡ç›®ï¼ŒID:', id);
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¡ç›®å—ï¼Ÿ')) {
          console.log('ç”¨æˆ·ç¡®è®¤åˆ é™¤');
          const originalLength = worldBookEntries.length;
          worldBookEntries = worldBookEntries.filter(e => e.id.toString() !== id.toString());
          console.log('åˆ é™¤åæ¡ç›®æ•°é‡:', worldBookEntries.length, 'åŸæ•°é‡:', originalLength);

          if (worldBookEntries.length < originalLength) {
            saveWorldBookData();
            renderEntries();
            console.log('åˆ é™¤æˆåŠŸ');
          } else {
            console.error('åˆ é™¤å¤±è´¥ï¼Œæœªæ‰¾åˆ°æ¡ç›®');
            alert('åˆ é™¤å¤±è´¥ï¼šæœªæ‰¾åˆ°è¦åˆ é™¤çš„æ¡ç›®');
          }
        }
      }

      // éšè—æ¨¡æ€æ¡†
      function hideModal() {
        console.log('éšè—æ¨¡æ€æ¡†');
        document.getElementById('entryModal').style.display = 'none';
        // é‡ç½®è¡¨å•
        document.getElementById('entryForm').reset();
        currentEditingId = null;
      }

      // è¡¨å•æäº¤å¤„ç†å‡½æ•°
      function handleFormSubmit(e) {
        e.preventDefault();
        console.log('è¡¨å•æäº¤å¼€å§‹');

        // æ£€æŸ¥æ‰€æœ‰å¿…éœ€çš„DOMå…ƒç´ 
        const titleInput = document.getElementById('entryTitle');
        const categorySelect = document.getElementById('entryCategory');
        const keywordsInput = document.getElementById('entryKeywords');
        const prioritySelect = document.getElementById('entryPriority');
        const bindingSelect = document.getElementById('entryCharacterBinding');
        const contentTextarea = document.getElementById('entryContent');

        if (!titleInput || !categorySelect || !keywordsInput || !prioritySelect || !bindingSelect || !contentTextarea) {
          console.error('è¡¨å•å…ƒç´ æ£€æŸ¥å¤±è´¥:', {
            titleInput: !!titleInput,
            categorySelect: !!categorySelect,
            keywordsInput: !!keywordsInput,
            prioritySelect: !!prioritySelect,
            bindingSelect: !!bindingSelect,
            contentTextarea: !!contentTextarea,
          });
          alert('è¡¨å•å…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
          return false;
        }

        const title = titleInput.value.trim();
        const category = categorySelect.value;
        const keywords = keywordsInput.value
          .split(',')
          .map(k => k.trim())
          .filter(k => k.length > 0);
        const priority = prioritySelect.value;
        const characterBinding = bindingSelect.value;
        const content = contentTextarea.value.trim();

        console.log('è¡¨å•æ•°æ®:', { title, category, keywords, priority, characterBinding, content });

        if (!title || !content) {
          alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
          return false;
        }

        const entry = {
          id: currentEditingId || Date.now().toString(),
          title,
          category,
          keywords,
          priority,
          characterBinding,
          content,
          createdAt: currentEditingId
            ? worldBookEntries.find(e => e.id === currentEditingId)?.createdAt || new Date().toISOString()
            : new Date().toISOString(),
          updatedAt: new Date().toISOString(),
        };

        console.log('åˆ›å»ºçš„æ¡ç›®:', entry);

        if (currentEditingId) {
          console.log('ç¼–è¾‘æ¨¡å¼ï¼Œå½“å‰ID:', currentEditingId, typeof currentEditingId);
          const index = worldBookEntries.findIndex(e => {
            console.log('æ¯”è¾ƒID:', e.id, typeof e.id, 'ä¸', currentEditingId, typeof currentEditingId);
            return e.id.toString() === currentEditingId.toString();
          });
          console.log('æ‰¾åˆ°ç´¢å¼•:', index);
          if (index !== -1) {
            worldBookEntries[index] = entry;
            console.log('æ›´æ–°æ¡ç›®æˆåŠŸï¼Œç´¢å¼•:', index);
          } else {
            console.error(
              'æœªæ‰¾åˆ°è¦ç¼–è¾‘çš„æ¡ç›®ï¼Œæ‰€æœ‰æ¡ç›®ID:',
              worldBookEntries.map(e => ({ id: e.id, type: typeof e.id })),
            );
            alert('ç¼–è¾‘å¤±è´¥ï¼šæœªæ‰¾åˆ°è¦ç¼–è¾‘çš„æ¡ç›®');
            return false;
          }
        } else {
          worldBookEntries.push(entry);
          console.log('æ·»åŠ æ–°æ¡ç›®ï¼Œæ€»æ•°:', worldBookEntries.length);
        }

        const saveSuccess = saveWorldBookData();
        if (saveSuccess) {
          console.log('ä¿å­˜æˆåŠŸï¼Œå¼€å§‹æ¸²æŸ“æ¡ç›®');
          renderEntries();
          hideModal();
          console.log('æ“ä½œå®Œæˆ');
        }

        return false; // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤
      }

      // æ˜¾ç¤ºå¯¼å…¥å¯¼å‡ºæ¨¡æ€æ¡†
      function showImportExport() {
        document.getElementById('importExportModal').style.display = 'flex';
      }

      // éšè—å¯¼å…¥å¯¼å‡ºæ¨¡æ€æ¡†
      function hideImportExportModal() {
        document.getElementById('importExportModal').style.display = 'none';
      }

      // å¯¼å‡ºä¸–ç•Œä¹¦
      function exportWorldBook() {
        const data = {
          version: '1.0',
          exportDate: new Date().toISOString(),
          entries: worldBookEntries,
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ä¸–ç•Œä¹¦_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }

      // å¯¼å…¥ä¸–ç•Œä¹¦
      function importWorldBook() {
        const file = document.getElementById('importFile').files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const data = JSON.parse(e.target.result);
            if (data.entries && Array.isArray(data.entries)) {
              if (confirm('è¿™å°†è¦†ç›–å½“å‰çš„ä¸–ç•Œä¹¦æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                worldBookEntries = data.entries;
                saveWorldBookData();
                renderEntries();
                hideImportExportModal();
                alert('å¯¼å…¥æˆåŠŸï¼');
              }
            } else {
              alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
            }
          } catch (error) {
            alert('æ–‡ä»¶è§£æå¤±è´¥');
          }
        };
        reader.readAsText(file);
      }

      // æ¸…ç©ºæ‰€æœ‰æ•°æ®
      function clearAllData() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä¸–ç•Œä¹¦æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
          worldBookEntries = [];
          saveWorldBookData();
          renderEntries();
          hideImportExportModal();
        }
      }

      // è¿”å›ä¸Šä¸€é¡µ
      function goBack() {
        window.history.back();
      }

      // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      document.addEventListener('click', function (e) {
        if (e.target.classList.contains('modal')) {
          console.log('ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨ï¼Œå…³é—­æ¨¡æ€æ¡†');
          if (e.target.id === 'entryModal') {
            hideModal();
          } else if (e.target.id === 'importExportModal') {
            hideImportExportModal();
          }
        }
      });

      // ä¸ºèŠå¤©ç³»ç»Ÿæä¾›çš„APIå‡½æ•°
      window.getWorldBookEntriesForCharacter = function (characterType, keywords = []) {
        loadWorldBookData();

        // è·å–å…¨å±€æ¡ç›®å’Œç‰¹å®šè§’è‰²çš„æ¡ç›®
        let relevantEntries = worldBookEntries.filter(
          entry => !entry.characterBinding || entry.characterBinding === characterType,
        );

        // å¦‚æœæä¾›äº†å…³é”®è¯ï¼Œè¿›ä¸€æ­¥è¿‡æ»¤
        if (keywords.length > 0) {
          relevantEntries = relevantEntries.filter(entry => {
            const searchText = (entry.title + ' ' + entry.content + ' ' + entry.keywords.join(' ')).toLowerCase();
            return keywords.some(keyword => searchText.includes(keyword.toLowerCase()));
          });
        }

        // æŒ‰ä¼˜å…ˆçº§æ’åº
        const priorityOrder = { high: 3, medium: 2, low: 1 };
        relevantEntries.sort((a, b) => priorityOrder[b.priority] - priorityOrder[a.priority]);

        return relevantEntries;
      };

      // è·å–æ‰€æœ‰ä¸–ç•Œä¹¦æ¡ç›®ï¼ˆç”¨äºå¯¼å‡ºæˆ–å…¶ä»–ç”¨é€”ï¼‰
      window.getAllWorldBookEntries = function () {
        loadWorldBookData();
        return worldBookEntries;
      };

      // æ›´æ–°çŠ¶æ€æ æ—¶é—´
      function updateTime() {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const timeString = `${hours}:${minutes}`;

        const timeElement = document.getElementById('currentTime');
        if (timeElement) {
          timeElement.textContent = timeString;
        }
      }

      // åˆå§‹åŒ–æ—¶é—´æ›´æ–°
      updateTime();
      setInterval(updateTime, 60000); // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
    </script>
  </body>
</html>
