<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ¶ˆæ¯æ ¼å¼æµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .test-container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .test-section {
        margin-bottom: 30px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      .test-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        margin-bottom: 15px;
      }
      .test-button {
        padding: 10px 20px;
        margin: 5px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .test-button:hover {
        background: #0056b3;
      }
      .result {
        margin-top: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
        font-family: monospace;
        white-space: pre-wrap;
      }
      .status {
        padding: 5px 10px;
        border-radius: 3px;
        margin-left: 10px;
        font-size: 12px;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1>èŠå¤©æ¶ˆæ¯æ ¼å¼æŒä¹…åŒ–æµ‹è¯•</h1>

      <div class="test-section">
        <div class="test-title">1. æµ‹è¯•æ•°æ®å‡†å¤‡</div>
        <button class="test-button" onclick="createTestData()">åˆ›å»ºæµ‹è¯•æ•°æ®</button>
        <button class="test-button" onclick="clearTestData()">æ¸…ç†æµ‹è¯•æ•°æ®</button>
        <div id="data-result" class="result"></div>
      </div>

      <div class="test-section">
        <div class="test-title">2. è¡¨æƒ…åŒ…æ¶ˆæ¯æµ‹è¯•</div>
        <button class="test-button" onclick="testEmojiMessage()">æµ‹è¯•è¡¨æƒ…åŒ…æ¶ˆæ¯</button>
        <div id="emoji-result" class="result"></div>
      </div>

      <div class="test-section">
        <div class="test-title">3. çº¢åŒ…æ¶ˆæ¯æµ‹è¯•</div>
        <button class="test-button" onclick="testRedPacketMessage()">æµ‹è¯•çº¢åŒ…æ¶ˆæ¯</button>
        <div id="redpacket-result" class="result"></div>
      </div>

      <div class="test-section">
        <div class="test-title">4. è½¬è´¦æ¶ˆæ¯æµ‹è¯•</div>
        <button class="test-button" onclick="testTransferMessage()">æµ‹è¯•è½¬è´¦æ¶ˆæ¯</button>
        <div id="transfer-result" class="result"></div>
      </div>

      <div class="test-section">
        <div class="test-title">5. ç»¼åˆæŒä¹…åŒ–æµ‹è¯•</div>
        <button class="test-button" onclick="testPersistence()">æµ‹è¯•æ¶ˆæ¯æŒä¹…åŒ–</button>
        <button class="test-button" onclick="openChatPage()">æ‰“å¼€èŠå¤©é¡µé¢éªŒè¯</button>
        <div id="persistence-result" class="result"></div>
      </div>
    </div>

    <script>
      const TEST_CHAT_ID = 'test_format_chat';

      function createTestData() {
        const testMessages = [
          {
            id: Date.now() + 1,
            sender: 'user',
            text: 'æµ‹è¯•æ™®é€šæ¶ˆæ¯',
            timestamp: new Date().toISOString(),
            senderName: 'ç”¨æˆ·',
          },
          {
            id: Date.now() + 2,
            sender: 'user',
            text: '[è¡¨æƒ…åŒ…:https://via.placeholder.com/100x100/ff6b6b/ffffff?text=ğŸ˜€]',
            timestamp: new Date().toISOString(),
            senderName: 'ç”¨æˆ·',
          },
          {
            id: Date.now() + 3,
            sender: 'ai',
            text: 'ğŸ§§ æ­å–œå‘è´¢|188.88',
            timestamp: new Date().toISOString(),
            senderName: 'AIåŠ©æ‰‹',
          },
          {
            id: Date.now() + 4,
            sender: 'user',
            text: 'ğŸ’¸ å‘ä½ è½¬è´¦ 100.00å…ƒ - æµ‹è¯•è½¬è´¦',
            timestamp: new Date().toISOString(),
            senderName: 'ç”¨æˆ·',
          },
        ];

        localStorage.setItem(`chatHistory_${TEST_CHAT_ID}`, JSON.stringify(testMessages));

        document.getElementById('data-result').innerHTML =
          'âœ… æµ‹è¯•æ•°æ®å·²åˆ›å»º\n' +
          `èŠå¤©ID: ${TEST_CHAT_ID}\n` +
          `æ¶ˆæ¯æ•°é‡: ${testMessages.length}æ¡\n` +
          `æ•°æ®å¤§å°: ${JSON.stringify(testMessages).length}å­—èŠ‚`;
      }

      function clearTestData() {
        localStorage.removeItem(`chatHistory_${TEST_CHAT_ID}`);
        document.getElementById('data-result').innerHTML = 'ğŸ—‘ï¸ æµ‹è¯•æ•°æ®å·²æ¸…ç†';
      }

      function testEmojiMessage() {
        const chatHistory = localStorage.getItem(`chatHistory_${TEST_CHAT_ID}`);
        if (!chatHistory) {
          document.getElementById('emoji-result').innerHTML = 'âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•æ•°æ®';
          return;
        }

        const messages = JSON.parse(chatHistory);
        const emojiMessage = messages.find(msg => msg.text.startsWith('[è¡¨æƒ…åŒ…:'));

        if (emojiMessage) {
          const isValidFormat = /^\[è¡¨æƒ…åŒ…:.+\]$/.test(emojiMessage.text);
          const result = isValidFormat ? 'âœ… è¡¨æƒ…åŒ…æ¶ˆæ¯æ ¼å¼æ­£ç¡®' : 'âŒ è¡¨æƒ…åŒ…æ¶ˆæ¯æ ¼å¼é”™è¯¯';

          document.getElementById('emoji-result').innerHTML =
            `${result}\n` +
            `æ¶ˆæ¯å†…å®¹: ${emojiMessage.text}\n` +
            `æ ¼å¼åŒ¹é…: ${isValidFormat}\n` +
            `æ¶ˆæ¯ID: ${emojiMessage.id}`;
        } else {
          document.getElementById('emoji-result').innerHTML = 'âŒ æœªæ‰¾åˆ°è¡¨æƒ…åŒ…æ¶ˆæ¯';
        }
      }

      function testRedPacketMessage() {
        const chatHistory = localStorage.getItem(`chatHistory_${TEST_CHAT_ID}`);
        if (!chatHistory) {
          document.getElementById('redpacket-result').innerHTML = 'âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•æ•°æ®';
          return;
        }

        const messages = JSON.parse(chatHistory);
        const redPacketMessage = messages.find(msg => msg.text.startsWith('ğŸ§§'));

        if (redPacketMessage) {
          const match = redPacketMessage.text.match(/ğŸ§§\s*(.+)\|(.+)/);
          const isValidFormat = !!match;

          let result = isValidFormat ? 'âœ… çº¢åŒ…æ¶ˆæ¯æ ¼å¼æ­£ç¡®' : 'âŒ çº¢åŒ…æ¶ˆæ¯æ ¼å¼é”™è¯¯';

          document.getElementById('redpacket-result').innerHTML =
            `${result}\n` +
            `æ¶ˆæ¯å†…å®¹: ${redPacketMessage.text}\n` +
            `æ ¼å¼åŒ¹é…: ${isValidFormat}\n` +
            `ç¥ç¦è¯­: ${match ? match[1] : 'N/A'}\n` +
            `é‡‘é¢: ${match ? match[2] : 'N/A'}`;
        } else {
          document.getElementById('redpacket-result').innerHTML = 'âŒ æœªæ‰¾åˆ°çº¢åŒ…æ¶ˆæ¯';
        }
      }

      function testTransferMessage() {
        const chatHistory = localStorage.getItem(`chatHistory_${TEST_CHAT_ID}`);
        if (!chatHistory) {
          document.getElementById('transfer-result').innerHTML = 'âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•æ•°æ®';
          return;
        }

        const messages = JSON.parse(chatHistory);
        const transferMessage = messages.find(msg => msg.text.startsWith('ğŸ’¸'));

        if (transferMessage) {
          const match = transferMessage.text.match(
            /ğŸ’¸\s*(?:å‘ä½ è½¬è´¦|å·²æ¥å—è½¬è´¦|é€€è¿˜è½¬è´¦)\s*(\d+\.?\d*)å…ƒ(?:\s*-\s*(.+))?/,
          );
          const isValidFormat = !!match;

          let result = isValidFormat ? 'âœ… è½¬è´¦æ¶ˆæ¯æ ¼å¼æ­£ç¡®' : 'âŒ è½¬è´¦æ¶ˆæ¯æ ¼å¼é”™è¯¯';

          document.getElementById('transfer-result').innerHTML =
            `${result}\n` +
            `æ¶ˆæ¯å†…å®¹: ${transferMessage.text}\n` +
            `æ ¼å¼åŒ¹é…: ${isValidFormat}\n` +
            `é‡‘é¢: ${match ? match[1] : 'N/A'}\n` +
            `è¯´æ˜: ${match && match[2] ? match[2] : 'N/A'}`;
        } else {
          document.getElementById('transfer-result').innerHTML = 'âŒ æœªæ‰¾åˆ°è½¬è´¦æ¶ˆæ¯';
        }
      }

      function testPersistence() {
        const chatHistory = localStorage.getItem(`chatHistory_${TEST_CHAT_ID}`);
        if (!chatHistory) {
          document.getElementById('persistence-result').innerHTML = 'âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•æ•°æ®';
          return;
        }

        const messages = JSON.parse(chatHistory);
        let results = [];

        // æµ‹è¯•å„ç§æ¶ˆæ¯ç±»å‹çš„æŒä¹…åŒ–
        const emojiCount = messages.filter(msg => msg.text.startsWith('[è¡¨æƒ…åŒ…:')).length;
        const redPacketCount = messages.filter(msg => msg.text.startsWith('ğŸ§§')).length;
        const transferCount = messages.filter(msg => msg.text.startsWith('ğŸ’¸')).length;
        const normalCount = messages.filter(
          msg => !msg.text.startsWith('[è¡¨æƒ…åŒ…:') && !msg.text.startsWith('ğŸ§§') && !msg.text.startsWith('ğŸ’¸'),
        ).length;

        results.push(`âœ… æŒä¹…åŒ–æµ‹è¯•å®Œæˆ`);
        results.push(`æ€»æ¶ˆæ¯æ•°: ${messages.length}`);
        results.push(`æ™®é€šæ¶ˆæ¯: ${normalCount}æ¡`);
        results.push(`è¡¨æƒ…åŒ…æ¶ˆæ¯: ${emojiCount}æ¡`);
        results.push(`çº¢åŒ…æ¶ˆæ¯: ${redPacketCount}æ¡`);
        results.push(`è½¬è´¦æ¶ˆæ¯: ${transferCount}æ¡`);
        results.push(`æ•°æ®å®Œæ•´æ€§: ${messages.every(msg => msg.id && msg.sender && msg.text) ? 'âœ…' : 'âŒ'}`);

        document.getElementById('persistence-result').innerHTML = results.join('\n');
      }

      function openChatPage() {
        // åˆ›å»ºèŠå¤©ä¿¡æ¯
        const chatInfo = {
          id: TEST_CHAT_ID,
          name: 'æ ¼å¼æµ‹è¯•',
          avatar: 'ğŸ§ª',
          type: 'ai',
          lastMessage: 'ç‚¹å‡»éªŒè¯æ¶ˆæ¯æ ¼å¼',
          time: 'åˆšåˆš',
          unread: 0,
        };

        localStorage.setItem('currentChatInfo', JSON.stringify(chatInfo));

        // æ‰“å¼€èŠå¤©é¡µé¢
        window.open(`chat.html?chatId=${TEST_CHAT_ID}&name=æ ¼å¼æµ‹è¯•&avatar=ğŸ§ª&type=ai`, '_blank');
      }
    </script>
  </body>
</html>
